<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø®Ø²Ù†Ø© Ø±Ø¨Ø§Ù†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* Ø¥Ø®ÙØ§Ø¡ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ…Ø±ÙŠØ± */
        ::-webkit-scrollbar { display: none; }
        html { -ms-overflow-style: none; scrollbar-width: none; }

        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap');
        
        body {
            font-family: 'Cairo', sans-serif;
            background: radial-gradient(circle at top center, #1e3a8a 0%, #0f172a 100%);
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            pointer-events: none;
            z-index: -1;
        }
        
        /* ØªØ­Ø¯ÙŠØ« ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø®Ø²Ù†Ø© Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØµÙˆØ± */
        .treasure-chest {
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            transform-style: preserve-3d;
            position: relative;
            /* Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ù…ØªØ¯Ø±Ø¬Ø© ÙˆØ§Ù„Ø­Ø¯ÙˆØ¯ */
            background: transparent; 
            border: none;
            box-shadow: none;
            padding: 0;
            overflow: hidden; /* Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… Ø®Ø±ÙˆØ¬ Ø§Ù„ØµÙˆØ±Ø© */
            height: 100%; /* ÙŠØ¬Ø¨ ØªØ­Ø¯ÙŠØ¯ Ø§Ø±ØªÙØ§Ø¹ Ù„Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„ØµÙˆØ±Ø© */
            aspect-ratio: 1 / 1; /* Ø¬Ø¹Ù„Ù‡Ø§ Ù…Ø±Ø¨Ø¹ */
        }
        
        /* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø²Ø®Ø±ÙÙŠØ© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© ØºÙŠØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø© */
        .treasure-chest::before,
        .treasure-chest::after {
            content: none !important;
        }
        
        .treasure-chest:hover {
            transform: translateY(-8px) scale(1.08) rotateX(5deg);
            box-shadow: 0 15px 30px rgba(0,0,0,0.4), 0 0 20px rgba(255,215,0,0.3);
        }

        .treasure-chest-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: opacity 0.4s;
        }
        
        .treasure-chest.opened .treasure-chest-image {
            /* Ù„Ø¬Ø¹Ù„ Ø§Ù„ØµÙˆØ±Ø© ØªØ¨Ø¯Ùˆ "Ù…ÙØªÙˆØ­Ø©" Ø£Ùˆ "ØºÙŠØ± Ù†Ø´Ø·Ø©"ØŒ Ø³Ù†Ù‚Ù„Ù„ Ø§Ù„ØªØ¹ØªÙŠÙ… */
            opacity: 0.5;
            filter: grayscale(80%);
        }

        /* Ù†Ø­ØªØ§Ø¬ Ù„ØªØ¹Ø¯ÙŠÙ„ Ø£Ø¨Ø¹Ø§Ø¯ Ø´Ø¨ÙƒØ© Ø§Ù„Ø®Ø²Ø§Ø¦Ù† Ù„Ø¶Ù…Ø§Ù† Ø¸Ù‡ÙˆØ± Ø§Ù„ØµÙˆØ± Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ */
        #treasureGrid {
            /* ØªØ¹Ø¯ÙŠÙ„: ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù€ 10 Ø£Ø¹Ù…Ø¯Ø© */
            grid-template-columns: repeat(10, 1fr); 
            gap: 0.5rem;
        }

        /* Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªÙˆØ§ÙÙ‚ Ø¹Ù„Ù‰ Ø§Ù„Ø¬ÙˆØ§Ù„Ø§ØªØŒ Ø³Ù†Ø¬Ø¹Ù„Ù‡Ø§ 5 Ø£Ø¹Ù…Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© */
        @media (max-width: 768px) {
            #treasureGrid {
                grid-template-columns: repeat(5, 1fr); 
            }
        }
        
        /* Ø¨Ù‚ÙŠØ© Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª (wave-animation, ship-container, etc.) ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ */
        .wave-animation {
            animation: wave 3s ease-in-out infinite;
        }
        
        @keyframes wave {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-10px) rotate(2deg); }
        }
        
        .ship-container {
            position: relative;
            background: linear-gradient(135deg, rgba(30, 58, 138, 0.9) 0%, rgba(15, 23, 42, 0.95) 100%);
            border: 1px solid rgba(56, 189, 248, 0.3);
            box-shadow: 
                0 20px 40px rgba(0,0,0,0.4),
                inset 0 1px 0 rgba(255,255,255,0.1);
            backdrop-filter: blur(12px);
        }
        
        /* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù‚Ø§Ø±Ø¨ Ø§Ù„Ù‚Ø¯ÙŠÙ… */
        .ship-container::before {
            content: none; 
        }
        
        .points-animation {
            animation: pointsFloat 2.5s ease-out forwards;
        }
        
        @keyframes pointsFloat {
            0% { 
                transform: translateY(0) scale(1) rotate(0deg); 
                opacity: 1; 
            }
            50% { 
                transform: translateY(-30px) scale(1.1) rotate(5deg); 
                opacity: 0.8; 
            }
            100% { 
                transform: translateY(-60px) scale(1.3) rotate(10deg); 
                opacity: 0; 
            }
        }
        
        .slide-in {
            animation: slideIn 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        @keyframes slideIn {
            from { 
                transform: translateX(100%) scale(0.8); 
                opacity: 0; 
            }
            to { 
                transform: translateX(0) scale(1); 
                opacity: 1; 
            }
        }
        
        .pulse-glow {
            animation: pulseGlow 2.5s infinite;
        }
        
        @keyframes pulseGlow {
            0%, 100% { 
                box-shadow: 
                    0 0 20px rgba(6,182,212,0.5),
                    0 0 40px rgba(14,165,233,0.3); 
            }
            50% { 
                box-shadow: 
                    0 0 30px rgba(6,182,212,0.8),
                    0 0 60px rgba(14,165,233,0.5); 
            }
        }
        
        .ocean-waves {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 300px;
            background: radial-gradient(ellipse at bottom center, rgba(6,182,212,0.15) 0%, transparent 70%);
            z-index: -1;
            animation: none;
            pointer-events: none;
        }
        
        @keyframes oceanWave {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }

        /* ØªÙ†Ø³ÙŠÙ‚ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© */
        .settings-container, .modal-container {
            position: fixed;
            top: 0;
            right: 0;
            left: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .settings-card, .modal-card {
            max-width: 400px;
            width: 90%;
            padding: 24px;
            border-radius: 16px;
            background: linear-gradient(135deg, #1e40af 0%, #0ea5e9 100%);
            border: 2px solid #0284c7;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            transform: scale(0.8);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .settings-container.active .settings-card, .modal-container.active .modal-card {
            transform: scale(1);
            opacity: 1;
        }

        /* ØªÙ†Ø³ÙŠÙ‚ Ø²Ø± Ø§Ù„Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙÙŠ Ø´Ø§Ø´Ø© Ø§Ù„Ø®Ø²Ù†Ø© */
        .close-button {
            position: absolute;
            top: 1rem;
            left: 1rem;
            background: rgba(255, 0, 0, 0.6);
            color: white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s;
            z-index: 10;
        }
        .close-button:hover {
            background: rgba(255, 0, 0, 0.8);
        }

        /* --- New UI Styles --- */
        
        /* Mission Card Style */
        .mission-card {
            background: rgba(15, 23, 42, 0.4);
            border: 2px solid rgba(251, 191, 36, 0.5);
            border-radius: 12px;
            padding: 20px;
            position: relative;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        .mission-card::before {
            content: '';
            position: absolute;
            top: -5px; left: -5px; right: -5px; bottom: -5px;
            border: 1px dashed #fbbf24;
            border-radius: 16px;
            pointer-events: none;
            opacity: 0.5;
        }

        /* Team Selection Grid */
        .team-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 12px;
            margin-bottom: 16px;
        }
        .team-card-select {
            background: rgba(30, 41, 59, 0.8);
            border: 2px solid #475569;
            border-radius: 12px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            overflow: hidden;
        }
        .team-card-select:hover {
            transform: translateY(-3px);
            border-color: #94a3b8;
        }
        .team-card-select.selected {
            border-color: #fbbf24;
            background: rgba(251, 191, 36, 0.1);
            box-shadow: 0 0 15px rgba(251, 191, 36, 0.3);
        }
        .team-card-select.selected::after {
            content: 'âœ“';
            position: absolute;
            top: 5px;
            right: 5px;
            background: #fbbf24;
            color: #000;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }
        .team-card-select img {
            width: 48px;
            height: 48px;
            object-fit: contain;
            margin-bottom: 8px;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3));
        }
        .team-card-select span {
            font-size: 10px;
            font-weight: bold;
            color: #e2e8f0;
            text-align: center;
        }

        /* Smart Stepper */
        .stepper-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            background: rgba(15, 23, 42, 0.6);
            padding: 8px;
            border-radius: 16px;
            border: 1px solid #334155;
            max-width: 280px;
            margin: 0 auto;
        }
        .stepper-btn {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            border: none;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.1s, filter 0.2s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        .stepper-btn:active {
            transform: scale(0.95);
        }
        .stepper-btn.minus {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        .stepper-btn.plus {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        .stepper-display {
            flex: 1;
            text-align: center;
            font-size: 28px;
            font-weight: 800;
            color: white;
            background: transparent;
            border: none;
            font-family: 'Courier New', monospace;
            width: 80px;
        }
        
        /* 3D Action Buttons */
        .btn-3d {
            transition: all 0.1s;
            position: relative;
            top: 0;
            box-shadow: 0 5px 0 rgba(0,0,0,0.2);
        }
        .btn-3d:active {
            top: 3px;
            box-shadow: 0 2px 0 rgba(0,0,0,0.2);
        }
    </style>
</head>
<body class="min-h-screen text-white relative">
    <div class="ocean-waves"></div>
    <!-- Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
    <div id="mainScreen" class="container mx-auto px-4 py-6">
        <!-- Ø´Ø±ÙŠØ· ÙƒØ§Ø¨ØªÙ† Ø§Ù„Ø³ÙÙŠÙ†Ø© (HUD) -->
        <div class="ship-container backdrop-blur-md rounded-2xl p-3 mb-8 border border-cyan-300/30 flex flex-col md:flex-row items-center justify-between gap-4 sticky top-4 z-40 shadow-2xl">
            
            <!-- Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø£ÙŠÙ…Ù†: Ø§Ù„Ø¹Ù†ÙˆØ§Ù† (Ø£ØµØ¨Ø­ Ø§Ù„Ø£ÙŠØ³Ø±) -->
            <div class="flex items-center gap-3 order-1 md:order-3">
                 <img src="images/rs4LLx24-image.png" alt="Boat Icon" class="w-12 h-12 transform -scale-x-100 drop-shadow-lg filter brightness-110">
                 <div class="hidden md:block text-right">
                     <h1 class="text-2xl font-bold text-amber-300" style="text-shadow: 0 2px 4px rgba(0,0,0,0.5);">Ø®Ø²Ù†Ø© Ø±Ø¨Ø§Ù†</h1>
                     <p class="text-xs text-cyan-300 opacity-80">Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ø°Ù‡Ø¨ÙŠ âš“</p>
                 </div>
            </div>

            <!-- Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø£ÙˆØ³Ø·: Ù„ÙˆØ­Ø© Ø§Ù„Ù†Ù‚Ø§Ø· (Ø´Ø±ÙŠØ· Ø£ÙÙ‚ÙŠ) -->
            <div id="scoreboard" class="flex-1 w-full md:w-auto order-2 md:order-2 flex flex-wrap md:flex-nowrap justify-center items-center gap-2 md:gap-4 overflow-x-auto pb-1 md:pb-0 scrollbar-hide">
                <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡Ø§ Ø¨ÙˆØ§Ø³Ø·Ø© JavaScript -->
            </div>

            <!-- Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø£ÙŠØ³Ø±: Ø§Ù„Ø£Ø¯ÙˆØ§Øª (Ø£ØµØ¨Ø­ Ø§Ù„Ø£ÙŠÙ…Ù†) -->
            <div class="flex items-center gap-2 order-3 md:order-1">
                <!-- Ø²Ø± ØºØ±ÙØ© Ø§Ù„ØªØ­ÙƒÙ… (Ø¬Ø¯ÙŠØ¯) -->
                <button onclick="toggleControlPanel(true)" class="bg-slate-700/80 hover:bg-slate-600 p-2.5 rounded-xl border border-slate-500 transition-all hover:scale-105 hover:shadow-lg group" title="ØºØ±ÙØ© Ø§Ù„ØªØ­ÙƒÙ…">
                    <span class="text-xl group-hover:rotate-90 transition-transform duration-300">ğŸ›ï¸</span>
                </button>
                <!-- Ø²Ø± Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
                <button onclick="toggleSettingsModal(true)" class="bg-indigo-600/80 hover:bg-indigo-500 p-2.5 rounded-xl border border-indigo-400 transition-all hover:scale-105 hover:shadow-lg group" title="Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª">
                    <span class="text-xl group-hover:rotate-180 transition-transform duration-500">âš™ï¸</span>
                </button>
            </div>
        </div>
        
        <!-- Ø´Ø¨ÙƒØ© Ø§Ù„Ø®Ø²Ø§Ø¦Ù† -->
        <div class="grid grid-cols-5 md:grid-cols-10 gap-3" id="treasureGrid">
            <!-- Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø®Ø²Ø§Ø¦Ù† Ø¨ÙˆØ§Ø³Ø·Ø© JavaScript -->
        </div>

        <!-- Ø§Ù„Ø­Ù‚ÙˆÙ‚ -->
        <footer class="mt-6 mb-4 text-center relative z-10">
            <div class="inline-block bg-slate-900/40 backdrop-blur-sm border border-slate-700/50 rounded-full px-6 py-2 shadow-lg">
                <p class="text-slate-400 text-sm font-medium flex items-center justify-center gap-2">
                    <span>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© Â©</span>
                    <span class="w-1 h-1 bg-slate-500 rounded-full"></span>
                    <span class="text-amber-400 font-bold">Ù…Ù†ØµØ© Ø¹Ø¨Ù‚Ø± 2026</span>
                </p>
            </div>
        </footer>
    </div>
    
    <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
    <div id="settingsModal" class="modal-container hidden">
        <div class="modal-card bg-gradient-to-b from-slate-800 to-slate-900 border-2 border-cyan-500/30 max-w-lg w-full transform transition-all shadow-[0_0_50px_rgba(6,182,212,0.15)] rounded-2xl p-6 relative overflow-hidden">
            <!-- Ø®Ù„ÙÙŠØ© Ø²Ø®Ø±ÙÙŠØ© -->
            <div class="absolute top-0 right-0 w-64 h-64 bg-cyan-500/5 rounded-full blur-3xl -mr-32 -mt-32 pointer-events-none"></div>
            <div class="absolute bottom-0 left-0 w-64 h-64 bg-blue-500/5 rounded-full blur-3xl -ml-32 -mb-32 pointer-events-none"></div>

            <div class="relative z-10">
                <div class="text-center mb-8">
                    <h2 class="text-3xl font-black text-white drop-shadow-md flex items-center justify-center gap-3 tracking-wide">
                        <span class="text-4xl filter drop-shadow-lg">âš™ï¸</span>
                        Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø©
                    </h2>
                    <div class="h-1 w-24 bg-gradient-to-r from-transparent via-cyan-500 to-transparent mx-auto mt-3 rounded-full opacity-70"></div>
                </div>

                <div class="grid grid-cols-1 gap-5">
                    
                    <!-- Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„ØªØ­Ø±ÙŠØ± ÙˆØ§Ù„Ø¥Ø¯Ø§Ø±Ø© (Ø£Ø²Ø±Ø§Ø± ÙƒØ¨ÙŠØ±Ø© Ù…Ù„ÙˆÙ†Ø©) -->
                    <div class="grid grid-cols-2 gap-4">
                        <button onclick="openTeamConfigModal(); toggleSettingsModal(false);" class="group relative overflow-hidden bg-gradient-to-br from-blue-600 to-blue-700 hover:from-blue-500 hover:to-blue-600 border-t border-white/10 shadow-lg rounded-2xl p-5 transition-all duration-300 transform hover:-translate-y-1">
                            <div class="absolute right-0 top-0 w-24 h-24 bg-white/10 rounded-full blur-2xl -mr-10 -mt-10 pointer-events-none"></div>
                            <span class="text-4xl block mb-3 filter drop-shadow-md">ğŸš¢</span>
                            <span class="font-extrabold text-white text-xl block tracking-wide drop-shadow-sm">Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙØ±Ù‚</span>
                            <span class="text-sm text-blue-50 block mt-1 font-semibold opacity-90">Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ â€¢ Ø§Ù„Ø¹Ø¯Ø¯ â€¢ Ø§Ù„Ù†Ù‚Ø§Ø·</span>
                        </button>

                        <button onclick="openTreasureEditor(); toggleSettingsModal(false);" class="group relative overflow-hidden bg-gradient-to-br from-purple-600 to-purple-700 hover:from-purple-500 hover:to-purple-600 border-t border-white/10 shadow-lg rounded-2xl p-5 transition-all duration-300 transform hover:-translate-y-1">
                            <div class="absolute right-0 top-0 w-24 h-24 bg-white/10 rounded-full blur-2xl -mr-10 -mt-10 pointer-events-none"></div>
                            <span class="text-4xl block mb-3 filter drop-shadow-md">âœï¸</span>
                            <span class="font-extrabold text-white text-xl block tracking-wide drop-shadow-sm">Ù…Ø­Ø±Ø± Ø§Ù„Ø®Ø²Ø§Ø¦Ù†</span>
                            <span class="text-sm text-purple-50 block mt-1 font-semibold opacity-90">Ø§Ù„Ù…Ø­ØªÙˆÙ‰ â€¢ Ø§Ù„Ø¬ÙˆØ§Ø¦Ø² â€¢ Ø§Ù„ØµÙˆØ±</span>
                        </button>
                    </div>

                    <!-- ÙØ§ØµÙ„ -->
                    <div class="relative py-2">
                        <div class="absolute inset-0 flex items-center">
                            <div class="w-full border-t border-slate-700"></div>
                        </div>
                        <div class="relative flex justify-center text-sm">
                            <span class="px-3 py-1 rounded-full bg-slate-800 text-slate-300 font-bold border border-slate-700">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</span>
                        </div>
                    </div>

                    <!-- Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª (Ù‚Ø§Ø¦Ù…Ø© Ø£Ù†ÙŠÙ‚Ø©) -->
                    <div class="space-y-3">
                         <button onclick="reopenAllBoxes(); toggleSettingsModal(false);" class="w-full flex items-center justify-between bg-slate-800/80 hover:bg-slate-700 border border-slate-700 hover:border-amber-500/50 px-5 py-4 rounded-xl group transition-all duration-200 shadow-md">
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 rounded-xl bg-amber-500/10 flex items-center justify-center group-hover:bg-amber-500 group-hover:scale-110 transition-all duration-300 border border-amber-500/20 group-hover:border-amber-500">
                                    <span class="text-2xl">ğŸ—ï¸</span>
                                </div>
                                <div class="text-right">
                                    <span class="block text-white font-extrabold text-lg group-hover:text-amber-300 transition-colors">Ø¥Ø¹Ø§Ø¯Ø© ÙØªØ­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø®Ø²Ø§Ø¦Ù†</span>
                                    <span class="block text-sm text-slate-400 group-hover:text-amber-100/80 transition-colors font-medium">Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„ØµÙ†Ø§Ø¯ÙŠÙ‚ Ø§Ù„Ù…ØºÙ„Ù‚Ø© ÙÙ‚Ø·</span>
                                </div>
                            </div>
                            <span class="text-slate-500 group-hover:text-amber-500 text-xl font-bold">â†º</span>
                        </button>

                        <button onclick="resetPoints(); toggleSettingsModal(false);" class="w-full flex items-center justify-between bg-slate-800/80 hover:bg-slate-700 border border-slate-700 hover:border-red-500/50 px-5 py-4 rounded-xl group transition-all duration-200 shadow-md">
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 rounded-xl bg-red-500/10 flex items-center justify-center group-hover:bg-red-500 group-hover:scale-110 transition-all duration-300 border border-red-500/20 group-hover:border-red-500">
                                    <span class="text-2xl">ğŸŒŠ</span>
                                </div>
                                <div class="text-right">
                                    <span class="block text-white font-extrabold text-lg group-hover:text-red-300 transition-colors">ØªØµÙÙŠØ± Ø§Ù„Ù†Ù‚Ø§Ø·</span>
                                    <span class="block text-sm text-slate-400 group-hover:text-red-100/80 transition-colors font-medium">Ø¥Ø¹Ø§Ø¯Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ±Ù‚ Ø¥Ù„Ù‰ 50 Ù†Ù‚Ø·Ø©</span>
                                </div>
                            </div>
                            <span class="text-slate-500 group-hover:text-red-500 text-xl font-bold">â†º</span>
                        </button>

                         <button onclick="resetBoxes(); toggleSettingsModal(false);" class="w-full flex items-center justify-between bg-slate-800/80 hover:bg-slate-700 border border-slate-700 hover:border-orange-500/50 px-5 py-4 rounded-xl group transition-all duration-200 shadow-md">
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 rounded-xl bg-orange-500/10 flex items-center justify-center group-hover:bg-orange-500 group-hover:scale-110 transition-all duration-300 border border-orange-500/20 group-hover:border-orange-500">
                                    <span class="text-2xl">â˜¢ï¸</span>
                                </div>
                                <div class="text-right">
                                    <span class="block text-white font-extrabold text-lg group-hover:text-orange-300 transition-colors">Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„Ù…ØµÙ†Ø¹</span>
                                    <span class="block text-sm text-slate-400 group-hover:text-orange-100/80 transition-colors font-medium">Ø­Ø°Ù ÙƒÙ„ Ø´ÙŠØ¡ ÙˆØ§Ù„Ø¨Ø¯Ø¡ Ù…Ù† Ø§Ù„ØµÙØ±</span>
                                </div>
                            </div>
                            <span class="text-slate-500 group-hover:text-orange-500 text-xl font-bold">âš </span>
                        </button>
                    </div>
                </div>

                <div class="mt-8 pt-4 border-t border-slate-700/50 flex justify-center">
                    <button onclick="toggleSettingsModal(false)" class="bg-slate-700 hover:bg-slate-600 text-white px-12 py-3 rounded-full font-bold shadow-lg hover:shadow-xl transition-all transform hover:-translate-y-0.5 text-lg border border-slate-600 hover:border-slate-500">
                        Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Ø´Ø§Ø´Ø© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙØ±Ù‚ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© -->
    <div id="teamConfigModal" class="modal-container hidden">
        <div class="modal-card">
            <h2 class="text-2xl font-bold text-amber-300 mb-6 text-center">ğŸš¢ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙØ±Ù‚ âœï¸</h2>
            
            <div class="space-y-4">
                <!-- Ø§Ø®ØªÙŠØ§Ø± Ø¹Ø¯Ø¯ Ø§Ù„ÙØ±Ù‚ -->
                <div class="p-3 bg-cyan-900/50 rounded-lg border border-cyan-400/50">
                    <label for="configNumTeamsSelect" class="block text-cyan-200 mb-2">ØªØ­Ø¯ÙŠØ¯ Ø¹Ø¯Ø¯ Ø§Ù„ÙØ±Ù‚ Ø§Ù„Ù†Ø´Ø·Ø©:</label>
                    <select id="configNumTeamsSelect" onchange="previewNumTeams(this.value)" class="w-full bg-cyan-700/80 text-white px-4 py-2 rounded-lg font-semibold border border-cyan-500">
                        <option value="4">4 ÙØ±Ù‚</option>
                        <option value="3">3 ÙØ±Ù‚</option>
                        <option value="2">2 ÙØ±ÙŠÙ‚ÙŠÙ†</option>
                    </select>
                </div>
                
                <h3 class="text-xl font-bold text-cyan-200 mb-3 text-center pt-2">ØªØ¹Ø¯ÙŠÙ„ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„ÙØ±Ù‚:</h3>
                
                <!-- Ø­Ù‚ÙˆÙ„ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ -->
                <div id="teamNameInputs" class="space-y-3">
                    <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡ Ø¨ÙˆØ§Ø³Ø·Ø© JavaScript -->
                </div>

                <!-- Ø²Ø± Ø§Ù„Ø­ÙØ¸ ÙˆØ§Ù„Ø¥Ù„ØºØ§Ø¡ -->
                <div class="flex gap-4 pt-4">
                    <button onclick="saveTeamConfig()" class="flex-1 bg-emerald-600 hover:bg-emerald-700 px-4 py-3 rounded-xl font-semibold transition-colors border border-emerald-400">
                        ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª
                    </button>
                    <button onclick="toggleTeamConfigModal(false)" class="flex-1 bg-red-600 hover:bg-red-700 px-4 py-3 rounded-xl font-semibold transition-colors border border-red-400">
                        âŒ Ø¥Ù„ØºØ§Ø¡
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø®Ø²Ù†Ø© -->
    <div id="treasureScreen" class="hidden fixed inset-0 z-50">
        <div class="ocean-waves"></div>
        <div class="container mx-auto px-4 py-8 h-full flex items-center justify-center">
            <div class="ship-container backdrop-blur-md rounded-3xl p-8 max-w-2xl w-full border border-cyan-300/30 slide-in relative overflow-y-auto max-h-[90vh] custom-scrollbar">
                
                <!-- Ø²Ø± Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ (X) -->
                <div onclick="cancelAction()" class="close-button" title="Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡">
                    &times;
                </div>

                <div class="text-center">
                    <div id="treasureIcon" class="text-8xl mb-4 filter drop-shadow-xl animate-bounce-slow">ğŸ´â€â˜ ï¸</div>
                    
                    <!-- Ø¹Ø±Ø¶ Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø°ÙŠ ÙØªØ­ Ø§Ù„Ø®Ø²Ù†Ø© -->
                    <div id="openerTeamDisplay" class="flex items-center justify-center gap-3 mb-4 bg-slate-900/60 w-fit mx-auto px-5 py-2 rounded-full border border-slate-600/50 shadow-lg backdrop-blur-sm transform hover:scale-105 transition-all duration-300 hidden">
                         <span class="text-slate-400 text-xs font-bold uppercase tracking-wider">Ø¨ÙˆØ§Ø³Ø·Ø©</span>
                         <div class="h-4 w-[1px] bg-slate-600"></div>
                         <img id="openerTeamImage" src="" class="w-6 h-6 rounded-full object-cover ring-2 ring-amber-500/50 shadow-sm">
                         <span id="openerTeamName" class="text-amber-100 font-bold text-sm"></span>
                    </div>

                    <h2 id="treasureTitle" class="text-3xl font-bold mb-4 text-amber-300 drop-shadow-md">Ø®Ø²Ù†Ø© Ø±Ù‚Ù… 1</h2>
                    
                    <div class="mission-card mb-6">
                        <div id="treasureContent" class="text-xl leading-relaxed text-slate-200 font-medium">
                            <!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø®Ø²Ù†Ø© Ø³ÙŠØ¸Ù‡Ø± Ù‡Ù†Ø§ -->
                        </div>
                    </div>

                    <div id="treasurePoints" class="text-3xl font-bold mb-6 p-4 rounded-xl border-2 border-dashed transition-all duration-300 transform hover:scale-105">
                        <!-- Ù†Ù‚Ø§Ø· Ø§Ù„Ø®Ø²Ù†Ø© Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ -->
                    </div>

                    <!-- Ø§Ø®ØªÙŠØ§Ø± ÙØ±ÙŠÙ‚ Ø§Ù„Ø®ØµÙ… (Ø´Ø¨ÙƒØ©) -->
                    <div id="teamSelector" class="hidden mb-6">
                        <p class="text-xl mb-4 text-amber-300 font-bold flex items-center justify-center gap-2">
                            <span>â˜ ï¸</span> Ø§Ø®ØªØ± Ø§Ù„Ø·Ø§Ù‚Ù… Ø§Ù„Ø¶Ø­ÙŠØ©:
                        </p>
                        <!-- Ø§Ù„Ø´Ø¨ÙƒØ© Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ© -->
                        <div id="penaltyTeamGrid" class="team-grid"></div>
                        <!-- Ø¹Ù†ØµØ± Ù…Ø®ÙÙŠ Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù‚Ø¯ÙŠÙ… -->
                        <select id="penaltyTeamSelect" class="hidden"></select>
                    </div>

                    <!-- Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø®ØµØµØ© (Ø¹Ø¯Ø§Ø¯ Ø°ÙƒÙŠ) -->
                    <div id="pointsInput" class="hidden mb-6">
                        <p class="text-xl mb-4 text-amber-300 font-bold">Ø­Ø¯Ø¯ Ù‚ÙŠÙ…Ø© Ø§Ù„Ù†Ù‚Ø§Ø·:</p>
                        <div class="stepper-container">
                            <button class="stepper-btn minus" onclick="adjustValue('customPointsInput', -1)">-</button>
                            <input type="number" id="customPointsInput" class="stepper-display" value="0" readonly>
                            <button class="stepper-btn plus" onclick="adjustValue('customPointsInput', 1)">+</button>
                        </div>
                    </div>

                    <!-- Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ø®ÙŠØ±ÙŠØ© (Ø´Ø¨ÙƒØ§Øª) -->
                    <div id="charitySelector" class="hidden mb-6 space-y-6">
                        <div class="bg-slate-800/50 p-4 rounded-xl border border-slate-600">
                            <p class="text-lg mb-3 text-cyan-300 font-bold flex items-center gap-2">
                                <span>ğŸ“¤</span> Ø§Ù„Ø·Ø§Ù‚Ù… Ø§Ù„Ù…Ø§Ù†Ø­:
                            </p>
                            <div id="donorTeamGrid" class="team-grid"></div>
                            <select id="donorTeamSelect" class="hidden"></select>
                        </div>

                        <div class="bg-slate-800/50 p-4 rounded-xl border border-slate-600">
                            <p class="text-lg mb-3 text-emerald-300 font-bold flex items-center gap-2">
                                <span>ğŸ“¥</span> Ø§Ù„Ø·Ø§Ù‚Ù… Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„:
                            </p>
                            <div id="receiverTeamGrid" class="team-grid"></div>
                            <select id="receiverTeamSelect" class="hidden"></select>
                        </div>

                        <div>
                            <p class="text-lg mb-3 text-amber-300 font-bold">Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ù†Ù‚ÙˆÙ„Ø©:</p>
                            <div class="stepper-container">
                                <button class="stepper-btn minus" onclick="adjustValue('charityPointsInput', -1)">-</button>
                                <input type="number" id="charityPointsInput" class="stepper-display" value="0" readonly>
                                <button class="stepper-btn plus" onclick="adjustValue('charityPointsInput', 1)">+</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù‡Ø¬ÙˆÙ… Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (Ù…Ø­Ø³Ù†Ø©) -->
                    <div id="attackInterface" class="hidden mb-6 p-1 bg-gradient-to-br from-red-900/40 to-slate-900/80 rounded-2xl border border-red-500/30 shadow-[0_0_20px_rgba(239,68,68,0.2)]">
                        <div class="p-5 rounded-xl bg-slate-900/60 backdrop-blur-sm">
                            <div class="mb-6">
                                <p class="text-xl mb-3 text-red-300 font-black flex items-center justify-center gap-2 uppercase tracking-wider">
                                    <span>ğŸ¯</span> ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù‡Ø¯Ù
                                </p>
                                <div id="attackTargetGrid" class="team-grid"></div>
                                <select id="attackTargetSelect" class="hidden"></select>
                            </div>
                            
                            <div class="border-t border-red-500/20 pt-4">
                                <div class="flex justify-between items-center mb-3">
                                    <p class="text-xl text-red-300 font-bold flex items-center gap-2">
                                        <span>ğŸ’¥</span> Ù‚ÙˆØ© Ø§Ù„Ø¶Ø±Ø¨Ø©:
                                    </p>
                                    <span class="text-xs font-mono text-red-200 bg-red-950/80 px-3 py-1 rounded-full border border-red-500/50 shadow-inner">
                                        MAX: <span id="attackMaxLabel" class="font-bold text-red-400">10</span>
                                    </span>
                                </div>
                                
                                <div class="stepper-container w-full max-w-full">
                                    <button class="stepper-btn minus" onclick="adjustValue('attackDamageInput', -1)">-</button>
                                    <input type="number" id="attackDamageInput" class="stepper-display" value="1" readonly>
                                    <button class="stepper-btn plus" onclick="adjustValue('attackDamageInput', 1)">+</button>
                                </div>
                                
                                <p id="attackCostLabel" class="text-sm text-yellow-400 mt-3 text-center font-bold bg-yellow-900/20 py-2 rounded-lg border border-yellow-500/20 flex items-center justify-center gap-2">
                                    <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦ØªÙ‡ -->
                                </p>
                            </div>
                        </div>
                    </div>

                    <div id="pointsEffect" class="text-4xl font-bold mb-6 hidden">
                        <!-- ØªØ£Ø«ÙŠØ± Ø§Ù„Ù†Ù‚Ø§Ø· Ø³ÙŠØ¸Ù‡Ø± Ù‡Ù†Ø§ -->
                    </div>

                    <div id="actionButtons" class="flex flex-col sm:flex-row gap-4 justify-center mb-2">
                        <!-- Ø²Ø± Ø§Ù„ØªÙ†ÙÙŠØ° -->
                        <button onclick="executeAction()" class="btn-3d bg-gradient-to-b from-emerald-500 to-emerald-700 hover:from-emerald-400 hover:to-emerald-600 text-white px-8 py-4 rounded-xl font-bold text-xl border-b-4 border-emerald-900 active:border-b-0">
                            âš“ ØªÙ†ÙÙŠØ° Ø§Ù„Ø£Ù…Ø±
                        </button>
                        <!-- Ø²Ø± Ø§Ù„ØªØ¬Ø§ÙˆØ² -->
                        <button onclick="skipAction()" class="btn-3d bg-gradient-to-b from-slate-600 to-slate-700 hover:from-slate-500 hover:to-slate-600 text-slate-200 px-6 py-4 rounded-xl font-bold text-lg border-b-4 border-slate-900 active:border-b-0">
                            â­ï¸ ØªØ¬Ø§ÙˆØ²
                        </button>
                    </div>

                    <button id="backButton" onclick="closeTreasure(true)" class="bg-cyan-600 hover:bg-cyan-700 px-8 py-3 rounded-xl font-semibold text-xl transition-colors pulse-glow hidden border border-cyan-400 mt-4">
                        Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø®Ø²Ø§Ø¦Ù† ğŸš¢
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Ø´Ø§Ø´Ø© Ù…Ø­Ø±Ø± Ø§Ù„Ø®Ø²Ø§Ø¦Ù† Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© -->
    <div id="treasureEditor" class="hidden fixed inset-0 z-50 bg-slate-900 transition-all duration-300">
        <!-- Ø®Ù„ÙÙŠØ© Ø²Ø®Ø±ÙÙŠØ© Ø«Ø§Ø¨ØªØ© ØªØºØ·ÙŠ Ø§Ù„Ø´Ø§Ø´Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ -->
        <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-5 pointer-events-none"></div>
        <div class="absolute inset-0 bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 opacity-90 pointer-events-none"></div>
        
        <div class="container mx-auto px-4 py-4 h-full flex flex-col relative z-10">
            <!-- Ø§Ù„Ù‡ÙŠØ¯Ø± -->
            <div class="flex justify-between items-center mb-6 bg-slate-800/50 p-4 rounded-2xl border border-slate-600">
                <div class="flex items-center gap-4">
                    <div class="bg-amber-500/20 p-3 rounded-xl border border-amber-500/50">
                        <span class="text-3xl">âœï¸</span>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold text-amber-300">Ù…Ø­Ø±Ø± Ø§Ù„Ø®Ø²Ø§Ø¦Ù† Ø§Ù„Ù…ØªÙ‚Ø¯Ù…</h2>
                        <p class="text-slate-300 text-sm">Ø®ØµØµ ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ù„Ø¹Ø¨ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„</p>
                    </div>
                </div>
                <button onclick="openSaveSlotsModal()" class="bg-indigo-500/20 hover:bg-indigo-500/40 text-indigo-200 px-6 py-2 rounded-xl transition-colors border border-indigo-500/50 font-bold ml-2">
                    ğŸ’¾ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
                </button>
                <button onclick="closeTreasureEditor()" class="bg-red-500/20 hover:bg-red-500/40 text-red-200 px-6 py-2 rounded-xl transition-colors border border-red-500/50 font-bold">
                    Ø®Ø±ÙˆØ¬ âœ–
                </button>
            </div>

            <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
            <div class="flex-1 grid grid-cols-1 lg:grid-cols-12 gap-6 overflow-hidden pb-4">
                
                <!-- Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø£ÙŠÙ…Ù†: Ø´Ø¨ÙƒØ© Ø§Ù„Ø®Ø²Ø§Ø¦Ù† (4 Ø£Ø¹Ù…Ø¯Ø©) -->
                <div class="lg:col-span-4 bg-slate-800/60 rounded-2xl border border-slate-700 p-4 flex flex-col h-full overflow-hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-cyan-300">ğŸ—ºï¸ Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø®Ø²Ø§Ø¦Ù†</h3>
                        <span class="text-xs bg-slate-700 px-2 py-1 rounded text-slate-300">50 Ø®Ø²Ù†Ø©</span>
                    </div>
                    
                    <div class="flex-1 overflow-y-auto pr-2 custom-scrollbar">
                        <div id="editorGrid" class="grid grid-cols-5 gap-2">
                            <!-- Ø³ÙŠØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø´Ø¨ÙƒØ© Ù‡Ù†Ø§ Ø¨ÙˆØ§Ø³Ø·Ø© JS -->
                        </div>
                    </div>
                    
                    <div class="mt-4 pt-4 border-t border-slate-700">
                        <div class="flex gap-2 text-xs text-slate-400 justify-center">
                            <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-slate-600"></span>Ø£ØµÙ„ÙŠ</span>
                            <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-amber-500"></span>Ù…Ø¹Ø¯Ù„</span>
                            <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-cyan-400 border border-white"></span>Ù…Ø­Ø¯Ø¯</span>
                        </div>
                    </div>
                </div>

                <!-- Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø£ÙŠØ³Ø±: Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… (8 Ø£Ø¹Ù…Ø¯Ø©) -->
                <div class="lg:col-span-8 bg-slate-800/60 rounded-2xl border border-slate-700 p-6 flex flex-col h-full overflow-y-auto relative">
                    
                    <!-- Ø­Ø§Ù„Ø© Ø¹Ø¯Ù… Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± -->
                    <div id="noSelection" class="absolute inset-0 flex flex-col items-center justify-center text-slate-500 z-10 bg-slate-800/60 backdrop-blur-sm rounded-2xl">
                        <span class="text-6xl mb-4 opacity-50">ğŸ‘†</span>
                        <p class="text-xl">Ø§Ø®ØªØ± Ø®Ø²Ù†Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© Ù„Ù„Ø¨Ø¯Ø¡</p>
                    </div>

                    <!-- Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ -->
                    <div id="editForm" class="hidden h-full flex flex-col">
                        <!-- Ø±Ø£Ø³ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ -->
                        <div class="flex justify-between items-start mb-6 border-b border-slate-700 pb-4">
                            <div>
                                <span class="text-sm text-cyan-400 font-bold tracking-wider">Ø¬Ø§Ø±ÙŠ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø®Ø²Ù†Ø© Ø±Ù‚Ù…</span>
                                <h2 class="text-4xl font-black text-white mt-1" id="selectedBoxDisplay">#00</h2>
                            </div>
                            <button onclick="resetToDefault()" class="text-xs bg-slate-700 hover:bg-slate-600 text-slate-300 px-3 py-2 rounded-lg transition-colors border border-slate-600 flex items-center gap-2">
                                <span>ğŸ”„</span> Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ© Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø²Ù†Ø©
                            </button>
                        </div>

                        <!-- Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ (Ø¨Ø·Ø§Ù‚Ø§Øª) -->
                        <div class="mb-8">
                            <label class="block text-slate-300 mb-3 font-bold">Ù…Ø§Ø°Ø§ ÙŠÙˆØ¬Ø¯ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø®Ø²Ù†Ø©ØŸ</label>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                                <label class="cursor-pointer">
                                    <input type="radio" name="contentType" value="bonus" class="peer sr-only" onchange="updateFormVisibility()">
                                    <div class="h-full p-4 bg-slate-700/50 border-2 border-transparent rounded-xl hover:bg-slate-700 peer-checked:border-emerald-500 peer-checked:bg-emerald-500/10 transition-all text-center group">
                                        <div class="text-3xl mb-2 group-hover:scale-110 transition-transform">ğŸ’°</div>
                                        <div class="font-bold text-slate-200">Ù†Ù‚Ø§Ø· Ø¥ÙŠØ¬Ø§Ø¨ÙŠØ©</div>
                                    </div>
                                </label>
                                
                                <label class="cursor-pointer">
                                    <input type="radio" name="contentType" value="penalty" class="peer sr-only" onchange="updateFormVisibility()">
                                    <div class="h-full p-4 bg-slate-700/50 border-2 border-transparent rounded-xl hover:bg-slate-700 peer-checked:border-red-500 peer-checked:bg-red-500/10 transition-all text-center group">
                                        <div class="text-3xl mb-2 group-hover:scale-110 transition-transform">ğŸ’£</div>
                                        <div class="font-bold text-slate-200">Ø¹Ù‚ÙˆØ¨Ø© / Ø®ØµÙ…</div>
                                    </div>
                                </label>

                                <label class="cursor-pointer">
                                    <input type="radio" name="contentType" value="gift" class="peer sr-only" onchange="updateFormVisibility()">
                                    <div class="h-full p-4 bg-slate-700/50 border-2 border-transparent rounded-xl hover:bg-slate-700 peer-checked:border-blue-500 peer-checked:bg-blue-500/10 transition-all text-center group">
                                        <div class="text-3xl mb-2 group-hover:scale-110 transition-transform">ğŸ</div>
                                        <div class="font-bold text-slate-200">Ù‡Ø¯ÙŠØ© Ù„Ù„ØºÙŠØ±</div>
                                    </div>
                                </label>

                                <label class="cursor-pointer">
                                    <input type="radio" name="contentType" value="other" class="peer sr-only" onchange="updateFormVisibility()">
                                    <div class="h-full p-4 bg-slate-700/50 border-2 border-transparent rounded-xl hover:bg-slate-700 peer-checked:border-purple-500 peer-checked:bg-purple-500/10 transition-all text-center group">
                                        <div class="text-3xl mb-2 group-hover:scale-110 transition-transform">â“</div>
                                        <div class="font-bold text-slate-200">Ø£Ø®Ø±Ù‰ / Ø¹Ø´ÙˆØ§Ø¦ÙŠ</div>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <!-- ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <!-- Ø§Ù„ÙŠÙ…ÙŠÙ†: Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© -->
                            <div class="space-y-2">
                                <div>
                                    <label class="block text-slate-400 text-xs mb-1">Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„ØªØ¹Ø¨ÙŠØ±ÙŠØ©</label>
                                    <div class="relative">
                                        <button type="button" onclick="toggleEmojiPicker()" id="emojiPickerBtn" class="w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-2xl h-11 flex items-center justify-between hover:border-amber-500 transition-all group">
                                            <span id="selectedEmojiDisplay">ğŸ´â€â˜ ï¸</span>
                                            <span class="text-[10px] text-slate-500 group-hover:text-amber-500">ØªØºÙŠÙŠØ± â–¼</span>
                                        </button>
                                        <input type="hidden" id="editIcon">
                                        
                                        <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© -->
                                        <div id="emojiPickerDropdown" class="hidden absolute top-full right-0 mt-2 w-72 bg-slate-800 border border-slate-600 rounded-xl shadow-2xl z-50 max-h-64 overflow-y-auto p-3 custom-scrollbar">
                                            <div class="text-xs text-slate-400 mb-2 font-bold">Ø§Ø®ØªØ± Ø£ÙŠÙ‚ÙˆÙ†Ø©:</div>
                                            <div id="emojiGrid" class="grid grid-cols-6 gap-2"></div>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-slate-400 text-xs mb-1">Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ</label>
                                    <input type="text" id="editTitle" class="w-full bg-slate-900 border border-slate-600 rounded-lg px-2 py-1.5 text-xs text-white focus:border-amber-500 focus:ring-1 focus:ring-amber-500 transition-all outline-none" placeholder="Ø¹Ù†ÙˆØ§Ù† ÙŠØ¸Ù‡Ø± Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†">
                                </div>
                                <div>
                                    <label class="block text-slate-400 text-xs mb-1">Ø¢Ù„ÙŠØ© Ø§Ù„Ù†Ù‚Ø§Ø·</label>
                                    <select id="editPointsType" class="w-full bg-slate-900 border border-slate-600 rounded-lg px-2 py-1.5 text-xs text-white focus:border-amber-500 focus:ring-1 focus:ring-amber-500 transition-all outline-none appearance-none">
                                        <option value="fixed">ğŸ”¢ Ø¹Ø¯Ø¯ Ù†Ù‚Ø§Ø· Ø«Ø§Ø¨Øª</option>
                                        <option value="double">âœ–ï¸2 Ù…Ø¶Ø§Ø¹ÙØ© Ø§Ù„Ù†Ù‚Ø§Ø·</option>
                                        <option value="half">â—2 Ù†ØµÙ Ø§Ù„Ù†Ù‚Ø§Ø·</option>
                                        <option value="input_bonus">âŒ¨ï¸ Ø¥Ø¯Ø®Ø§Ù„ ÙŠØ¯ÙˆÙŠ (Ø¥Ø¶Ø§ÙØ©)</option>
                                        <option value="input_penalty">âŒ¨ï¸ Ø¥Ø¯Ø®Ø§Ù„ ÙŠØ¯ÙˆÙŠ (Ø®ØµÙ…)</option>
                                        <option value="attack">âš”ï¸ Ù‡Ø¬ÙˆÙ… Ø¹Ù„Ù‰ ÙØ±ÙŠÙ‚ (Ø¬Ø¯ÙŠØ¯)</option>
                                        <option value="variable_penalty_self">ğŸ² Ø®ØµÙ… Ø¹Ø´ÙˆØ§Ø¦ÙŠ (Ø¹Ù„ÙŠÙƒ)</option>
                                        <option value="charity">ğŸ¤ Ù†Ù‚Ù„ Ù†Ù‚Ø§Ø·</option>
                                    </select>
                                    <!-- ÙˆØµÙ Ø§Ù„Ø¢Ù„ÙŠØ© -->
                                    <div id="pointsTypeDescription" class="mt-2 p-2 rounded bg-slate-800/50 border border-slate-700 text-[10px] text-slate-300 leading-relaxed hidden">
                                        <!-- Ø§Ù„ÙˆØµÙ Ø³ÙŠØ¸Ù‡Ø± Ù‡Ù†Ø§ -->
                                    </div>
                                </div>

                                <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù‡Ø¬ÙˆÙ… (ØªØ¸Ù‡Ø± ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ù‡Ø¬ÙˆÙ…) -->
                                <div id="attackSettingsContainer" class="hidden space-y-2 bg-red-900/20 p-2 rounded-lg border border-red-500/30">
                                    <div class="text-[10px] text-red-300 font-bold mb-1">âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù‡Ø¬ÙˆÙ…:</div>
                                    
                                    <div class="grid grid-cols-2 gap-2">
                                        <div>
                                            <label class="block text-slate-400 text-[10px] mb-1">Ø£Ù‚ØµÙ‰ Ø¶Ø±Ø±</label>
                                            <input type="number" id="attackMaxDamage" class="w-full bg-slate-900 border border-slate-600 rounded px-2 py-1 text-xs text-white" value="10" min="1">
                                        </div>
                                        <div>
                                            <label class="block text-slate-400 text-[10px] mb-1">ØªÙƒÙ„ÙØ© Ø§Ù„Ù‡Ø¬ÙˆÙ…</label>
                                            <input type="number" id="attackCost" class="w-full bg-slate-900 border border-slate-600 rounded px-2 py-1 text-xs text-white" value="0" min="0">
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-slate-400 text-[10px] mb-1">Ù†ÙˆØ¹ Ø§Ù„Ø§Ø³ØªÙ‡Ø¯Ø§Ù</label>
                                        <select id="attackType" class="w-full bg-slate-900 border border-slate-600 rounded px-2 py-1 text-xs text-white">
                                            <option value="targeted">ğŸ¯ Ù…Ø­Ø¯Ø¯ (Ø¨Ø§Ù„Ø§Ø³Ù…)</option>
                                            <option value="blind">ğŸ«£ Ø£Ø¹Ù…Ù‰ (Ø¨Ø·Ø§Ù‚Ø§Øª Ù…Ù‚Ù„ÙˆØ¨Ø©)</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø®ØµÙ… Ø§Ù„Ø¹Ø´ÙˆØ§Ø¦ÙŠ (ØªØ¸Ù‡Ø± ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø®ØµÙ… Ø¹Ø´ÙˆØ§Ø¦ÙŠ) -->
                                <div id="penaltySettingsContainer" class="hidden space-y-2 bg-red-900/20 p-2 rounded-lg border border-red-500/30">
                                    <div class="text-[10px] text-red-300 font-bold mb-1">âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø®ØµÙ… Ø§Ù„Ø¹Ø´ÙˆØ§Ø¦ÙŠ:</div>
                                    <div class="grid grid-cols-2 gap-2">
                                        <div>
                                            <label class="block text-slate-400 text-[10px] mb-1">Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰</label>
                                            <input type="number" id="penaltyMin" class="w-full bg-slate-900 border border-slate-600 rounded px-2 py-1 text-xs text-white" value="1" min="1">
                                        </div>
                                        <div>
                                            <label class="block text-slate-400 text-[10px] mb-1">Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰</label>
                                            <input type="number" id="penaltyMax" class="w-full bg-slate-900 border border-slate-600 rounded px-2 py-1 text-xs text-white" value="10" min="1">
                                        </div>
                                    </div>
                                </div>

                                <div id="pointsValueContainer">
                                    <label class="block text-slate-400 text-xs mb-1">Ù‚ÙŠÙ…Ø© Ø§Ù„Ù†Ù‚Ø§Ø·</label>
                                    <div class="relative">
                                        <input type="number" id="editPointsValue" oninput="updatePointsFeedback()" class="w-full bg-slate-900 border border-slate-600 rounded-lg px-2 py-1.5 text-xs text-white font-mono focus:ring-1 transition-all outline-none" placeholder="0">
                                        <span id="pointsIconIndicator" class="absolute left-2 top-1.5 text-xs"></span>
                                    </div>
                                    
                                    <!-- Ù†Øµ ØªÙˆØ¶ÙŠØ­ÙŠ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ -->
                                    <div id="pointsFeedback" class="text-[10px] mt-1 font-bold min-h-[1.25rem] transition-colors flex items-center gap-1"></div>

                                    <!-- Ø£Ø²Ø±Ø§Ø± Ø³Ø±ÙŠØ¹Ø© -->
                                    <div class="flex flex-wrap gap-1.5 mt-2">
                                        <button onclick="setPointsValue(5)" class="flex-1 text-[10px] bg-emerald-500/10 hover:bg-emerald-500/20 text-emerald-400 border border-emerald-500/30 px-1 py-1 rounded transition-colors text-center">+5 Ù…ÙƒØ§ÙØ£Ø©</button>
                                        <button onclick="setPointsValue(10)" class="flex-1 text-[10px] bg-emerald-500/10 hover:bg-emerald-500/20 text-emerald-400 border border-emerald-500/30 px-1 py-1 rounded transition-colors text-center">+10 ÙƒÙ†Ø²</button>
                                        <button onclick="setPointsValue(-5)" class="flex-1 text-[10px] bg-red-500/10 hover:bg-red-500/20 text-red-400 border border-red-500/30 px-1 py-1 rounded transition-colors text-center">-5 ØºØ±Ø§Ù…Ø©</button>
                                        <button onclick="setPointsValue(-10)" class="flex-1 text-[10px] bg-red-500/10 hover:bg-red-500/20 text-red-400 border border-red-500/30 px-1 py-1 rounded transition-colors text-center">-10 ÙØ®</button>
                                    </div>
                                </div>
                            </div>

                            <!-- Ø§Ù„ÙŠØ³Ø§Ø±: Ø§Ù„ÙˆØµÙ ÙˆØ§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© -->
                            <div class="space-y-2 flex flex-col">
                                <div class="flex-1">
                                    <label class="block text-slate-400 text-xs mb-1">Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø© (Ø§Ù„Ù…Ø­ØªÙˆÙ‰)</label>
                                    <textarea id="editContent" class="w-full h-20 bg-slate-900 border border-slate-600 rounded-lg px-2 py-1.5 text-xs text-white focus:border-amber-500 focus:ring-1 focus:ring-amber-500 transition-all outline-none resize-none" placeholder="Ø§ÙƒØªØ¨ Ù‡Ù†Ø§ Ù…Ø§ Ø³ÙŠØ¸Ù‡Ø± Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø¨Ø§Ù„ØªÙØµÙŠÙ„..."></textarea>
                                </div>
                                
                                <!-- Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…ØµØºØ±Ø© -->
                                <div class="bg-black/20 rounded-xl p-3 border border-white/5">
                                    <span class="text-[10px] text-slate-500 block mb-1">Ù…Ø¹Ø§ÙŠÙ†Ø© Ø­ÙŠØ© Ù„Ù„Ø¨Ø·Ø§Ù‚Ø©:</span>
                                    <div class="flex items-center gap-2 mb-2">
                                        <div class="text-2xl bg-slate-800 w-10 h-10 flex items-center justify-center rounded-full" id="previewIcon">â“</div>
                                        <div>
                                            <h4 class="font-bold text-amber-100 text-xs" id="previewTitle">Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ù‡Ù†Ø§</h4>
                                            <p class="text-[10px] text-slate-400 truncate w-40" id="previewContent">Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø³ÙŠØ¸Ù‡Ø± Ù‡Ù†Ø§...</p>
                                        </div>
                                    </div>
                                    <!-- Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØªØ£Ø«ÙŠØ± -->
                                    <div id="previewEffect" class="text-center text-[10px] font-bold p-2 rounded border border-dashed hidden"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Ø²Ø± Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø¹Ø§Ø¦Ù… (ØªÙ… Ø¥Ø®ÙØ§Ø¤Ù‡ Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡ Ø¨Ù…Ø¤Ø´Ø± Ø§Ù„Ø­ÙØ¸ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ) -->
                        <div class="mt-auto pt-4 border-t border-slate-700 flex justify-between items-center">
                            <div id="autoSaveIndicator" class="text-emerald-400 text-sm font-bold flex items-center gap-2 opacity-0 transition-opacity duration-500">
                                <span>â˜ï¸</span> ØªÙ… Ø§Ù„Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
                            </div>
                            <!-- Ø²Ø± Ø­ÙØ¸ ÙŠØ¯ÙˆÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) Ù„Ù…Ù† ÙŠÙØ¶Ù„ Ø§Ù„ØªØ£ÙƒØ¯ -->
                            <button onclick="saveTreasureEdit()" class="text-slate-500 hover:text-slate-300 text-xs transition-colors">
                                Ø­ÙØ¸ ÙŠØ¯ÙˆÙŠ
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© Ø¥Ø¯Ø§Ø±Ø© Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„Ø­ÙØ¸ -->
    <div id="saveSlotsModal" class="hidden fixed inset-0 z-[60] bg-black/80 backdrop-blur-sm transition-all duration-300 flex items-center justify-center p-4">
        <div class="bg-slate-900 border border-slate-700 rounded-3xl w-full max-w-4xl p-8 shadow-2xl relative overflow-hidden">
            <!-- Ø®Ù„ÙÙŠØ© Ø²Ø®Ø±ÙÙŠØ© -->
            <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-5 pointer-events-none"></div>
            
            <div class="flex justify-between items-center mb-8 relative z-10">
                <h2 class="text-3xl font-bold text-indigo-300 flex items-center gap-3">
                    <span>ğŸ’¾</span> Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„Ø®Ø²Ø§Ø¦Ù† Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
                </h2>
                <button onclick="document.getElementById('saveSlotsModal').classList.add('hidden')" class="text-slate-400 hover:text-white transition-colors text-2xl">
                    âœ–
                </button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 relative z-10" id="slotsContainer">
                <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦Ø© Ø§Ù„ÙØªØ­Ø§Øª Ù‡Ù†Ø§ Ø¨ÙˆØ§Ø³Ø·Ø© JavaScript -->
            </div>

            <div class="mt-8 text-center text-slate-400 text-sm relative z-10">
                <p>ÙŠÙ…ÙƒÙ†Ùƒ Ø­ÙØ¸ Ø­ØªÙ‰ 3 Ù†Ù…Ø§Ø°Ø¬ Ù…Ø®ØªÙ„ÙØ© Ù„Ù„Ø®Ø²Ø§Ø¦Ù† ÙˆØ§Ø³ØªØ¹Ø§Ø¯ØªÙ‡Ø§ ÙÙŠ Ø£ÙŠ ÙˆÙ‚Øª.</p>
            </div>
        </div>
    </div>

    <script>
        // Ù…ÙØªØ§Ø­ Ø§Ù„Ø­ÙØ¸ ÙÙŠ localStorage
        const STORAGE_KEY = 'robbans_vault_state';
        const SAVE_SLOTS_KEY = 'captainSafe_saveSlots';
        
        // ** Ù…ØµÙÙˆÙØ© ØµÙˆØ± Ø§Ù„ÙØ±Ù‚ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        let TEAM_IMAGE_URLS = [
            'images/zGXTtjr6-1.png', // Team 1
            'images/YCnYJWrX-2.png', // Team 2
            'images/t4SWLxqS-3.png', // Team 3
            'images/mgXC0HL8-4.png'  // Team 4
        ];
        
        // --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ ---
        const supabaseUrl = 'https://yrhjqzbmycjrmmjmpltq.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlyaGpxemJteWNqcm1tam1wbHRxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI2OTEzNjAsImV4cCI6MjA3ODI2NzM2MH0.nB3S9nVL7xUrFoNCIKDnaDGnVza1dc77J68KLelxEOs';
        
        let supabaseClient = null;
        try {
            if (typeof supabase !== 'undefined') {
                supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
            } else {
                console.warn('Supabase client library not loaded. Falling back to local storage.');
            }
        } catch (e) {
            console.error('Failed to initialize Supabase client:', e);
        }
        
        const GAME_ID = 'captain-safe'; // Ù…Ø¹Ø±Ù Ø®Ø§Øµ Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù„Ø¹Ø¨Ø©
        let currentUserId = null;

        async function initGameWithCloud() {
        if (!supabaseClient) {
            // Supabase ØºÙŠØ± Ù…ØªÙˆÙØ±: Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø­Ù„ÙŠ Ø¨ØµÙ…Øª
            initGame();
            return;
        }

        try {
            const { data: { session }, error } = await supabaseClient.auth.getSession();
            if (error) throw error;
            
            if (session) {
                currentUserId = session.user.id;
                await loadFromCloud();
            } else {
                // Ø²Ø§Ø¦Ø±: Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø­Ù„ÙŠ
                initGame(); 
            }
        } catch (err) {
            console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³Ø­Ø§Ø¨Ø©:", err);
            initGame(); // Fallback to local
        }
    }

       async function loadFromCloud() {
            const { data, error } = await supabaseClient
                .from('game_saves')
                .select('save_data')
                .eq('user_id', currentUserId)
                .eq('game_name', GAME_ID)
                .single();

            if (data && data.save_data) {
                loadGameState(data.save_data);
                
                // --- Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± Ø¶Ø±ÙˆØ±ÙŠ Ø¬Ø¯Ø§Ù‹ Ù„ÙƒÙŠ Ù„Ø§ ØªØ®ØªÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„Ù…Ø­Ø±Ø± ---
                editorState.originalTreasures = JSON.parse(JSON.stringify(initialTreasureData)); 
                // -------------------------------------------------------------

                // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
                createTreasureGrid();
                updateTeamSelectors();
                updateScoreboard();
                updateReopenBoxSelect();
                
                // Ø¶Ø¨Ø· Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø­Ø§Ù„ÙŠ
                const currentTeamEl = document.getElementById('currentTeam');
                if(currentTeamEl) {
                    currentTeamEl.value = gameState.currentTeam;
                }
            } else {
                initGame(); 
            }
        }

        async function saveToCloud(dataToSave) {
            if (!currentUserId || !supabaseClient) return;
            try {
                await supabaseClient.from('game_saves').upsert({ 
                    user_id: currentUserId, 
                    game_name: GAME_ID, 
                    save_data: dataToSave,
                    updated_at: new Date()
                }, { onConflict: 'user_id, game_name' });
            } catch (err) {
                console.error('Error saving to cloud:', err);
            }
        }
        // Ù…ØµÙÙˆÙØ© Ø±ÙˆØ§Ø¨Ø· ØµÙˆØ± Ø§Ù„Ø®Ø²Ø§Ø¦Ù† Ø§Ù„Ù…Ø±Ù‚Ù…Ø© (ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ù‡Ù†Ø§)
        const TREASURE_IMAGE_URLS = [
            // 1-9
            'images/05dHRC7G-1.webp', 
            'images/ZYFDtL6L-2.webp', 
            'images/SNS1yzGY-3.webp', 
            'images/SNS1yzGM-4.webp', 
            'images/qMJDkCGK-5.webp', 
            'images/Qx8YXWqk-6.webp', 
            'images/kXJYntyv-7.webp', 
            'images/HsYvp7tB-8.webp', 
            'images/xTfp0bPx-9.webp', 
            // 10-19
            'images/SNS1yzGv-10.webp', 
            'images/yY1pVSTt-11.webp', 
            'images/65Wb9GhD-12.webp', 
            'images/Dyvp2bgV-13.webp', 
            'images/sDjHVZJk-14.webp', 
            'images/c4xks8my-15.webp', 
            'images/GhX79hMM-16.webp', 
            'images/PrS3Nr63-17.webp', 
            'images/8PZKsPyX-18.webp', 
            'images/BQmYtQhk-19.webp',
            // 20-29
            'images/nc3RMcd6-20.webp',
            'images/65MjT5jJ-21.webp',
            'images/65MjT5jt-22.webp',
            'images/zXxt3XtJ-23.webp',
            'images/c4F96491-24.webp',
            'images/rFfnzFnF-25.webp',
            'images/CLcPdLP5-26.webp',
            'images/Dyxjmyjm-27.webp',
            'images/15vC45C8-28.webp',
            'images/CLcPdLPz-29.webp',
            // 30-39
            'images/t47r6Qw9-30.webp',
            'images/T3hkbMFd-31.webp',
            'images/BnthF9kZ-32.webp',
            'images/vZDPnFkH-33.webp',
            'images/8zsyvQ9C-34.webp',
            'images/SxjZ9F3n-35.webp',
            'images/x1qsmDhk-36.webp',
            'images/zG3dhZ6V-37.webp',
            'images/52jPzdT8-38.webp',
            'images/Z50fNt2r-39.webp',
            // 40-50
            'images/pLy0jb4Q-40.webp',
            'images/vZDPnFkr-41.webp',
            'images/YCjXFKZd-42.webp',
            'images/RhRP7MvY-43.webp',
            'images/v8LSFv5Y-44.webp',
            'images/zDSPZkT8-45.webp',
            'images/66L1JhC9-46.webp',
            'images/tRtmQzF9-47.webp',
            'images/44bFk1p9-48.webp',
            'images/7PMQ8NST-49.webp',
            'images/L4B0KVjz-50.webp'
        ];
        
        // ** ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„ÙØ±Ù‚: ÙŠØªÙ… Ø§Ù„Ø¢Ù† ØªØ®Ø²ÙŠÙ† Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„ÙØ±ÙŠÙ‚ ÙƒÙ†Øµ Ø¹Ø§Ø¯ÙŠ (Ù…Ø«Ù„ "Ø§Ù„Ø·Ø§Ù‚Ù… Ø§Ù„Ø£ÙˆÙ„")ØŒ ÙˆØ§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø³ØªÙƒÙˆÙ† ØµÙˆØ±Ø©
        let TEAM_NAMES = ['Ø§Ù„Ø·Ø§Ù‚Ù… Ø§Ù„Ø£ÙˆÙ„', 'Ø§Ù„Ø·Ø§Ù‚Ù… Ø§Ù„Ø«Ø§Ù†ÙŠ', 'Ø§Ù„Ø·Ø§Ù‚Ù… Ø§Ù„Ø«Ø§Ù„Ø«', 'Ø§Ù„Ø·Ø§Ù‚Ù… Ø§Ù„Ø±Ø§Ø¨Ø¹'];

        // Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
        const INITIAL_SCORE = 50;

        // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø©
        let gameState = {
            teams: [INITIAL_SCORE, INITIAL_SCORE, INITIAL_SCORE, INITIAL_SCORE], 
            currentTeam: 0,
            numTeams: 3, // Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù‡Ùˆ 3 Ø·ÙˆØ§Ù‚Ù…
            openedBoxes: new Set(),
            treasures: [],
            currentTreasure: null,
            currentBoxNumber: null
        };
        
        // Ù…ØªØºÙŠØ±Ø§Øª Ù…Ø¤Ù‚ØªØ© Ù„Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
        let tempTeamConfig = {
            numTeams: gameState.numTeams,
            teamNames: [...TEAM_NAMES]
        };

        // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù…Ø­Ø±Ø±
        let editorState = {
            selectedBox: null,
            originalTreasures: [] // Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ©
        };

        // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø®Ø²Ø§Ø¦Ù† Ø§Ù„Ù…Ø¨Ø±Ù…Ø¬Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹ (Ø§Ø­ØªÙØ¸ Ø¨Ù‡Ø§ ÙƒÙ€ const)
        const initialTreasureData = [
            {type: 'penalty', icon: 'ğŸ’”', title: 'Ø®ØµÙ… Ø¹Ù„Ù‰ Ù…Ø¬Ù…ÙˆØ¹Ø©', content: 'Ø§Ø®ØªØ± Ù…Ø¬Ù…ÙˆØ¹Ø© ØªØ®ØµÙ… Ø¹Ù„ÙŠÙ‡Ø§ 10 Ù†Ù‚Ø§Ø·', points: -10, selectTeam: true},
            {type: 'penalty', icon: 'âš¡', title: 'Ø®ØµÙ… Ù…ØªØºÙŠØ±', content: 'Ø§Ø®ØªØ± Ù…Ø¬Ù…ÙˆØ¹Ø© ØªØ®ØµÙ… Ø¹Ù„ÙŠÙƒ Ù…Ù† 1 Ø¥Ù„Ù‰ 10 Ù†Ù‚Ø§Ø·', points: 'variable_penalty_self', inputPoints: true},
            {type: 'gift', icon: 'ğŸ', title: 'Ù‡Ø¯ÙŠØ© Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©', content: 'Ø§Ø®ØªØ± Ù…Ø¬Ù…ÙˆØ¹Ø© ØªØ¹Ø·ÙŠÙ‡Ø§ 10 Ù†Ù‚Ø§Ø·', points: 10, selectTeam: true, giveToOther: true},
            {type: 'penalty', icon: 'ğŸ¤', title: 'ØµÙ…Øª', content: 'Ø¨ÙƒÙ„ Ø­Ø¨ Ø£ØºÙ„Ù‚ ÙÙ…Ùƒ Ù„Ù…Ø¯Ø© Ø¯ÙˆØ±Ø© ÙƒØ§Ù…Ù„Ø©', points: -15},
            {type: 'bonus', icon: 'ğŸ‘”', title: 'Ø§Ù„Ø«ÙŠØ§Ø¨ Ø§Ù„Ø³ÙˆØ¯Ø§Ø¡', content: 'Ù†Ù‚Ø§Ø·ÙƒÙ… ØªØ²ÙŠØ¯ Ø¹Ù„Ù‰ Ø¹Ø¯Ø¯ Ø«ÙŠØ§Ø¨ÙƒÙ… Ø§Ù„Ø³ÙˆØ¯Ø§Ø¡ØŒ Ø§Ù„Ø«ÙˆØ¨ Ø§Ù„ÙˆØ§Ø­Ø¯ Ø¨Ø®Ù…Ø³ Ù†Ù‚Ø§Ø·', points: 'input_bonus', inputPoints: true},
            {type: 'bonus', icon: 'ğŸ‘´', title: 'ÙˆØ¯Ø§Ø¹ Ø§Ù„Ø£ÙƒØ¨Ø±', content: 'ÙˆØ¯Ø¹ÙˆØ§ Ø£ÙƒØ¨Ø±ÙƒÙ… Ø¹Ù…Ø±Ø§Ù‹ğŸ˜¢', points: 10},
            {type: 'penalty', icon: 'ğŸ‘¶', title: 'Ø¹Ù…Ø± Ø§Ù„Ø£ØµØºØ±', content: 'Ø£ØµØºØ±ÙƒÙ… Ø¹Ù…Ø±Ø§Ù‹ Ø®ØµÙ… Ø¹Ù„Ù‰ Ù‚Ø¯Ø± Ø¹Ù…Ø±Ù‡', points: 'input_penalty', inputPoints: true},
            {type: 'penalty', icon: 'ğŸ§¢', title: 'Ø§Ù„Ø£Ø´Ù…ØºØ©', content: 'Ø¢Ø³Ù Ù„ÙƒÙ† Ø®ØµÙ… Ø¹Ù„Ù‰ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø´Ù…ØºØ© Ø§Ù„Ù…Ù„Ø¨ÙˆØ³Ø© 3 Ù†Ù‚Ø§Ø· Ø¹Ù„Ù‰ Ø§Ù„Ø´Ù…Ø§Øº', points: 'input_penalty', inputPoints: true},
            {type: 'bonus', icon: 'ğŸ’°', title: 'Ø§Ù„ÙƒØ§Ø´', content: 'Ø§Ø°Ø§ Ù…Ø¹ÙƒÙ… 46 Ø±ÙŠØ§Ù„ ÙƒØ§Ø´ Ù„ÙƒÙ… Ù†ØµÙÙ‡Ø§ Ù†Ù‚Ø§Ø·', points: 23},
            {type: 'challenge', icon: 'â“', title: 'Ø£Ø³Ø¦Ù„Ø© Ø³Ø±ÙŠØ¹Ø©', content: '10 Ø£Ø³Ø¦Ù„Ø© Ø³Ø±ÙŠØ¹Ø© ÙÙŠ 60 Ø«Ø§Ù†ÙŠØ© Ø§Ø°Ø§ Ø¬Ø§ÙˆØ¨ØªÙ… Ø¹Ù„Ù‰ 8 Ù„ÙƒÙ… Ø§Ù„Ù†Ù‚Ø§Ø·', points: 30},
            {type: 'bonus', icon: 'ğŸ“', title: 'Ø·Ù„Ø§Ø¨ Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©', content: '10 Ù†Ù‚Ø§Ø· Ø¹Ù„Ù‰ Ø¹Ø¯Ø¯ Ø·Ù„Ø§Ø¨ Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©ØŒ Ø¨ÙƒØ§Ù„ÙˆØ±ÙŠÙˆØ³ ÙÙ‚Ø·', points: 'input_bonus', inputPoints: true},
            {type: 'penalty', icon: 'ğŸ˜­', title: 'Ù†ØµÙ Ø§Ù„Ù†Ù‚Ø§Ø·', content: 'Ø£Ù†Ø§ Ø¢Ø³Ù Ø®ØµÙ… 50%ğŸ˜­', points: 'half'},
            {type: 'bonus', icon: 'ğŸ‰', title: 'Ù…Ø¶Ø§Ø¹ÙØ© Ø§Ù„Ù†Ù‚Ø§Ø·', content: 'Ø¥Ø¬Ø­Ø¯ÙˆÙ‡Ø§ Ù†Ù‚Ø§Ø·ÙƒÙ… Ø¶Ø±Ø¨ 2', points: 'double'},
            {type: 'challenge', icon: 'ğŸ“', title: 'Ù‚ØµÙŠØ¯Ø© ÙƒØ§Ù…Ù„Ø©', content: 'Ø£Ø¹Ø·ÙˆÙ†ÙŠ Ù‚ØµÙŠØ¯Ø© ÙƒØ§Ù…Ù„Ø© Ø¬Ù…ÙŠÙ„Ø©', points: 20},
            {type: 'challenge', icon: 'ğŸµ', title: 'Ù†Ø´ÙŠØ¯ Ø´Ø¬ÙŠ', content: 'Ù†Ø´ÙŠØ¯ Ø¨ØµÙˆØª Ø´Ø¬ÙŠ Ù„Ù…Ø¯Ø© Ø¯Ù‚ÙŠÙ‚ØªÙŠÙ†', points: 30},
            {type: 'challenge', icon: 'ğŸ“–', title: 'Ø´Ø¹Ø± Ø¨Ø§Ù„Ø¬ÙŠÙ…', content: 'Ø¨ÙŠØªÙŠÙ† Ø´Ø¹Ø± ØªØ¨Ø¯Ø£ Ø¨Ø­Ø±Ù Ø§Ù„Ø¬ÙŠÙ…', points: 15},
            {type: 'challenge', icon: 'ğŸ“–', title: 'Ø´Ø¹Ø± Ø¨Ø§Ù„ÙŠØ§Ø¡', content: 'Ø¨ÙŠØªÙŠÙ† Ø´Ø¹Ø± Ø¨Ø­Ø±Ù Ø§Ù„ÙŠØ§Ø¡', points: 15},
            {type: 'penalty', icon: 'ğŸ©', title: 'Ø§Ø®Ù„Ø¹ Ø§Ù„Ø±Ø£Ø³', content: 'Ø¨ÙƒØ§Ù…Ù„ Ø§Ù„Ø¥Ø­ØªØ±Ø§Ù… Ø§Ø®Ù„Ø¹ Ù…Ø§ Ø¹Ù„Ù‰ Ø±Ø£Ø³Ùƒ', points: -30},
            {type: 'challenge', icon: 'ğŸ“¿', title: 'Ø¢ÙŠØ© Ø§Ù„Ù†ÙˆØ±', content: 'ØªÙ„Ø§ÙˆØ© Ø¹Ø·Ø±Ù‡ Ù„Ø¢ÙŠØ© Ø§Ù„Ù„Ù‡ Ù†ÙˆØ± Ø§Ù„Ø³Ù…ÙˆØ§Øª ÙˆØ§Ù„Ø£Ø±Ø¶', points: 25},
            {type: 'penalty', icon: 'â¸ï¸', title: 'ØªÙˆÙ‚Ù', content: 'Ø§ÙˆÙ‚ÙÙˆØ§ Ø­ØªÙ‰ ÙŠØ­ÙŠÙ† Ø¯ÙˆØ±ÙƒÙ… Ù…Ø±Ø© Ø£Ø®Ø±Ù‰', points: -35},
            {type: 'bonus', icon: 'âœï¸', title: 'Ø§Ù„Ø£Ù‚Ù„Ø§Ù…', content: 'Ø¹Ù„Ù‰ ÙƒÙ„ Ù‚Ù„Ù… ÙÙŠ Ø¬ÙŠÙˆØ¨ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ù†Ù‚Ø·ØªÙŠÙ†', points: 'input_bonus', inputPoints: true},
            {type: 'penalty', icon: 'ğŸ˜¢', title: 'Ø§Ù„ÙˆØ¯Ø§Ø¹', content: 'Ù†ÙˆØ§Ø§Ø¯Ø¹ÙƒÙ… Ø¨Ø¯Ù…Ø¹Ø§Øª Ø§Ù„Ø¹ÙŠÙˆÙ†ğŸ˜¢ØŒ Ø§Ù„Ø´Ø®Øµ Ø±Ù‚Ù… 3 Ù…Ù† ÙŠÙ…ÙŠÙ† Ø§Ù„Ù…Ù„Ù‚ÙŠ ÙŠØ±ÙˆØ­ Ù„Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„ØªØ§Ù„ÙŠØ© Ø§Ùˆ Ø§Ø¯ÙØ¹ 50 Ù†Ù‚Ø·Ø©', points: -50},
            {type: 'challenge', icon: 'ğŸ˜‚', title: 'Ø§Ù„Ø¶Ø­Ùƒ', content: 'Ø§Ø¶Ø­ÙƒÙˆØ§ Ù„Ù…Ø¯Ø© 10 Ø«ÙˆØ§Ù†ÙŠ', points: 30},
            {type: 'penalty', icon: 'ğŸ¦µ', title: 'Ù‚Ø¯Ù… ÙˆØ§Ø­Ø¯Ø©', content: 'Ø§ÙˆÙ‚ÙÙˆØ§ Ø¹Ù„Ù‰ Ù‚Ø¯Ù… ÙˆØ§Ø­Ø¯Ø© Ù„Ù…Ø¯Ø© 10 Ø«ÙˆØ§Ù†ÙŠ', points: -10},
            {type: 'bonus', icon: 'ğŸ“¦', title: 'Ø®Ø²Ù†ØªÙŠÙ†', content: 'Ù„Ùƒ Ø®Ø²Ù†ØªÙŠÙ† ÙŠØ§ Ø§Ù„Ø·ÙŠØ¨', points: 5},
            {type: 'challenge', icon: 'ğŸ‘‘', title: 'Ø´Ø¹Ø± Ø§Ù„Ø¹Ù‚Ø§Ù„', content: 'Ø§Ø¨ØªÙƒØ± Ø¨ÙŠØªØ§ Ù…ÙˆØ²ÙˆÙ†Ø§ Ù…Ù† Ø§Ù„Ø´Ø¹Ø± Ø¹Ù† Ø§Ù„Ø¹Ù‚Ø§Ù„', points: 20},
            {type: 'challenge', icon: 'ğŸš—', title: 'Ø´Ø¹Ø± Ø§Ù„ÙƒÙØ±', content: 'Ø§Ø¨ØªÙƒØ± Ø¨ÙŠØªØ§ Ù…ÙˆØ²ÙˆÙ†Ø§ Ù…Ù† Ø§Ù„Ø´Ø¹Ø± Ø¹Ù† ÙƒÙØ± Ø§Ù„Ø³ÙŠØ§Ø±Ø©', points: 20},
            {type: 'neutral', icon: 'ğŸ›‘', title: 'ÙˆÙ‚Ù', content: 'ÙˆÙ‚Ù Ø§Ù„Ù„Ù‡ Ù„Ø§ ÙŠÙ‡ÙŠÙ†Ùƒ', points: 0},
            {type: 'charity', icon: 'ğŸ’', title: 'ØµØ¯Ù‚Ø©', content: 'ØµØ¯Ù‚Ø©ØŒ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø£Ø¹Ù„Ù‰ Ù†Ù‚Ø§Ø· ØªØ¹Ø·ÙŠ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø£Ù‚Ù„ Ù†Ù‚Ø§Ø· 15% Ù…Ù† Ù†Ù‚Ø§Ø·Ù‡Ù…ØŒ Ø§Ù„ÙÙˆØ§ØµÙ„ ØªØ¬Ø¨Ø±', points: 'charity', selectTeam: true, inputPoints: true},
            {type: 'challenge', icon: 'ğŸ•Œ', title: 'Ù„ØºØ² ÙÙ‚Ù‡ÙŠ 1', content: 'Ù…Ù† Ø§Ù„Ù…Ø¹Ù„ÙˆÙ… Ø£Ù† Ù…Ù† Ø³Ù‡Ø§ ÙÙŠ ØµÙ„Ø§ØªÙ‡ ÙØ¥Ù† Ø§Ù„Ø³Ù‡Ùˆ ÙŠØ¬Ø¨Ø± Ø¨Ø³Ø¬ÙˆØ¯ Ø§Ù„Ø³Ù‡ÙˆØŒ ÙÙ…Ø§ ØªÙ‚ÙˆÙ„ ÙÙŠ Ø±Ø¬Ù„ Ø³Ù‡Ø§ ÙÙŠ ØµÙ„Ø§ØªÙ‡ ÙˆÙ„Ù… ÙŠØ¬Ø² Ù„Ù‡ Ø³Ø¬ÙˆØ¯ Ø§Ù„Ø³Ù‡ÙˆØŸ', points: 25},
            {type: 'challenge', icon: 'ğŸ•Œ', title: 'Ù„ØºØ² ÙÙ‚Ù‡ÙŠ 2', content: 'Ù…Ù† Ø§Ù„Ù…Ø¹Ù„ÙˆÙ… Ø£Ù† Ù…Ø§ ÙØ§ØªØªÙ‡ ØµÙ„Ø§Ø© ÙØ¥Ù†Ù‡ ÙŠÙ‚Ø¶ÙŠÙ‡Ø§ ÙƒÙ…Ø§ Ù‡ÙŠ Ù…Ù† ØºÙŠØ± Ø²ÙŠØ§Ø¯Ø© ÙÙŠ Ø¹Ø¯Ø¯ Ø±ÙƒØ¹Ø§ØªÙ‡Ø§ ÙÙ…Ø§ ØªÙ‚ÙˆÙ„ ÙÙŠ Ø±Ø¬Ù„ ØµÙ„Ù‰ ØµÙ„Ø§Ø© Ù‚Ø¶Ø§Ø¡ Ø¨Ø²ÙŠØ§Ø¯Ø© Ø±ÙƒØ¹Ø§Øª Ø¹Ù† Ø§Ù„ØµÙ„Ø§Ø© Ø§Ù„ÙØ§Ø¦ØªØ©ØŸ', points: 25},
            {type: 'challenge', icon: 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦', title: 'Ù„ØºØ² Ø§Ù„Ù…ÙŠØ±Ø§Ø«', content: 'Ù…Ø§ Ø§Ù„Ù‚ÙˆÙ„ ÙÙŠ Ø±Ø¬Ù„ ØªØ²ÙˆØ¬ Ø§Ù…Ø±Ø£Ø© ÙˆÙƒØ§Ù† Ø¨ÙŠÙ†Ù‡Ù…Ø§ Ø£ÙˆÙ„Ø§Ø¯ØŒ ÙÙ„Ù…Ø§ Ù…Ø§Øª Ø¹Ù†Ù‡Ø§ Ù‡Ø°Ø§ Ø§Ù„Ø±Ø¬Ù„ Ù„Ù… ÙŠÙƒÙ† Ù„Ù‡Ø§ Ù†ØµÙŠØ¨ Ù…Ù† Ø§Ù„ØªØ±ÙƒØ©ØŒ ÙˆØ¥Ù†Ù…Ø§ ÙƒØ§Ù†Øª Ù…Ù† Ù†ØµÙŠØ¨ Ø£ÙˆÙ„Ø§Ø¯Ù‡Ø§ ÙÙ‚Ø·ØŸ', points: 30},
            {type: 'challenge', icon: 'ğŸ¤²', title: 'Ø´Ø±Ø­ Ø§Ù„Ù…Ø«Ù„ 1', content: 'ÙˆØ§Ø­Ø¯ ÙŠØ·Ù„Ø¹ ÙŠØ´Ø±Ø­ Ø§Ù„Ù…Ø«Ù„ Ø¥ÙŠÙ…Ø§Ø¡Ù‹', points: 30},
            {type: 'challenge', icon: 'ğŸ¤²', title: 'Ø´Ø±Ø­ Ø§Ù„Ù…Ø«Ù„ 2', content: 'ÙˆØ§Ø­Ø¯ ÙŠØ·Ù„Ø¹ ÙŠØ´Ø±Ø­ Ø§Ù„Ù…Ø«Ù„ Ø¥ÙŠÙ…Ø§Ø¡Ù‹', points: 30},
            {type: 'challenge', icon: 'ğŸ¤²', title: 'Ø´Ø±Ø­ Ø§Ù„Ù…Ø«Ù„ 3', content: 'ÙˆØ§Ø­Ø¯ ÙŠØ·Ù„Ø¹ ÙŠØ´Ø±Ø­ Ø§Ù„Ù…Ø«Ù„ Ø¥ÙŠÙ…Ø§Ø¡Ù‹', points: 30},
            {type: 'challenge', icon: 'ğŸ¤²', title: 'Ø´Ø±Ø­ Ø§Ù„Ù…Ø«Ù„ 4', content: 'ÙˆØ§Ø­Ø¯ ÙŠØ·Ù„Ø¹ ÙŠØ´Ø±Ø­ Ø§Ù„Ù…Ø«Ù„ Ø¥ÙŠÙ…Ø§Ø¡Ù‹', points: 30},
            {type: 'challenge', icon: 'ğŸ“š', title: 'Ø¨ÙŠØª Ø´Ø¹Ø± 1', content: 'ÙˆØ¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù†ÙÙˆØ³ ÙƒØ¨Ø§Ø±Ø§Ù‹** ØªØ¹Ø¨Øª ÙÙŠ Ù…Ø±Ø§Ø¯Ù‡Ø§ Ø§Ù„Ø£Ø¬Ø³Ø§Ù…ÙØŒ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù„ØŸ', points: 15},
            {type: 'challenge', icon: 'ğŸ“š', title: 'Ù…Ù‚ÙˆÙ„Ø© Ù…Ø´Ù‡ÙˆØ±Ø©', content: 'Ø£Ø·Ù„Ø¨Ùˆ Ø§Ù„Ù…ÙˆØª ØªÙˆÙ‡Ø¨ Ù„ÙƒÙ… Ø§Ù„Ø­ÙŠØ§Ø©ØŒ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù„ØŸ', points: 15},
            {type: 'penalty', icon: 'ğŸ“¸', title: 'ØµÙˆØ±Ø© Ù…Ø¹ Ø§Ù„ÙˆØ±Ø¯Ø©', content: 'Ø§Ø«Ù†ÙŠÙ† Ù…Ù†ÙƒÙ… ÙŠØªØµÙˆØ±ÙˆÙ† Ù…Ø¹ Ø§Ù„ÙˆØ±Ø¯Ø© ÙˆÙŠÙ†Ø²Ù„ÙˆÙ‡Ø§ Ø³Ù†Ø§Ø¨ Ø¹Ø§Ù…', points: -30},
            {type: 'challenge', icon: 'ğŸ“·', title: 'ØµÙˆØ±Ø© Ø¬Ù…Ø§Ø¹ÙŠØ©', content: 'ØµÙˆØ±Ø© Ø¬Ù…Ø§Ø¹ÙŠØ© Ù…Ø¹ Ø§Ù„ÙˆÙˆØ±Ø¯ ÙÙŠ Ø§Ù„Ù‚Ø±ÙˆØ¨', points: 20},
            {type: 'challenge', icon: 'ğŸŒ', title: 'Ø´Ø¹Ø± Ø§Ù„Ù…ÙˆØ²', content: 'Ø§Ø±ØªØ¬Ù„ Ø¨ÙŠØªØ§ Ù…ÙˆØ²ÙˆÙ†Ø§ Ù…Ù† Ø§Ù„Ø´Ø¹Ø± Ø¹Ù† Ø§Ù„Ù…ÙˆØ²', points: 20},
            {type: 'penalty', icon: 'âš¡', title: 'Ø®ØµÙ… ÙƒØ¨ÙŠØ± Ù…ØªØºÙŠØ±', content: 'Ø§Ø®ØªØ± Ù…Ø¬Ù…ÙˆØ¹Ø© ØªØ®ØµÙ… Ø¹Ù„ÙŠÙƒ Ù…Ù† 1 Ø¥Ù„Ù‰ 20 Ù†Ù‚Ø·Ø©', points: 'variable_penalty_big_self', inputPoints: true},
            {type: 'gift', icon: 'ğŸ', title: 'Ù‡Ø¯ÙŠØ© ÙƒØ¨ÙŠØ±Ø©', content: 'Ø£Ø®ØªØ± Ù…Ø¬Ù…ÙˆØ¹Ø© ØªÙ…Ù†Ø­Ù‡Ø§ 20 Ù†Ù‚Ø·Ø©', points: 20, selectTeam: true, giveToOther: true},
            {type: 'challenge', icon: 'ğŸµ', title: 'Ù†Ø´ÙŠØ¯ Ø¬Ù…Ø§Ø¹ÙŠ', content: 'Ù†Ø´ÙŠØ¯ Ø¬Ù…Ø§Ø¹ÙŠ Ù„Ù…Ø¯Ø© Ø¯Ù‚ÙŠÙ‚Ø©ØŒ Ø§Ø°Ø§ Ø®Ø±Ø¨ Ø§Ù„Ù†Ø´ÙŠØ¯ Ø±Ø§Ø­Øª Ø§Ù„Ù†Ù‚Ø§Ø·', points: 30},
            {type: 'challenge', icon: 'ğŸ“–', title: 'Ø³Ø§Ù„ÙØ©', content: 'Ø³Ø§Ù„ÙØ© ØªÙ‚ÙŠÙ…Ù‡Ø§ 10/11ØŒ Ø£Ù†Ø§ Ø§Ù„Ù…Ù‚ÙŠÙ…ğŸ‘ğŸ¼', points: 25},
            {type: 'penalty', icon: 'ğŸ—£ï¸', title: 'Ù„Ø³Ø§Ù† Ù…Ø¹Ù‚ÙˆØ¯ 1', content: 'Ù‚ÙˆÙ„Ù‡Ø§ Ø®Ù…Ø³ Ù…Ø±Ø§Øª Ø¨Ø³Ø±Ø¹Ø© (Ø´Ù€Ø±Ø´Ù€ÙÙ€Ù†Ø§ Ù…Ø¹ Ø´Ù€Ø±ÙŠÙ ÙˆØ´Ø±Ø´Ù Ø´Ù€Ø±ÙŠÙ Ø²Ù‰ Ø´Ù€Ø±Ø´Ù€ÙÙ€Ù†Ø§) Ø«Ù„Ø§Ø« Ù…Ø­Ø§ÙˆÙ„Ø§Øª', points: -20},
            {type: 'challenge', icon: 'ğŸ—£ï¸', title: 'Ù„Ø³Ø§Ù† Ù…Ø¹Ù‚ÙˆØ¯ 2', content: 'Ù‚ÙˆÙ„Ù‡Ø§ Ø®Ù…Ø³ Ù…Ø±Ø§Øª Ø¨Ø³Ø±Ø¹Ø©( Ø°Ø¨Ø­Ù†Ø§ Ø¨Ù‚Ø±ØªÙ€Ù†Ø§ ÙˆØ°Ø¨Ø­ÙˆØ§ Ø¨Ù‚Ù€Ø±Ø© Ø¨Ø§Ø±Ù‚Ø¨Ù‡ Ø·Ù„Ø¹Øª Ù…Ø±Ù‚Ø© Ø¨Ù‚Ø±ØªÙ€Ù†Ø§ Ø§Ø­Ø³Ù† Ù…Ù† Ù…Ø±Ù‚Ø© Ø¨Ù‚Ù€Ø±Ø© Ø¨Ø§Ø±Ù‚Ø¨Ù‡) Ø«Ù„Ø§Ø« Ù…Ø­Ø§ÙˆÙ„Ø§Øª', points: 20},
            {type: 'penalty', icon: 'ğŸ˜­', title: 'Ø¨ÙƒØ§Ø¡ Ø´Ø¯ÙŠØ¯', content: 'Ø¨ÙƒØ§Ø¡ Ø´Ø¯ÙŠØ¯ Ù„Ù…Ø¯Ø© 15 Ø«Ø§Ù†ÙŠØ©', points: -20},
            {type: 'bonus', icon: 'ğŸ‘¶', title: 'Ø§Ù„Ø£Ø¨Ù†Ø§Ø¡', content: 'Ø²ÙŠØ§Ø¯Ø© Ù†Ù‚Ø§Ø· Ø¹Ù„Ù‰ Ø¹Ø¯Ø¯ Ø§Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© 5 Ù†Ù‚Ø§Ø·', points: 'input_bonus', inputPoints: true},
            {type: 'penalty', icon: 'ğŸ‘“', title: 'Ø§Ù„Ù†Ø¸Ø§Ø±Ø§Øª', content: 'Ø®ØµÙ… Ø¹Ù„Ù‰ Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ø¸Ø§Ø±Ø§Øª ÙÙŠ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø®ØµÙ… 5', points: 'input_penalty', inputPoints: true}
        ];


        // 1. Ø¯Ø§Ù„Ø© Ø­ÙØ¸ Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© ÙÙŠ localStorage
        function saveGameState() {
            try {
                const stateToSave = {
                    teams: gameState.teams,
                    currentTeam: gameState.currentTeam,
                    numTeams: gameState.numTeams,
                    openedBoxes: Array.from(gameState.openedBoxes), 
                    treasures: gameState.treasures,
                    teamNames: TEAM_NAMES,
                    teamImages: TEAM_IMAGE_URLS
                };
                
                // 1. Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø­Ù„ÙŠ
                localStorage.setItem(STORAGE_KEY, JSON.stringify(stateToSave));
                
                // 2. Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ
                saveToCloud(stateToSave);
                
            } catch (error) {
                console.error('Error saving game state:', error);
            }
        }

        // 2. Ø¯Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© Ù…Ù† localStorage
        function loadGameState(cloudData = null) {
            try {
                let loadedState = null;

                // Ø£ÙˆÙ„ÙˆÙŠØ© Ù„Ù„Ø³Ø­Ø§Ø¨Ø©
                if (cloudData) {
                    loadedState = cloudData;
                } else {
                    const savedState = localStorage.getItem(STORAGE_KEY);
                    if (savedState) loadedState = JSON.parse(savedState);
                }

                if (loadedState) {
                    gameState.teams = loadedState.teams || [INITIAL_SCORE, INITIAL_SCORE, INITIAL_SCORE, INITIAL_SCORE];
                    gameState.currentTeam = loadedState.currentTeam || 0;
                    gameState.numTeams = loadedState.numTeams !== undefined ? loadedState.numTeams : 3;
                    
                    if (gameState.currentTeam >= gameState.numTeams) {
                        gameState.currentTeam = 0;
                    }

                    gameState.openedBoxes = new Set(loadedState.openedBoxes || []);

                    if (loadedState.treasures && loadedState.treasures.length === initialTreasureData.length) {
                        gameState.treasures = loadedState.treasures;
                    } else {
                        gameState.treasures = JSON.parse(JSON.stringify(initialTreasureData));
                    }
                    
                    if (loadedState.teamNames && loadedState.teamNames.length === 4) {
                        TEAM_NAMES = loadedState.teamNames;
                    }

                    if (loadedState.teamImages && loadedState.teamImages.length === 4) {
                        TEAM_IMAGE_URLS = loadedState.teamImages;
                    }
                    
                    return true;
                }
            } catch (error) {
                console.error('Error loading game state:', error);
            }
            return false;
        }

        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©
        function initGame() { 
            // Ù†Ø­Ø§ÙˆÙ„ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† Ø§Ù„Ù…Ø­Ù„ÙŠ ÙÙ‚Ø· Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø³Ø­Ø§Ø¨ÙŠ
            // (Ø³Ù†Ø¹Ø±Ù Ø°Ù„Ùƒ Ù…Ù† Ø®Ù„Ø§Ù„ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¯ Ù…Ù„Ø¦Øª Ø¨Ø§Ù„ÙØ¹Ù„ Ø£Ù… Ù„Ø§)
            
            // Ù„ÙƒÙ† Ù„Ù„ØªØ¨Ø³ÙŠØ·: Ø³Ù†Ù‚ÙˆÙ… Ø¨Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­Ù„ÙŠ Ù‡Ù†Ø§ ÙƒØ§Ù„Ù…Ø¹ØªØ§Ø¯
            // ÙˆØ¥Ø°Ø§ Ø¬Ø§Ø¡Øª Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø­Ø§Ø¨Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹ (Ø¹Ø¨Ø± initGameWithCloud -> loadFromCloud)
            // Ø³ØªÙ‚ÙˆÙ… Ù‡ÙŠ Ø¨ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„ÙˆØ§Ø¬Ù‡Ø©
            
            const isLoaded = loadGameState();
            
            if (!isLoaded && gameState.treasures.length === 0) { // Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø¨ÙŠØ§Ù†Ø§Øª
                gameState.treasures = JSON.parse(JSON.stringify(initialTreasureData));
                gameState.teams = [INITIAL_SCORE, INITIAL_SCORE, INITIAL_SCORE, INITIAL_SCORE];
                gameState.numTeams = 3; 
            }
            editorState.originalTreasures = JSON.parse(JSON.stringify(initialTreasureData)); 

            // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            createTreasureGrid();
            updateTeamSelectors();
            updateScoreboard();
            updateReopenBoxSelect();
            const currentTeamEl = document.getElementById('currentTeam');
            if(currentTeamEl) currentTeamEl.value = gameState.currentTeam;
        }
        
        // ** Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙØ±Ù‚
        function openTeamConfigModal() {
            // Ù†Ø³Ø® Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¥Ù„Ù‰ Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ù…Ø¤Ù‚Øª
            tempTeamConfig.numTeams = gameState.numTeams;
            tempTeamConfig.teamNames = [...TEAM_NAMES];
            tempTeamConfig.teamImages = [...TEAM_IMAGE_URLS];

            // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙÙŠ Ø§Ù„Ù…Ø­Ø¯Ø¯
            document.getElementById('configNumTeamsSelect').value = gameState.numTeams;

            // Ø¥Ù†Ø´Ø§Ø¡ Ø­Ù‚ÙˆÙ„ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ (4)
            generateTeamNameInputs(4); 
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
            toggleTeamConfigModal(true);
        }

        // ** Ø¯Ø§Ù„Ø© Ù„ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙØ±Ù‚
        function toggleTeamConfigModal(open) {
            const modal = document.getElementById('teamConfigModal');
            if (open) {
                modal.classList.remove('hidden');
                setTimeout(() => modal.classList.add('active'), 10);
            } else {
                modal.classList.remove('active');
                setTimeout(() => modal.classList.add('hidden'), 300);
            }
        }
        
        // ** Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶/Ø¥Ø®ÙØ§Ø¡ Ø­Ù‚ÙˆÙ„ Ø¥Ø¯Ø®Ø§Ù„ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„ÙØ±Ù‚ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ø¯Ø¯
        function generateTeamNameInputs(count) {
            const container = document.getElementById('teamNameInputs');
            container.innerHTML = '';
            
            for (let i = 0; i < 4; i++) {
                const isVisible = i < count;
                // Ø¥Ø¶Ø§ÙØ© ÙØ¦Ø© Tailwind Ù„Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø¹Ø±Ø¶
                const visibilityClass = isVisible ? '' : 'hidden opacity-0 h-0';
                
                const div = document.createElement('div');
                div.className = `flex items-center gap-2 transition-all duration-300 ${visibilityClass}`;
                
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… ØµÙˆØ±Ø© Ø§Ù„ÙØ±ÙŠÙ‚ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ ÙÙŠ Ø§Ù„ØªØ³Ù…ÙŠØ©
                const teamImage = tempTeamConfig.teamImages[i] || TEAM_IMAGE_URLS[i];

                div.innerHTML = `
                    <div class="flex items-center gap-2 w-full bg-cyan-900/30 p-2 rounded-lg border border-cyan-500/30">
                        <!-- Image Upload & Preview -->
                        <div class="relative group w-12 h-12 flex-shrink-0">
                             <img id="previewConfigImg${i}" src="${teamImage}" class="w-full h-full rounded-full object-cover border-2 border-slate-500 group-hover:border-amber-400 transition-colors">
                             <div class="absolute inset-0 bg-black/50 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity cursor-pointer" onclick="document.getElementById('uploadConfigImg${i}').click()" title="ØªØºÙŠÙŠØ± Ø§Ù„ØµÙˆØ±Ø©">
                                 ğŸ“·
                             </div>
                             <input type="file" id="uploadConfigImg${i}" class="hidden" accept="image/*" onchange="handleTeamImageUpload(${i}, this, 'config')">
                        </div>

                        <input type="text" 
                            id="configTeamName${i}" 
                            value="${tempTeamConfig.teamNames[i]}"
                            oninput="tempTeamConfig.teamNames[${i}] = this.value"
                            class="flex-1 bg-cyan-800/50 text-white px-4 py-2 rounded-lg border border-cyan-400 focus:border-amber-400 focus:outline-none transition-colors" 
                            placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù‚Ù… ${i + 1}"
                        >
                    </div>
                `;
                container.appendChild(div);
            }
        }

        // Ø¯Ø§Ù„Ø© Ù…Ø¹Ø§Ù„Ø¬Ø© Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±
        function handleTeamImageUpload(index, input, context) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    if (context === 'config') {
                        tempTeamConfig.teamImages[index] = e.target.result;
                        document.getElementById(`previewConfigImg${index}`).src = e.target.result;
                    } else if (context === 'manage') {
                        currentManagingTeamImage = e.target.result;
                        document.getElementById('manageTeamPreviewImg').src = e.target.result;
                    }
                }
                reader.readAsDataURL(input.files[0]);
            }
        }
        
        // ** Ø¯Ø§Ù„Ø© Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù„ÙØ±Ù‚ (ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø±Ø¦ÙŠØ© Ù…Ø¤Ù‚ØªØ§Ù‹)
        function previewNumTeams(num) {
            const newNum = parseInt(num);
            tempTeamConfig.numTeams = newNum;
            // ØªØ­Ø¯ÙŠØ« Ù…Ø±Ø¦ÙŠØ© Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ù„ØªØªÙ†Ø§Ø³Ø¨ Ù…Ø¹ Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯
            const inputs = document.getElementById('teamNameInputs').children;
            for (let i = 0; i < 4; i++) {
                if (i < newNum) {
                    inputs[i].classList.remove('hidden', 'opacity-0', 'h-0');
                } else {
                    inputs[i].classList.add('hidden', 'opacity-0', 'h-0');
                }
            }
        }
        
        // ** Ø¯Ø§Ù„Ø© Ù„Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙØ±Ù‚ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        function saveTeamConfig() {
            const oldNumTeams = gameState.numTeams;
            const newNumTeams = tempTeamConfig.numTeams;

            // 1. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø¨Ø´ÙƒÙ„ Ø¯Ø§Ø¦Ù…
            TEAM_NAMES = [...tempTeamConfig.teamNames];
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙˆØ±
            if (tempTeamConfig.teamImages) {
                TEAM_IMAGE_URLS = [...tempTeamConfig.teamImages];
            }
            
            // 2. ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø¯ Ø§Ù„ÙØ±Ù‚
            if (newNumTeams !== oldNumTeams) {
                // ØªØµÙÙŠØ± Ù†Ù‚Ø§Ø· Ø§Ù„ÙØ±Ù‚ ØºÙŠØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø© ÙÙ‚Ø· Ø¥Ø°Ø§ Ù‚Ù„ Ø§Ù„Ø¹Ø¯Ø¯
                if (newNumTeams < oldNumTeams) {
                    for (let i = newNumTeams; i < 4; i++) {
                        gameState.teams[i] = 0; // ØªØµÙÙŠØ± Ø§Ù„Ù†Ù‚Ø§Ø· Ù„Ù„ÙØ±Ù‚ Ø§Ù„ØªÙŠ ØªÙ… ØªØ¹Ø·ÙŠÙ„Ù‡Ø§
                    }
                }
                
                gameState.numTeams = newNumTeams;
                
                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¥Ø°Ø§ ØªØ¬Ø§ÙˆØ² Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¬Ø¯ÙŠØ¯
                if (gameState.currentTeam >= gameState.numTeams) {
                    gameState.currentTeam = 0;
                }
                document.getElementById('currentTeam').value = gameState.currentTeam;
            }

            // 3. ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ÙˆØ­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø©
            updateTeamSelectors();
            updateScoreboard(); 
            saveGameState();
            toggleTeamConfigModal(false);
            showPointsAnimation('ğŸ’¾ ØªÙ… Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙØ±Ù‚ Ø¨Ù†Ø¬Ø§Ø­', 'green');
        }

        // ØªØ­Ø¯ÙŠØ« Ù…Ø­Ø¯Ø¯Ø§Øª Ø§Ù„ÙØ±Ù‚ ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ numTeams
        function updateTeamSelectors() {
            const teamNames = TEAM_NAMES.slice(0, gameState.numTeams);
            const teamSelects = [
                document.getElementById('currentTeam'),
                document.getElementById('penaltyTeamSelect'),
                document.getElementById('donorTeamSelect'),
                document.getElementById('receiverTeamSelect')
            ];

            teamSelects.forEach(select => {
                const currentValue = parseInt(select.value);
                select.innerHTML = '';
                teamNames.forEach((name, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = name; // Ø¹Ø±Ø¶ Ø§Ù„Ø§Ø³Ù… ÙÙ‚Ø·
                    select.appendChild(option);
                });
                
                if (currentValue < gameState.numTeams) {
                    select.value = currentValue;
                } else {
                    select.value = 0;
                }
            });

            // (Ø¬Ø¯ÙŠØ¯) ØªØ­Ø¯ÙŠØ« Ø´Ø¨ÙƒØ§Øª Ø§Ù„ÙØ±Ù‚ Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ©
            createTeamGrid('penaltyTeamGrid', 'penaltyTeamSelect');
            createTeamGrid('donorTeamGrid', 'donorTeamSelect');
            createTeamGrid('receiverTeamGrid', 'receiverTeamSelect');
        }

        // (Ø¬Ø¯ÙŠØ¯) Ø¯Ø§Ù„Ø© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø´Ø¨ÙƒØ© ÙØ±Ù‚ ØªÙØ§Ø¹Ù„ÙŠØ©
        function createTeamGrid(containerId, selectId, excludeIndex = -1) {
            const container = document.getElementById(containerId);
            const select = document.getElementById(selectId);
            if (!container || !select) return;

            container.innerHTML = '';
            const teamNames = TEAM_NAMES.slice(0, gameState.numTeams);

            teamNames.forEach((name, index) => {
                if (index === excludeIndex) return;

                const teamDiv = document.createElement('div');
                teamDiv.className = 'team-grid-item bg-slate-800 hover:bg-slate-700 border border-slate-600 rounded-lg p-2 cursor-pointer transition-all flex flex-col items-center gap-2 group relative overflow-hidden';
                teamDiv.dataset.index = index;
                
                // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø£ÙˆÙ„ÙŠØ©
                if (parseInt(select.value) === index) {
                    teamDiv.classList.add('selected', 'ring-2', 'ring-amber-400', 'bg-slate-700');
                }

                const teamImage = TEAM_IMAGE_URLS[index] || 'https://placehold.co/100x100/334155/FFFFFF?text=' + (index + 1);
                
                teamDiv.innerHTML = `
                    <div class="absolute inset-0 bg-gradient-to-t from-black/50 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                    <img src="${teamImage}" class="w-12 h-12 rounded-full object-cover border-2 border-slate-500 group-hover:border-amber-400 transition-colors shadow-md">
                    <span class="text-xs font-bold text-slate-300 group-hover:text-white text-center z-10">${name}</span>
                `;

                teamDiv.onclick = () => {
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø®ÙÙŠØ©
                    select.value = index;
                    updateGridSelection(containerId, selectId);
                };

                container.appendChild(teamDiv);
            });
        }

        // (Ø¬Ø¯ÙŠØ¯) ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¸Ù‡Ø± Ø§Ù„Ù…Ø±Ø¦ÙŠ Ù„Ù„Ø´Ø¨ÙƒØ© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
        function updateGridSelection(containerId, selectId) {
            const container = document.getElementById(containerId);
            const select = document.getElementById(selectId);
            if (!container || !select) return;
            
            const selectedVal = parseInt(select.value);
            
            container.querySelectorAll('.team-grid-item').forEach(el => {
                const itemIndex = parseInt(el.dataset.index);
                const img = el.querySelector('img');
                
                if (itemIndex === selectedVal) {
                    el.classList.remove('bg-slate-800');
                    el.classList.add('selected', 'ring-2', 'ring-amber-400', 'bg-slate-700');
                    if(img) {
                        img.classList.remove('border-slate-500');
                        img.classList.add('border-amber-400');
                    }
                } else {
                    el.classList.remove('selected', 'ring-2', 'ring-amber-400', 'bg-slate-700');
                    el.classList.add('bg-slate-800');
                    if(img) {
                        img.classList.remove('border-amber-400');
                        img.classList.add('border-slate-500');
                    }
                }
            });
        }

        // (Ø¬Ø¯ÙŠØ¯) Ø¯Ø§Ù„Ø© Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø°ÙƒÙŠ
        function adjustValue(inputId, delta) {
            const input = document.getElementById(inputId);
            if (!input) return;
            
            let currentVal = parseInt(input.value) || 0;
            let newVal = currentVal + delta;
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø¯ÙˆØ¯ (Ø§Ø®ØªÙŠØ§Ø±ÙŠØŒ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© max/min ÙƒÙ€ attributes Ù„Ù„Ù€ input)
            const min = input.getAttribute('min') ? parseInt(input.getAttribute('min')) : 0;
            const max = input.getAttribute('max') ? parseInt(input.getAttribute('max')) : Infinity;
            
            if (newVal < min) newVal = min;
            if (newVal > max) newVal = max;
            
            input.value = newVal;
            
            // Ø¥Ø¶Ø§ÙØ© ØªØ£Ø«ÙŠØ± Ø¨ØµØ±ÙŠ Ø¨Ø³ÙŠØ·
            input.classList.add('scale-110', 'text-amber-400');
            setTimeout(() => {
                input.classList.remove('scale-110', 'text-amber-400');
            }, 150);
        }

        // ** Ø¯Ø§Ù„Ø© Ù„ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© ØºØ±ÙØ© Ø§Ù„ØªØ­ÙƒÙ…
        function toggleControlPanel(open) {
            const modal = document.getElementById('controlPanelModal');
            if (open) {
                modal.classList.remove('hidden');
                setTimeout(() => modal.classList.add('active'), 10);
            } else {
                modal.classList.remove('active');
                setTimeout(() => modal.classList.add('hidden'), 300);
            }
        }

        // ØªØ­Ø¯ÙŠØ« Ù„ÙˆØ­Ø© Ø§Ù„Ù†Ù‚Ø§Ø· (Scoreboard) - ØªØµÙ…ÙŠÙ… HUD Ø§Ù„Ø¬Ø¯ÙŠØ¯
        function updateScoreboard() {
            const scoreboard = document.getElementById('scoreboard');
            scoreboard.innerHTML = '';
            
            // Ø¥Ø²Ø§Ù„Ø© ÙØ¦Ø§Øª Ø§Ù„Ø´Ø¨ÙƒØ© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ÙˆØ§Ø³ØªØ®Ø¯Ø§Ù… ÙÙ„ÙŠÙƒØ³
            scoreboard.className = 'flex-1 w-full md:w-auto order-3 md:order-2 flex flex-wrap md:flex-nowrap justify-center items-center gap-2 md:gap-4 overflow-x-auto pb-1 md:pb-0 scrollbar-hide';
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ù…ØµÙÙˆÙØ© Ø§Ù„Ù†Ù‚Ø§Ø· ØªØªØ·Ø§Ø¨Ù‚ Ù…Ø¹ Ø¹Ø¯Ø¯ Ø§Ù„ÙØ±Ù‚
            while (gameState.teams.length < 4) {
                gameState.teams.push(INITIAL_SCORE); 
            }
            
            for (let i = 0; i < gameState.numTeams; i++) {
                const teamDiv = document.createElement('div');
                const isCurrent = (i === gameState.currentTeam);
                
                let gradient = '';
                // Ø£Ù„ÙˆØ§Ù† Ù…Ù…ÙŠØ²Ø© Ù„ÙƒÙ„ ÙØ±ÙŠÙ‚ (ØªÙ… Ø¹ÙƒØ³ Ø§Ù„ØªØ¯Ø±Ø¬ Ù„ÙŠÙƒÙˆÙ† Ø§Ù„ØºØ§Ù…Ù‚ ÙŠÙ…ÙŠÙ† ÙˆØ§Ù„ÙØ§ØªØ­ ÙŠØ³Ø§Ø±)
                if (i === 0) gradient = 'from-blue-600 to-cyan-600 bg-gradient-to-l';
                if (i === 1) gradient = 'from-emerald-600 to-teal-600 bg-gradient-to-l';
                if (i === 2) gradient = 'from-red-600 to-rose-600 bg-gradient-to-l';
                if (i === 3) gradient = 'from-purple-600 to-indigo-600 bg-gradient-to-l';

                // ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©: Ø¹Ø±ÙŠØ¶ØŒ Ø£ÙÙ‚ÙŠØŒ Ø´ÙƒÙ„ "Ø¯Ø±Ø¹" Ø£Ùˆ Ø±Ø§ÙŠØ©
                teamDiv.className = `
                    relative group transition-all duration-300 ease-out cursor-pointer
                    ${isCurrent ? 'z-10 filter drop-shadow-[0_0_15px_rgba(251,191,36,0.8)] scale-105' : 'opacity-90 hover:opacity-100 hover:scale-105 filter drop-shadow-md'}
                    ${gradient} 
                    w-full md:w-64 flex-1 max-w-xs
                    flex items-center gap-2 px-4 pt-3 pb-8
                `;
                
                // ØªØ·Ø¨ÙŠÙ‚ Ø´ÙƒÙ„ Ø§Ù„Ø¯Ø±Ø¹ (Ù‚ØµØ© Ù…Ù† Ø§Ù„Ø£Ø³ÙÙ„)
                teamDiv.style.clipPath = 'polygon(0 0, 100% 0, 100% 80%, 50% 100%, 0 80%)';

                const teamName = TEAM_NAMES[i];
                const teamImage = TEAM_IMAGE_URLS[i];

                teamDiv.innerHTML = `
                    <!-- Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ (ØªÙØªØ­ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³Ø±ÙŠØ¹Ø©) -->
                    <button onclick="openTeamManagementModal(${i})" class="absolute top-1 left-1 w-6 h-6 bg-white/20 hover:bg-white/40 rounded-full text-xs flex items-center justify-center text-white opacity-0 group-hover:opacity-100 transition-all z-20 backdrop-blur-sm" title="Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙØ±ÙŠÙ‚">
                        âš™ï¸
                    </button>

                    <!-- Ø§Ù„ÙŠÙ…ÙŠÙ†: Ø§Ù„ØµÙˆØ±Ø© -->
                    <div class="relative flex-shrink-0">
                        <!-- Ø§Ù„Ø¯Ø§Ø¦Ø±Ø© Ø§Ù„Ù…ØªÙˆÙ‡Ø¬Ø© Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ùˆ Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠ -->
                        <div class="${isCurrent ? 'absolute inset-0 rounded-full bg-amber-400 blur-md opacity-75 animate-pulse' : 'hidden'}"></div>
                        
                        <img src="${teamImage}" class="relative w-12 h-12 object-contain drop-shadow-md bg-white/10 rounded-full p-1.5 ${isCurrent ? 'border-2 border-amber-300' : ''}">
                        
                        <!-- Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ù†Ù‚Ø·Ø© Ø§Ù„ØµØºÙŠØ±Ø© (ØªÙ…Øª Ø¥Ø²Ø§Ù„ØªÙ‡Ø§ ÙˆØ§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡Ø§ Ø¨Ø§Ù„ØªÙˆÙ‡Ø¬ Ø§Ù„ÙƒØ§Ù…Ù„) -->
                    </div>

                    <!-- Ø§Ù„ÙˆØ³Ø·: Ø§Ù„Ø§Ø³Ù… (Ù…ØªÙˆØ³Ø·) -->
                    <div class="flex-1 text-center min-w-0 px-1">
                        <span class="text-xl md:text-2xl font-black text-white truncate block drop-shadow-md" style="text-shadow: 0 2px 4px rgba(0,0,0,0.5)">${teamName}</span>
                    </div>
                    
                    <!-- Ø§Ù„ÙŠØ³Ø§Ø±: Ø§Ù„Ù†Ù‚Ø§Ø· -->
                    <div class="bg-black/20 rounded-lg px-2 py-1 min-w-[50px] text-center border border-white/10 flex-shrink-0">
                        <div id="team${i}Score" class="text-2xl font-black text-amber-300 leading-none tracking-wide drop-shadow-md">
                            ${gameState.teams[i]}
                        </div>
                    </div>
                    
                    <!-- Ù†Øµ "Ø§Ù„Ø¯ÙˆØ±" ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„ (Ø¯Ø§Ø®Ù„ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù‚Øµ) -->
                    ${isCurrent ? `
                        <div class="absolute bottom-1 left-1/2 transform -translate-x-1/2 mb-1">
                            <span class="text-[10px] font-bold text-amber-100 opacity-90 tracking-widest uppercase">Ø§Ù„Ø¯ÙˆØ±</span>
                        </div>
                    ` : ''}
                `;
                
                // Ø¬Ø¹Ù„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ù†Ù‚Ø± Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙØ±ÙŠÙ‚ ÙŠØ¯ÙˆÙŠØ§Ù‹
                teamDiv.onclick = (e) => {
                    // ØªØ¬Ù†Ø¨ Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø¹Ù†Ø¯ Ø¶ØºØ· Ø²Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
                    if(e.target.closest('button')) return;
                    
                    gameState.currentTeam = i;
                    saveGameState();
                    updateScoreboard();
                    document.getElementById('currentTeam').value = i;
                };

                scoreboard.appendChild(teamDiv);
            }
        }
        
        // ** Ù…ØªØºÙŠØ±Ø§Øª Ù„Ø¯Ø§Ù„Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø³ÙŠØ§Ù‚ÙŠØ© **
        let currentManagingTeamIndex = -1;
        let currentManagingTeamImage = null;

        // ** ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙØ±ÙŠÙ‚ **
        function openTeamManagementModal(index) {
            currentManagingTeamIndex = index;
            const modal = document.getElementById('teamManagementModal');
            
            // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            document.getElementById('manageTeamName').value = TEAM_NAMES[index];
            document.getElementById('manageTeamCurrentScore').textContent = gameState.teams[index];
            document.getElementById('manageTeamIcon').textContent = (index === 0) ? 'ğŸ”µ' : (index === 1) ? 'ğŸŸ¢' : (index === 2) ? 'ğŸ”´' : 'ğŸŸ£';
            
            // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„ØµÙˆØ±Ø©
            currentManagingTeamImage = TEAM_IMAGE_URLS[index];
            const imgPreview = document.getElementById('manageTeamPreviewImg');
            if (imgPreview) {
                imgPreview.src = currentManagingTeamImage || `https://placehold.co/100x100/334155/FFFFFF?text=${index + 1}`;
            }

            // ØªØµÙÙŠØ± Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙŠØ¯ÙˆÙŠ
            document.getElementById('manageTeamScoreInput').value = '';
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†Ø§ÙØ°Ø©
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.add('active'), 10);
        }

        // ** Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙØ±ÙŠÙ‚ **
        function closeTeamManagementModal() {
            const modal = document.getElementById('teamManagementModal');
            modal.classList.remove('active');
            setTimeout(() => modal.classList.add('hidden'), 300);
            currentManagingTeamIndex = -1;
        }

        // ** ØªØ­Ø¯ÙŠØ« Ø³Ø±ÙŠØ¹ Ù„Ù„Ù†Ù‚Ø§Ø· (Ø£Ø²Ø±Ø§Ø± +/-) **
        function quickUpdateScore(amount) {
            if (currentManagingTeamIndex === -1) return;
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ù‚Ø§Ø· ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø©
            let newScore = gameState.teams[currentManagingTeamIndex] + amount;
            gameState.teams[currentManagingTeamIndex] = newScore;
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶ ÙÙŠ Ø§Ù„Ù†Ø§ÙØ°Ø© ÙÙˆØ±Ø§Ù‹
            document.getElementById('manageTeamCurrentScore').textContent = newScore;
            
            // ØªØ­Ø¯ÙŠØ« Ù„ÙˆØ­Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø®Ù„ÙÙŠØ© Ø£ÙŠØ¶Ø§Ù‹ Ù„Ø±Ø¤ÙŠØ© Ø§Ù„ØªØºÙŠÙŠØ±
            updateScoreboard();
            
            // Ø­ÙØ¸ ÙÙˆØ±ÙŠ Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… Ø¶ÙŠØ§Ø¹ Ø§Ù„ØªØºÙŠÙŠØ± Ø¥Ø°Ø§ ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø¨Ø¯ÙˆÙ† Ø­ÙØ¸
            saveGameState();
        }

        // ** ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„ÙŠØ¯ÙˆÙŠØ© **
        function applyManualScore() {
            const input = document.getElementById('manageTeamScoreInput');
            const val = parseInt(input.value);
            
            if (!isNaN(val) && val !== 0) {
                quickUpdateScore(val); // Ø³ØªØ³ØªØ¯Ø¹ÙŠ saveGameState ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
                input.value = ''; // Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚Ù„ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
            }
        }

        // ** ØªØµÙÙŠØ± Ù†Ù‚Ø§Ø· Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„ÙˆØ§Ø­Ø¯ **
        function resetTeamScore() {
            if (currentManagingTeamIndex === -1) return;
            
            Swal.fire({
                title: 'ØªØµÙÙŠØ± Ù†Ù‚Ø§Ø· Ù‡Ø°Ø§ Ø§Ù„ÙØ±ÙŠÙ‚ØŸ',
                text: `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¹Ø§Ø¯Ø© Ù†Ù‚Ø§Ø· "${TEAM_NAMES[currentManagingTeamIndex]}" Ø¥Ù„Ù‰ 50ØŸ`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Ù†Ø¹Ù…ØŒ ØµÙØ±Ù‡Ø§',
                cancelButtonText: 'ØªØ±Ø§Ø¬Ø¹'
            }).then((result) => {
                if (result.isConfirmed) {
                    gameState.teams[currentManagingTeamIndex] = INITIAL_SCORE;
                    document.getElementById('manageTeamCurrentScore').textContent = INITIAL_SCORE;
                    updateScoreboard();
                    saveGameState(); // Ø­ÙØ¸ ÙÙˆØ±ÙŠ Ù„Ø£Ù† Ù‡Ø°Ø§ Ø¥Ø¬Ø±Ø§Ø¡ Ù†Ù‡Ø§Ø¦ÙŠ
                    Swal.fire('ØªÙ… Ø§Ù„ØªØµÙÙŠØ±', 'Ø¹Ø§Ø¯Øª Ù†Ù‚Ø§Ø· Ø§Ù„ÙØ±ÙŠÙ‚ Ø¥Ù„Ù‰ 50', 'success');
                }
            });
        }

        // ** Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙˆØ¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© **
        function saveTeamManagement() {
            if (currentManagingTeamIndex === -1) return;
            
            // Ø­ÙØ¸ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
            const newName = document.getElementById('manageTeamName').value.trim();
            if (newName) {
                TEAM_NAMES[currentManagingTeamIndex] = newName;
            }

            // Ø­ÙØ¸ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
            if (currentManagingTeamImage) {
                TEAM_IMAGE_URLS[currentManagingTeamIndex] = currentManagingTeamImage;
            }
            
            // (Ø§Ù„Ù†Ù‚Ø§Ø· ØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡Ø§ Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ù…ØµÙÙˆÙØ© gameState Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø²Ø±Ø§Ø±)
            
            // Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
            saveGameState();
            updateScoreboard();
            closeTeamManagementModal();
            
            const Toast = Swal.mixin({
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 1500,
                timerProgressBar: true,
                background: '#10B981',
                color: '#fff'
            });
            Toast.fire({ icon: 'success', title: 'ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª' });
        }

        // ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚ Ø´Ø§Ø´Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
        function toggleSettingsModal(open) {
            const modal = document.getElementById('settingsModal');
            if (open) {
                modal.classList.remove('hidden');
                setTimeout(() => modal.classList.add('active'), 10);
            } else {
                modal.classList.remove('active');
                setTimeout(() => modal.classList.add('hidden'), 300);
            }
        }
        
        // Ø¥Ø¸Ù‡Ø§Ø± ØªØ£Ø«ÙŠØ± Ø§Ù„Ù†Ù‚Ø§Ø·
        function showPointsAnimation(text, color) {
            const animation = document.createElement('div');
            animation.textContent = text;
            animation.className = `fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-6xl font-bold text-${color}-400 points-animation z-50 pointer-events-none`;
            document.body.appendChild(animation);
            
            setTimeout(() => {
                document.body.removeChild(animation);
            }, 2000);
        }
        
        // ØªØµÙÙŠØ± Ø§Ù„Ù†Ù‚Ø§Ø· (ÙŠØªÙ… Ø§Ù„Ø¢Ù† Ø¥Ø¹Ø§Ø¯ØªÙ‡Ø§ Ø¥Ù„Ù‰ 50)
        function resetPoints() {
            Swal.fire({
                title: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ',
                text: "Ø³ÙŠØªÙ… ØªØµÙÙŠØ± Ù†Ù‚Ø§Ø· Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ±Ù‚ Ù„ØªØ¨Ø¯Ø£ Ù…Ù† 50 Ù†Ù‚Ø·Ø©!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Ù†Ø¹Ù…ØŒ ØµÙØ± Ø§Ù„Ù†Ù‚Ø§Ø·!',
                cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'
            }).then((result) => {
                if (result.isConfirmed) {
                    for (let i = 0; i < gameState.teams.length; i++) {
                        gameState.teams[i] = INITIAL_SCORE;
                    }
                    updateScoreboard();
                    showPointsAnimation(`ØªÙ… ØªØµÙÙŠØ± Ø§Ù„Ù†Ù‚Ø§Ø·ØŒ Ø§Ù„ÙƒÙ„ ÙŠØ¨Ø¯Ø£ Ù…Ù† ${INITIAL_SCORE} ğŸŒŠ`, 'red');
                    saveGameState();
                    Swal.fire(
                        'ØªÙ… Ø§Ù„ØªØµÙÙŠØ±!',
                        'Ø¹Ø§Ø¯Øª Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ±Ù‚ Ù„Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©.',
                        'success'
                    )
                }
            })
        }

        // Ø¥Ø¹Ø§Ø¯Ø© ÙØªØ­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø®Ø²Ø§Ø¦Ù†
        function reopenAllBoxes() {
            Swal.fire({
                title: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ',
                text: "Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø¥ØºÙ„Ø§Ù‚ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø®Ø²Ø§Ø¦Ù† Ø§Ù„Ù…ÙØªÙˆØ­Ø©!",
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Ù†Ø¹Ù…ØŒ Ø£Ø¹Ø¯ ÙØªØ­Ù‡Ø§!',
                cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'
            }).then((result) => {
                if (result.isConfirmed) {
                    gameState.openedBoxes.clear();
                    createTreasureGrid();
                    updateReopenBoxSelect();
                    showPointsAnimation('ğŸ—ï¸ ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ÙØªØ­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø®Ø²Ø§Ø¦Ù†', 'blue');
                    saveGameState();
                    Swal.fire(
                        'ØªÙ…Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ©!',
                        'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø®Ø²Ø§Ø¦Ù† Ù…ØºÙ„Ù‚Ø© Ø§Ù„Ø¢Ù† ÙˆØ¬Ø§Ù‡Ø²Ø© Ù„Ù„Ø¹Ø¨.',
                        'success'
                    )
                }
            })
        }

        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø®Ø²Ø§Ø¦Ù† (Ø¨Ù…Ø§ ÙÙŠ Ø°Ù„Ùƒ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª)
        function resetBoxes() {
            Swal.fire({
                title: 'ØªØ­Ø°ÙŠØ± Ù‡Ø§Ù…!',
                text: "Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø³ÙŠØ¹ÙŠØ¯ Ø§Ù„Ù„Ø¹Ø¨Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ø­Ø§Ù„ØªÙ‡Ø§ Ø§Ù„Ø£ØµÙ„ÙŠØ© (Ø§Ù„Ù…ØµÙ†Ø¹). Ø³ØªÙÙ‚Ø¯ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†Ù‚Ø§Ø· ÙˆØ§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Ù†Ø¹Ù…ØŒ ÙØ±Ù…Øª Ø§Ù„Ù„Ø¹Ø¨Ø©!',
                cancelButtonText: 'ØªØ±Ø§Ø¬Ø¹'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ø§Ù„Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
                    gameState.openedBoxes.clear();
                    // ** Ø§Ù„ØªØ­Ø¯ÙŠØ«: Ù†Ù‚Ø§Ø· Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© 50
                    gameState.teams = [INITIAL_SCORE, INITIAL_SCORE, INITIAL_SCORE, INITIAL_SCORE]; 
                    gameState.currentTeam = 0;
                    gameState.numTeams = 3; // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ† Ø¥Ù„Ù‰ 3
                    gameState.treasures = JSON.parse(JSON.stringify(initialTreasureData)); // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø®Ø²Ø§Ø¦Ù† Ø§Ù„Ø£ØµÙ„ÙŠØ© (Ù†Ø³Ø®Ø© Ø¹Ù…ÙŠÙ‚Ø©)
                    TEAM_NAMES = ['Ø§Ù„Ø·Ø§Ù‚Ù… Ø§Ù„Ø£ÙˆÙ„', 'Ø§Ù„Ø·Ø§Ù‚Ù… Ø§Ù„Ø«Ø§Ù†ÙŠ', 'Ø§Ù„Ø·Ø§Ù‚Ù… Ø§Ù„Ø«Ø§Ù„Ø«', 'Ø§Ù„Ø·Ø§Ù‚Ù… Ø§Ù„Ø±Ø§Ø¨Ø¹']; // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ (Ø¨Ø¯ÙˆÙ† Ø¥ÙŠÙ…ÙˆØ¬ÙŠ)
                    
                    document.getElementById('currentTeam').value = 0;
                    
                    updateTeamSelectors();
                    createTreasureGrid();
                    updateReopenBoxSelect();
                    updateScoreboard();
                    showPointsAnimation('âš“ ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„ Ø´ÙŠØ¡', 'yellow');
                    
                    // Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (Ø§Ù„ÙØ§Ø±ØºØ©) ÙÙŠ Ø§Ù„Ù…Ø­Ù„ÙŠ ÙˆØ§Ù„Ø³Ø­Ø§Ø¨ÙŠ
                    saveGameState();
                    
                    Swal.fire(
                        'ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ†!',
                        'Ø¹Ø§Ø¯Øª Ø§Ù„Ù„Ø¹Ø¨Ø© Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµÙ†Ø¹.',
                        'success'
                    )
                }
            })
        }
        
        // Ø¥Ù†Ø´Ø§Ø¡ Ø´Ø¨ÙƒØ© Ø§Ù„Ø®Ø²Ø§Ø¦Ù†
        function createTreasureGrid() {
            const grid = document.getElementById('treasureGrid');
            grid.innerHTML = '';
            
            for (let i = 1; i <= 50; i++) {
                const box = document.createElement('div');
                // Ù†Ø³ØªØ®Ø¯Ù… flex Ù„Ø¬Ø¹Ù„ Ø§Ù„ØµÙˆØ±Ø© ØªÙ…Ù„Ø£ Ø§Ù„Ù…Ø±Ø¨Ø¹
                box.className = `treasure-chest rounded-xl cursor-pointer flex justify-center items-center ${gameState.openedBoxes.has(i) ? 'opened' : ''}`;
                
                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙˆØ±Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ù† Ù…ØµÙÙˆÙØ© TREASURE_IMAGE_URLS
                const imageUrl = TREASURE_IMAGE_URLS[i - 1];
                if (imageUrl) {
                    box.innerHTML = `
                        <img 
                            src="${imageUrl}" 
                            alt="Ø®Ø²Ù†Ø© Ø±Ù‚Ù… ${i}" 
                            class="treasure-chest-image rounded-xl"
                            onerror="this.onerror=null; this.src='https://placehold.co/100x100/374151/FFFFFF?text=${i}'"
                        />
                    `;
                } else {
                    // ÙÙŠ Ø­Ø§Ù„ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø· Ø£Ùˆ ÙƒØ§Ù† ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯
                    box.innerHTML = `
                        <div class="text-center p-4">
                            <div class="text-2xl mb-2 text-red-500">âŒ</div>
                            <div class="font-bold text-amber-100">${i}</div>
                        </div>
                    `;
                }
                
                box.onclick = () => openTreasure(i);
                grid.appendChild(box);
            }
        }

        // ÙØªØ­ Ø§Ù„Ø®Ø²Ù†Ø©
        function openTreasure(boxNumber) {
            if (gameState.openedBoxes.has(boxNumber)) {
                alert('Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø²Ù†Ø© Ù…ÙØªÙˆØ­Ø© Ø¨Ø§Ù„ÙØ¹Ù„!');
                return;
            }

            const treasure = gameState.treasures[boxNumber - 1];
            gameState.openedBoxes.add(boxNumber);
            gameState.currentTreasure = treasure;
            gameState.currentBoxNumber = boxNumber;
            
            saveGameState(); 
            
            document.getElementById('treasureIcon').textContent = treasure.icon;
            document.getElementById('treasureTitle').textContent = `Ø®Ø²Ù†Ø© Ø±Ù‚Ù… ${boxNumber}`;
            document.getElementById('treasureContent').textContent = treasure.content;
            
            // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„ÙØ§ØªØ­ Ù„Ù„Ø®Ø²Ù†Ø©
            const openerDisplay = document.getElementById('openerTeamDisplay');
            if (openerDisplay) {
                const currentTeamIndex = gameState.currentTeam;
                const teamName = TEAM_NAMES[currentTeamIndex];
                const teamImage = TEAM_IMAGE_URLS[currentTeamIndex] || `https://placehold.co/100x100/334155/FFFFFF?text=${currentTeamIndex + 1}`;
                
                document.getElementById('openerTeamImage').src = teamImage;
                document.getElementById('openerTeamName').textContent = teamName;
                openerDisplay.classList.remove('hidden');
            }
            
            document.getElementById('teamSelector').classList.add('hidden');
            document.getElementById('pointsInput').classList.add('hidden');
            document.getElementById('charitySelector').classList.add('hidden');
            
            const pointsElement = document.getElementById('treasurePoints');
            
            if (treasure.points === 'double') {
                pointsElement.textContent = 'ğŸ‰ Ù…Ø¶Ø§Ø¹ÙØ© Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ø­Ø§Ù„ÙŠØ©! ğŸ‰';
                pointsElement.className = 'text-3xl font-bold mb-6 p-4 rounded-xl border-2 border-dashed border-purple-400 text-purple-300 bg-purple-900/30';
            } else if (treasure.points === 'half') {
                pointsElement.textContent = 'ğŸ’” Ø®ØµÙ… Ù†ØµÙ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ø­Ø§Ù„ÙŠØ© ğŸ’”';
                pointsElement.className = 'text-3xl font-bold mb-6 p-4 rounded-xl border-2 border-dashed border-red-400 text-red-300 bg-red-900/30';
            } else if (treasure.points === 'charity') {
                pointsElement.textContent = 'ğŸ’ Ù†Ù‚Ù„ Ù†Ù‚Ø§Ø· Ø¨ÙŠÙ† Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª ğŸ’';
                pointsElement.className = 'text-3xl font-bold mb-6 p-4 rounded-xl border-2 border-dashed border-blue-400 text-blue-300 bg-blue-900/30';
                document.getElementById('charitySelector').classList.remove('hidden');
            } else if (treasure.inputPoints && (treasure.points === 'input_bonus' || treasure.points === 'input_penalty')) {
                if (treasure.points === 'input_bonus') {
                    pointsElement.textContent = 'âœ¨ Ø£Ø¯Ø®Ù„ Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ù‚Ø§Ø· Ù„Ù„Ø¥Ø¶Ø§ÙØ© âœ¨';
                    pointsElement.className = 'text-3xl font-bold mb-6 p-4 rounded-xl border-2 border-dashed border-green-400 text-green-300 bg-green-900/30';
                } else {
                    pointsElement.textContent = 'ğŸ’” Ø£Ø¯Ø®Ù„ Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ù‚Ø§Ø· Ù„Ù„Ø®ØµÙ… ğŸ’”';
                    pointsElement.className = 'text-3xl font-bold mb-6 p-4 rounded-xl border-2 border-dashed border-red-400 text-red-300 bg-red-900/30';
                }
                document.getElementById('pointsInput').classList.remove('hidden');
            } else if (treasure.points === 'attack') {
                pointsElement.textContent = 'âš”ï¸ Ù‡Ø¬ÙˆÙ… Ø¹Ù„Ù‰ ÙØ±ÙŠÙ‚ Ù…Ù†Ø§ÙØ³! âš”ï¸';
                pointsElement.className = 'text-3xl font-bold mb-6 p-4 rounded-xl border-2 border-dashed border-red-500 text-red-300 bg-red-900/30';
                
                // Ø¥Ø¸Ù‡Ø§Ø± ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù‡Ø¬ÙˆÙ…
                const attackConfig = treasure.attackConfig || { maxDamage: 10, cost: 0, type: 'targeted' };
                document.getElementById('attackInterface').classList.remove('hidden');
                
                // Ø¥Ø¹Ø¯Ø§Ø¯ Ø¹Ù†Ø§ØµØ± ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù‡Ø¬ÙˆÙ…
                const attackTargetSelect = document.getElementById('attackTargetSelect');
                attackTargetSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¶Ø­ÙŠØ©...</option>';
                
                // Ù…Ù„Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ù‡Ø¯Ø§Ù (Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø­Ø§Ù„ÙŠ)
                TEAM_NAMES.forEach((name, index) => {
                    if (index !== gameState.currentTeam) {
                        const option = document.createElement('option');
                        option.value = index;
                        option.textContent = name;
                        attackTargetSelect.appendChild(option);
                    }
                });

                // (Ø¬Ø¯ÙŠØ¯) Ø¥Ù†Ø´Ø§Ø¡ Ø´Ø¨ÙƒØ© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù‡Ø¯Ù
                createTeamGrid('attackTargetGrid', 'attackTargetSelect', gameState.currentTeam);


                // Ø¥Ø¹Ø¯Ø§Ø¯ Ø­Ù‚Ù„ Ø§Ù„Ø¶Ø±Ø±
                const damageInput = document.getElementById('attackDamageInput');
                damageInput.max = attackConfig.maxDamage;
                damageInput.placeholder = `Ù…Ù† 1 Ø¥Ù„Ù‰ ${attackConfig.maxDamage}`;
                document.getElementById('attackMaxLabel').textContent = attackConfig.maxDamage;

                // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªÙƒÙ„ÙØ© Ø¥Ù† ÙˆØ¬Ø¯Øª
                const costLabel = document.getElementById('attackCostLabel');
                if (attackConfig.cost > 0) {
                    costLabel.textContent = `(ØªÙƒÙ„ÙØ© Ø§Ù„Ù‡Ø¬ÙˆÙ…: ${attackConfig.cost} Ù†Ù‚Ø·Ø©)`;
                    costLabel.classList.remove('hidden');
                } else {
                    costLabel.classList.add('hidden');
                }

            } else if (treasure.selectTeam && treasure.giveToOther) {
                pointsElement.textContent = `ğŸ Ø¥Ø¹Ø·Ø§Ø¡ ${treasure.points} Ù†Ù‚Ø·Ø© Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø£Ø®Ø±Ù‰ ğŸ`;
                pointsElement.className = 'text-3xl font-bold mb-6 p-4 rounded-xl border-2 border-dashed border-green-400 text-green-300 bg-green-900/30';
                document.getElementById('teamSelector').classList.remove('hidden');
                document.getElementById('penaltyTeamSelect').value = (gameState.currentTeam + 1) % gameState.numTeams; 
                updateGridSelection('penaltyTeamGrid', 'penaltyTeamSelect'); 
            } else if (treasure.inputPoints && (treasure.points === 'variable_penalty_self' || treasure.points === 'variable_penalty_big_self')) {
                let maxPoints = treasure.points === 'variable_penalty_big_self' ? 20 : 10;
                let minPoints = 1;

                if (treasure.points === 'variable_penalty_self' && treasure.penaltyConfig) {
                    minPoints = treasure.penaltyConfig.min || 1;
                    maxPoints = treasure.penaltyConfig.max || 10;
                }

                pointsElement.textContent = `ğŸ’” Ø®ØµÙ… Ù…Ù† ${minPoints} Ø¥Ù„Ù‰ ${maxPoints} Ù†Ù‚Ø§Ø· Ø¹Ù„ÙŠÙƒ ğŸ’”`;
                pointsElement.className = 'text-3xl font-bold mb-6 p-4 rounded-xl border-2 border-dashed border-red-400 text-red-300 bg-red-900/30';
                
                const input = document.getElementById('customPointsInput');
                input.max = maxPoints;
                input.min = minPoints;
                input.placeholder = `Ø¨ÙŠÙ† ${minPoints} Ùˆ ${maxPoints}`;
                
                document.getElementById('pointsInput').classList.remove('hidden');
            } else if (treasure.selectTeam && treasure.inputPoints) {
                pointsElement.textContent = 'âš¡ Ø®ØµÙ… Ù†Ù‚Ø§Ø· Ù…ØªØºÙŠØ±Ø© Ù…Ù† Ù…Ø¬Ù…ÙˆØ¹Ø© Ø£Ø®Ø±Ù‰ âš¡';
                pointsElement.className = 'text-3xl font-bold mb-6 p-4 rounded-xl border-2 border-dashed border-red-400 text-red-300 bg-red-900/30';
                document.getElementById('teamSelector').classList.remove('hidden');
                document.getElementById('pointsInput').classList.remove('hidden');
                document.getElementById('penaltyTeamSelect').value = gameState.currentTeam;
                updateGridSelection('penaltyTeamGrid', 'penaltyTeamSelect');
            } else if (treasure.selectTeam && treasure.points < 0) {
                pointsElement.textContent = `ğŸ’” Ø®ØµÙ… ${Math.abs(treasure.points)} Ù†Ù‚Ø§Ø· Ù…Ù† Ù…Ø¬Ù…ÙˆØ¹Ø© Ø£Ø®Ø±Ù‰ ğŸ’”`;
                pointsElement.className = 'text-3xl font-bold mb-6 p-4 rounded-xl border-2 border-dashed border-red-400 text-red-300 bg-red-900/30';
                document.getElementById('teamSelector').classList.remove('hidden');
                document.getElementById('penaltyTeamSelect').value = gameState.currentTeam;
            } else if (treasure.points > 0) {
                pointsElement.textContent = `+${treasure.points} Ù†Ù‚Ø·Ø© ğŸ‰`;
                pointsElement.className = 'text-3xl font-bold mb-6 p-4 rounded-xl border-2 border-dashed border-green-400 text-green-300 bg-green-900/30';
            } else if (treasure.points < 0) {
                pointsElement.textContent = `${treasure.points} Ù†Ù‚Ø·Ø© ğŸ’”`;
                pointsElement.className = 'text-3xl font-bold mb-6 p-4 rounded-xl border-2 border-dashed border-red-400 text-red-300 bg-red-900/30';
            } else if (treasure.points === 0) {
                pointsElement.textContent = 'â¸ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ù‚Ø§Ø· â¸ï¸';
                pointsElement.className = 'text-3xl font-bold mb-6 p-4 rounded-xl border-2 border-dashed border-gray-400 text-gray-300 bg-gray-900/30';
            }
            
            document.getElementById('pointsEffect').classList.add('hidden');
            document.getElementById('actionButtons').classList.remove('hidden');
            document.getElementById('backButton').classList.add('hidden');
            
            document.getElementById('mainScreen').classList.add('hidden');
            document.getElementById('treasureScreen').classList.remove('hidden');
            
            createTreasureGrid();
            updateReopenBoxSelect();
        }

        // ØªØ·Ø¨ÙŠÙ‚ ØªØ£Ø«ÙŠØ± Ø§Ù„Ù†Ù‚Ø§Ø·
        function applyPointsEffect(points, targetTeam = null, customPoints = null) {
            const pointsElement = document.getElementById('pointsEffect');
            const currentTeam = parseInt(gameState.currentTeam);
            const affectedTeam = targetTeam !== null ? parseInt(targetTeam) : currentTeam;
            const teamNames = TEAM_NAMES;
            
            if (points === 'double') {
                gameState.teams[currentTeam] *= 2;
                pointsElement.textContent = 'ğŸ‰ Ù…Ø¶Ø§Ø¹ÙØ© Ø§Ù„Ù†Ù‚Ø§Ø·! ğŸ‰';
                pointsElement.className = 'text-4xl font-bold mb-6 text-green-400 points-animation';
            } else if (points === 'half') {
                gameState.teams[currentTeam] = Math.floor(gameState.teams[currentTeam] / 2);
                pointsElement.textContent = 'ğŸ’” Ø®ØµÙ… Ù†ØµÙ Ø§Ù„Ù†Ù‚Ø§Ø·! ğŸ’”';
                pointsElement.className = 'text-4xl font-bold mb-6 text-red-400 points-animation';
            } else if (points === 'input_bonus' && customPoints) {
                gameState.teams[currentTeam] += customPoints;
                pointsElement.textContent = `+${customPoints} ğŸ‰`;
                pointsElement.className = 'text-4xl font-bold mb-6 text-green-400 points-animation';
            } else if (points === 'input_penalty' && customPoints) {
                gameState.teams[currentTeam] -= customPoints;
                if (gameState.teams[currentTeam] < 0) gameState.teams[currentTeam] = 0;
                pointsElement.textContent = `-${customPoints} ğŸ’”`;
                pointsElement.className = 'text-4xl font-bold mb-6 text-red-400 points-animation';
            } else if ((points === 'variable_penalty_self' || points === 'variable_penalty_big_self') && customPoints) {
                gameState.teams[currentTeam] -= customPoints;
                if (gameState.teams[currentTeam] < 0) gameState.teams[currentTeam] = 0;
                pointsElement.textContent = `-${customPoints} Ù†Ù‚Ø·Ø© Ø¹Ù„ÙŠÙƒ ğŸ’”`;
                pointsElement.className = 'text-4xl font-bold mb-6 text-red-400 points-animation';
            } else if ((points === 'variable_penalty' || points === 'variable_penalty_big') && customPoints && targetTeam !== null) {
                gameState.teams[affectedTeam] -= customPoints;
                if (gameState.teams[affectedTeam] < 0) gameState.teams[affectedTeam] = 0;
                pointsElement.textContent = `-${customPoints} Ù†Ù‚Ø·Ø© Ù…Ù† ${teamNames[affectedTeam]} ğŸ’”`;
                pointsElement.className = 'text-4xl font-bold mb-6 text-red-400 points-animation';
            } else if (points > 0 && targetTeam !== null && gameState.currentTreasure.giveToOther) {
                gameState.teams[affectedTeam] += points;
                pointsElement.textContent = `+${points} Ù†Ù‚Ø·Ø© Ù„Ù€ ${teamNames[affectedTeam]} ğŸ`;
                pointsElement.className = 'text-4xl font-bold mb-6 text-green-400 points-animation';
            } else if (points > 0) {
                gameState.teams[currentTeam] += points;
                pointsElement.textContent = `+${points} ğŸ‰`;
                pointsElement.className = 'text-4xl font-bold mb-6 text-green-400 points-animation';
            } else if (points < 0) {
                gameState.teams[affectedTeam] += points;
                if (gameState.teams[affectedTeam] < 0) gameState.teams[affectedTeam] = 0;
                
                if (targetTeam !== null) {
                    pointsElement.textContent = `${points} Ù†Ù‚Ø·Ø© Ù…Ù† ${teamNames[affectedTeam]} ğŸ’”`;
                } else {
                    pointsElement.textContent = `${points} ğŸ’”`;
                }
                pointsElement.className = 'text-4xl font-bold mb-6 text-red-400 points-animation';
            } else if (points === 0) {
                pointsElement.textContent = 'â¸ï¸ Ù„Ø§ ØªØºÙŠÙŠØ± ÙÙŠ Ø§Ù„Ù†Ù‚Ø§Ø· â¸ï¸';
                pointsElement.className = 'text-4xl font-bold mb-6 text-gray-400 points-animation';
            }
            
            pointsElement.classList.remove('hidden');
            updateScoreboard();
            saveGameState();
        }

        // ØªØ·Ø¨ÙŠÙ‚ ØªØ£Ø«ÙŠØ± Ø§Ù„ØµØ¯Ù‚Ø©
        function applyCharityEffect(donorTeam, receiverTeam, points) {
            const pointsElement = document.getElementById('pointsEffect');
            const teamNames = TEAM_NAMES;
            
            gameState.teams[donorTeam] -= points;
            gameState.teams[receiverTeam] += points;
            
            if (gameState.teams[donorTeam] < 0) gameState.teams[donorTeam] = 0;
            
            pointsElement.textContent = `ğŸ’ Ù†Ù‚Ù„ ${points} Ù†Ù‚Ø·Ø© Ù…Ù† ${teamNames[donorTeam]} Ø¥Ù„Ù‰ ${teamNames[receiverTeam]} ğŸ’`;
            pointsElement.className = 'text-4xl font-bold mb-6 text-blue-400 points-animation';
            pointsElement.classList.remove('hidden');
            updateScoreboard();
            saveGameState();
        }

        // ØªØ·Ø¨ÙŠÙ‚ ØªØ£Ø«ÙŠØ± Ø§Ù„Ù‡Ø¬ÙˆÙ…
        function applyAttackEffect(attackerTeam, victimTeam, damage, cost) {
            const pointsElement = document.getElementById('pointsEffect');
            const teamNames = TEAM_NAMES;
            
            // Ø®ØµÙ… Ø§Ù„Ø¶Ø±Ø± Ù…Ù† Ø§Ù„Ø¶Ø­ÙŠØ©
            gameState.teams[victimTeam] -= damage;
            if (gameState.teams[victimTeam] < 0) gameState.teams[victimTeam] = 0;
            
            // Ø®ØµÙ… Ø§Ù„ØªÙƒÙ„ÙØ© Ù…Ù† Ø§Ù„Ù…Ù‡Ø§Ø¬Ù… (Ø¥Ù† ÙˆØ¬Ø¯Øª)
            if (cost > 0) {
                gameState.teams[attackerTeam] -= cost;
                if (gameState.teams[attackerTeam] < 0) gameState.teams[attackerTeam] = 0;
            }
            
            // Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù‡Ø¬ÙˆÙ…
            let message = `âš”ï¸ Ù‡Ø¬ÙˆÙ…! ${teamNames[attackerTeam]} Ù‚ØµÙ ${teamNames[victimTeam]} Ø¨Ù€ ${damage} Ù†Ù‚Ø·Ø©!`;
            if (cost > 0) message += ` (Ø¨ØªÙƒÙ„ÙØ© ${cost})`;
            
            pointsElement.textContent = message;
            pointsElement.className = 'text-4xl font-bold mb-6 text-orange-500 points-animation';
            pointsElement.classList.remove('hidden');
            
            updateScoreboard();
            saveGameState();
        }

        // ØªÙ†ÙÙŠØ° Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡
        function executeAction() {
            if (gameState.currentTreasure) {
                let targetTeam = null;
                let customPoints = null;
                
                if (gameState.currentTreasure.points === 'charity') {
                    const donorTeam = parseInt(document.getElementById('donorTeamSelect').value);
                    const receiverTeam = parseInt(document.getElementById('receiverTeamSelect').value || '0');
                    const charityPoints = parseInt(document.getElementById('charityPointsInput').value || '0');
                    
                    if (charityPoints > 0 && donorTeam !== receiverTeam) {
                        applyCharityEffect(donorTeam, receiverTeam, charityPoints);
                    } else {
                        alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ­ÙŠØ­Ø© Ù„Ù„ØµØ¯Ù‚Ø©: Ù†Ù‚Ø§Ø· Ø£ÙƒØ¨Ø± Ù…Ù† ØµÙØ±ØŒ ÙˆÙ…Ø¬Ù…ÙˆØ¹ØªØ§Ù† Ù…Ø®ØªÙ„ÙØªØ§Ù†.');
                        return;
                    }
                } else if (gameState.currentTreasure.points === 'attack') {
                    const targetTeam = parseInt(document.getElementById('attackTargetSelect').value);
                    const damage = parseInt(document.getElementById('attackDamageInput').value);
                    const config = gameState.currentTreasure.attackConfig || { maxDamage: 10, cost: 0 };
                    
                    if (isNaN(targetTeam)) {
                        alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ÙØ±ÙŠÙ‚ Ù„Ù„Ù‡Ø¬ÙˆÙ… Ø¹Ù„ÙŠÙ‡!');
                        return;
                    }
                    if (isNaN(damage) || damage < 1 || damage > config.maxDamage) {
                        alert(`ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ù†Ù‚Ø§Ø· Ø§Ù„Ø¶Ø±Ø± Ø¨ÙŠÙ† 1 Ùˆ ${config.maxDamage}`);
                        return;
                    }

                    // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù‡Ø¬ÙˆÙ…
                    applyAttackEffect(gameState.currentTeam, targetTeam, damage, config.cost);
                } else {
                    if (gameState.currentTreasure.selectTeam) {
                        targetTeam = parseInt(document.getElementById('penaltyTeamSelect').value);
                    }
                    
                    if (gameState.currentTreasure.inputPoints) {
                        customPoints = parseInt(document.getElementById('customPointsInput').value || '0');
                        if (customPoints < 0) { 
                            customPoints = 0;
                        }
                        
                        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª Ù„Ù„Ø®ØµÙ… Ø§Ù„Ø¹Ø´ÙˆØ§Ø¦ÙŠ
                        if (gameState.currentTreasure.points === 'variable_penalty_self' || gameState.currentTreasure.points === 'variable_penalty_big_self') {
                            let minP = 1;
                            let maxP = gameState.currentTreasure.points === 'variable_penalty_big_self' ? 20 : 10;
                            
                            if (gameState.currentTreasure.points === 'variable_penalty_self' && gameState.currentTreasure.penaltyConfig) {
                                minP = gameState.currentTreasure.penaltyConfig.min || 1;
                                maxP = gameState.currentTreasure.penaltyConfig.max || 10;
                            }
                            
                            if (customPoints < minP || customPoints > maxP) {
                                alert(`ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ø¯Ø¯ Ù†Ù‚Ø§Ø· Ø¨ÙŠÙ† ${minP} Ùˆ ${maxP}.`);
                                return;
                            }
                        }
                    }
                    
                    applyPointsEffect(gameState.currentTreasure.points, targetTeam, customPoints);
                }
                
                // Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ†ÙÙŠØ°ØŒ ÙŠØ¬Ø¨ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø´Ø§Ø´Ø©
                document.getElementById('actionButtons').classList.add('hidden');
                document.getElementById('teamSelector').classList.add('hidden');
                document.getElementById('pointsInput').classList.add('hidden');
                document.getElementById('charitySelector').classList.add('hidden');
                document.getElementById('attackInterface').classList.add('hidden');
                document.getElementById('backButton').classList.remove('hidden');
            }
        }

        // Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©: Ø¹Ø¯Ù… ØªÙ†ÙÙŠØ° (ÙŠØºÙ„Ù‚ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ ÙˆÙŠÙ†ØªÙ‚Ù„ Ù„Ù„Ø¯ÙˆØ± Ø§Ù„ØªØ§Ù„ÙŠ Ø¯ÙˆÙ† ØªØ·Ø¨ÙŠÙ‚ Ø£ÙŠ ØªØ£Ø«ÙŠØ±)
        function skipAction() {
            // Ù„Ø§ ÙŠØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø£ÙŠ Ù†Ù‚Ø§Ø· Ø£Ùˆ ØªØ£Ø«ÙŠØ±Ø§Øª
            
            const pointsElement = document.getElementById('pointsEffect');
            pointsElement.textContent = 'ğŸš« Ù„Ù… ÙŠØªÙ… ØªÙ†ÙÙŠØ° Ø§Ù„Ø£Ù…Ø±';
            pointsElement.className = 'text-4xl font-bold mb-6 text-yellow-400';
            pointsElement.classList.remove('hidden');
            
            // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„Ø¹ÙˆØ¯Ø©
            document.getElementById('actionButtons').classList.add('hidden');
            document.getElementById('teamSelector').classList.add('hidden');
            document.getElementById('pointsInput').classList.add('hidden');
            document.getElementById('charitySelector').classList.add('hidden');
            document.getElementById('attackInterface').classList.add('hidden');
            document.getElementById('backButton').classList.remove('hidden');
        }

        // Ø¯Ø§Ù„Ø© Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ (Ø²Ø± Ø§Ù„Ù€ X) - ØªØ²ÙŠÙ„ Ø§Ù„Ø®Ø²Ù†Ø© Ù…Ù† Ø§Ù„Ù…ÙØªÙˆØ­Ø© ÙˆØªØºÙ„Ù‚ Ø§Ù„Ø´Ø§Ø´Ø©
        function cancelAction() {
            if (gameState.currentBoxNumber) {
                // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø®Ø²Ù†Ø© Ø¥Ù„Ù‰ Ø­Ø§Ù„Ø© "ØºÙŠØ± Ù…ÙØªÙˆØ­Ø©"
                gameState.openedBoxes.delete(gameState.currentBoxNumber);
                saveGameState();
                createTreasureGrid();
                updateReopenBoxSelect();
            }
            
            // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø´Ø§Ø´Ø© ÙˆØ§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„ÙØ±ÙŠÙ‚ Ø§Ù„ØªØ§Ù„ÙŠ (Ù…Ø«Ù„ closeTreasure)
            closeTreasure(true); // Ù†Ù…Ø±Ø± true Ù„ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„ØªØ§Ù„ÙŠ
            showPointsAnimation('âŒ ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ ÙˆØ¥Ø¹Ø§Ø¯Ø© ÙØªØ­ Ø§Ù„Ø®Ø²Ù†Ø©', 'red');
        }

        // Ø¥ØºÙ„Ø§Ù‚ Ø´Ø§Ø´Ø© Ø§Ù„Ø®Ø²Ù†Ø© (Close Treasure)
        function closeTreasure(shouldGoToNextTeam = true) {
            document.getElementById('treasureScreen').classList.add('hidden');
            document.getElementById('mainScreen').classList.remove('hidden');
            document.getElementById('pointsEffect').classList.add('hidden');
            
            gameState.currentTreasure = null;
            gameState.currentBoxNumber = null;
            
            if (shouldGoToNextTeam) {
                gameState.currentTeam = (gameState.currentTeam + 1) % gameState.numTeams; 
                document.getElementById('currentTeam').value = gameState.currentTeam;
            }
            
            updateScoreboard();
            saveGameState();
        }

        // Ø¥Ø¶Ø§ÙØ© Ù†Ù‚Ø§Ø· ÙŠØ¯ÙˆÙŠØ§Ù‹
        function addPoints() {
            const pointsInput = document.getElementById('addPointsInput');
            const points = parseInt(pointsInput.value || '0');
            if (points > 0) {
                const teamIndex = parseInt(document.getElementById('currentTeam').value);
                gameState.teams[teamIndex] += points;
                updateScoreboard();
                
                showPointsAnimation(`+${points}`, 'green');
                
                pointsInput.value = '';
                saveGameState();
            } else {
                alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ø¯Ø¯ ØµØ­ÙŠØ­ Ù…ÙˆØ¬Ø¨ Ù…Ù† Ø§Ù„Ù†Ù‚Ø§Ø·');
            }
        }

        // Ø®ØµÙ… Ù†Ù‚Ø§Ø· ÙŠØ¯ÙˆÙŠØ§Ù‹
        function subtractPoints() {
            const pointsInput = document.getElementById('subtractPointsInput');
            const points = parseInt(pointsInput.value || '0');
            if (points > 0) {
                const teamIndex = parseInt(document.getElementById('currentTeam').value);
                gameState.teams[teamIndex] -= points;
                if (gameState.teams[teamIndex] < 0) gameState.teams[teamIndex] = 0;
                updateScoreboard();
                
                showPointsAnimation(`-${points}`, 'red');
                
                pointsInput.value = '';
                saveGameState();
            } else {
                alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ø¯Ø¯ ØµØ­ÙŠØ­ Ù…ÙˆØ¬Ø¨ Ù…Ù† Ø§Ù„Ù†Ù‚Ø§Ø·');
            }
        }

        // Ø¥Ø¹Ø§Ø¯Ø© ÙØªØ­ ØµÙ†Ø¯ÙˆÙ‚ Ù…Ø­Ø¯Ø¯
        function reopenBox() {
            const selectElement = document.getElementById('reopenBoxSelect');
            const boxNumber = parseInt(selectElement.value);
            
            if (boxNumber && gameState.openedBoxes.has(boxNumber)) {
                gameState.openedBoxes.delete(boxNumber);
                createTreasureGrid();
                updateReopenBoxSelect();
                selectElement.value = '';
                
                showPointsAnimation(`ğŸ—ï¸ ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ÙØªØ­ Ø§Ù„Ø®Ø²Ù†Ø© ${boxNumber}`, 'blue');
                saveGameState();
            } else if (boxNumber) {
                alert('Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø²Ù†Ø© ØºÙŠØ± Ù…ÙØªÙˆØ­Ø© Ø£ØµÙ„Ø§Ù‹!');
            } else {
                alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø®Ø²Ù†Ø© Ù„Ø¥Ø¹Ø§Ø¯Ø© ÙØªØ­Ù‡Ø§');
            }
        }

        // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØµÙ†Ø§Ø¯ÙŠÙ‚ Ø§Ù„Ù…ÙØªÙˆØ­Ø©
        function updateReopenBoxSelect() {
            const select = document.getElementById('reopenBoxSelect');
            select.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø®Ø²Ù†Ø©</option>';
            
            Array.from(gameState.openedBoxes).sort((a, b) => a - b).forEach(boxNumber => {
                const option = document.createElement('option');
                option.value = boxNumber;
                option.textContent = `Ø®Ø²Ù†Ø© ${boxNumber}`;
                select.appendChild(option);
            });
        }
        
        // === ÙˆØ¸Ø§Ø¦Ù Ù…Ø­Ø±Ø± Ø§Ù„Ø®Ø²Ø§Ø¦Ù† Ø§Ù„Ù…Ø·ÙˆØ± ===
        
        // ÙØªØ­ Ù…Ø­Ø±Ø± Ø§Ù„Ø®Ø²Ø§Ø¦Ù†
        function openTreasureEditor() {
            document.getElementById('treasureEditor').classList.remove('hidden');
            createEditorBoxGrid();
        }

        // Ø¥ØºÙ„Ø§Ù‚ Ù…Ø­Ø±Ø± Ø§Ù„Ø®Ø²Ø§Ø¦Ù†
        function closeTreasureEditor() {
            document.getElementById('treasureEditor').classList.add('hidden');
            editorState.selectedBox = null;
            document.getElementById('selectedBoxDisplay').textContent = '#00';
            document.getElementById('editForm').classList.add('hidden');
            document.getElementById('noSelection').classList.remove('hidden');
        }

        // Ø¥Ù†Ø´Ø§Ø¡ Ø´Ø¨ÙƒØ© Ø§Ù„Ø®Ø²Ø§Ø¦Ù† ÙÙŠ Ø§Ù„Ù…Ø­Ø±Ø± (Ù†Ø³Ø®Ø© Ù…Ø­Ø¯Ø«Ø©)
        function createEditorBoxGrid() {
            const container = document.getElementById('editorGrid');
            container.innerHTML = '';
            
            for (let i = 1; i <= 50; i++) {
                const boxIndex = i - 1;
                const isModified = JSON.stringify(gameState.treasures[boxIndex]) !== JSON.stringify(initialTreasureData[boxIndex]);
                    const isSelected = editorState.selectedBox === i;

                const button = document.createElement('button');
                button.className = `
                    relative h-10 w-full rounded-lg font-bold text-sm transition-all duration-200
                    ${isSelected 
                        ? 'bg-cyan-500 text-white shadow-[0_0_15px_rgba(6,182,212,0.6)] scale-105 border-2 border-white z-10' 
                        : 'bg-slate-700 hover:bg-slate-600 text-slate-300 border border-slate-600'}
                `;
                
                // Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ (Ù†Ù‚Ø·Ø© Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠØ©)
                if (isModified) {
                    button.innerHTML = `${i}<span class="absolute top-1 right-1 w-2 h-2 bg-amber-500 rounded-full"></span>`;
                } else {
                    button.textContent = i;
                }

                button.onclick = () => selectBoxForEdit(i);
                container.appendChild(button);
            }
        }

        // Ø§Ø®ØªÙŠØ§Ø± Ø®Ø²Ù†Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„
        function selectBoxForEdit(boxNumber) {
            editorState.selectedBox = boxNumber;
            document.getElementById('selectedBoxDisplay').textContent = `#${boxNumber.toString().padStart(2, '0')}`;
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ø¨ÙƒØ© Ù„ØªØ¹ÙƒØ³ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯
            createEditorBoxGrid();
            
            loadTreasureData(boxNumber);
            
            document.getElementById('editForm').classList.remove('hidden');
            document.getElementById('noSelection').classList.add('hidden');
        }

        // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®Ø²Ù†Ø©
        function loadTreasureData(boxNumber) {
            const treasure = gameState.treasures[boxNumber - 1];
            
            // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù†ØµÙŠØ©
            document.getElementById('editIcon').value = treasure.icon || '';
            document.getElementById('selectedEmojiDisplay').textContent = treasure.icon || 'â“';
            document.getElementById('editTitle').value = treasure.title || '';
            document.getElementById('editContent').value = treasure.content || '';
            
            // ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ (Radio Buttons)
            const type = treasure.type || 'bonus';
            const radio = document.querySelector(`input[name="contentType"][value="${type === 'neutral' ? 'other' : type}"]`);
            if (radio) radio.checked = true;
            else document.querySelector('input[name="contentType"][value="other"]').checked = true; // Default fallback

            // ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„Ù†Ù‚Ø§Ø· ÙˆØ§Ù„Ù‚ÙŠÙ…Ø©
            let pointsType = 'fixed';
            if (treasure.points === 'double') pointsType = 'double';
            else if (treasure.points === 'half') pointsType = 'half';
            else if (treasure.points === 'input_bonus') pointsType = 'input_bonus';
            else if (treasure.points === 'input_penalty') pointsType = 'input_penalty';
            else if (treasure.points === 'variable_penalty_self') pointsType = 'variable_penalty_self';
            else if (treasure.points === 'charity') pointsType = 'charity';
            else if (treasure.points === 'attack') pointsType = 'attack';
            
            document.getElementById('editPointsType').value = pointsType;

            // ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù‡Ø¬ÙˆÙ… Ø¥Ø°Ø§ ÙˆØ¬Ø¯Øª
            if (pointsType === 'attack' && treasure.attackConfig) {
                document.getElementById('attackMaxDamage').value = treasure.attackConfig.maxDamage || 10;
                document.getElementById('attackCost').value = treasure.attackConfig.cost || 0;
                document.getElementById('attackType').value = treasure.attackConfig.type || 'targeted';
            }

            // ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø®ØµÙ… Ø§Ù„Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ø¥Ø°Ø§ ÙˆØ¬Ø¯Øª
            if (pointsType === 'variable_penalty_self' && treasure.penaltyConfig) {
                document.getElementById('penaltyMin').value = treasure.penaltyConfig.min || 1;
                document.getElementById('penaltyMax').value = treasure.penaltyConfig.max || 10;
            }
            
            if (typeof treasure.points === 'number' && pointsType === 'fixed') {
                 document.getElementById('editPointsValue').value = treasure.points;
            } else {
                 document.getElementById('editPointsValue').value = '';
            }

            updateFormVisibility(); // ØªØ­Ø¯ÙŠØ« Ø¸Ù‡ÙˆØ± Ø§Ù„Ø­Ù‚ÙˆÙ„
            updatePreviewCard();    // ØªØ­Ø¯ÙŠØ« Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
            updatePointsFeedback(); // ØªØ­Ø¯ÙŠØ« ØªØºØ°ÙŠØ© Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ø±Ø§Ø¬Ø¹Ø©
        }

        // ØªØ­Ø¯ÙŠØ« Ø¸Ù‡ÙˆØ± Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±Ø§Øª
        function updateFormVisibility() {
            const pointsType = document.getElementById('editPointsType').value;
            const pointsContainer = document.getElementById('pointsValueContainer');
            const attackSettings = document.getElementById('attackSettingsContainer');
            const penaltySettings = document.getElementById('penaltySettingsContainer');
            const descContainer = document.getElementById('pointsTypeDescription');
            
            // ØªØ­Ø¯ÙŠØ« ÙˆØµÙ Ø§Ù„Ø¢Ù„ÙŠØ©
            let description = '';
            switch(pointsType) {
                case 'fixed': description = 'ØªÙ…Ù†Ø­ Ø£Ùˆ ØªØ®ØµÙ… Ø¹Ø¯Ø¯Ø§Ù‹ Ù…Ø­Ø¯Ø¯Ø§Ù‹ Ù…Ù† Ø§Ù„Ù†Ù‚Ø§Ø· Ù„Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø°ÙŠ ÙŠÙØªØ­ Ø§Ù„Ø®Ø²Ù†Ø©.'; break;
                case 'double': description = 'ØªÙ‚ÙˆÙ… Ø¨Ù…Ø¶Ø§Ø¹ÙØ© (Ã—2) Ù†Ù‚Ø§Ø· Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø­Ø§Ù„ÙŠ.'; break;
                case 'half': description = 'ØªÙ‚ÙˆÙ… Ø¨Ø®ØµÙ… Ù†ØµÙ (Ã·2) Ù†Ù‚Ø§Ø· Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø­Ø§Ù„ÙŠ.'; break;
                case 'input_bonus': description = 'ØªØ·Ù„Ø¨ Ù…Ù† Ø§Ù„ÙƒØ§Ø¨ØªÙ† Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ø¯Ø¯ Ù†Ù‚Ø§Ø· Ù…Ø¹ÙŠÙ† ÙŠØ¯ÙˆÙŠØ§Ù‹ Ù„ÙŠØªÙ… Ø¥Ø¶Ø§ÙØªÙ‡ Ù„Ù„ÙØ±ÙŠÙ‚.'; break;
                case 'input_penalty': description = 'ØªØ·Ù„Ø¨ Ù…Ù† Ø§Ù„ÙƒØ§Ø¨ØªÙ† Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ø¯Ø¯ Ù†Ù‚Ø§Ø· Ù…Ø¹ÙŠÙ† ÙŠØ¯ÙˆÙŠØ§Ù‹ Ù„ÙŠØªÙ… Ø®ØµÙ…Ù‡ Ù…Ù† Ø§Ù„ÙØ±ÙŠÙ‚.'; break;
                case 'attack': description = 'ØªØ³Ù…Ø­ Ù„Ù„ÙØ±ÙŠÙ‚ Ø¨Ø§Ø®ØªÙŠØ§Ø± ÙØ±ÙŠÙ‚ Ø¢Ø®Ø± Ù„Ù„Ù‡Ø¬ÙˆÙ… Ø¹Ù„ÙŠÙ‡ ÙˆØ®ØµÙ… Ù†Ù‚Ø§Ø· Ù…Ù†Ù‡.'; break;
                case 'variable_penalty_self': description = 'ØªÙ‚ÙˆÙ… Ø¨Ø®ØµÙ… Ø¹Ø¯Ø¯ Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ù…Ù† Ø§Ù„Ù†Ù‚Ø§Ø· (ÙŠØ­Ø¯Ø¯Ù‡ Ø§Ù„Ù†Ø¸Ø§Ù…) Ù…Ù† Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø°ÙŠ ÙØªØ­ Ø§Ù„Ø®Ø²Ù†Ø©.'; break;
                case 'charity': description = 'ØªØ³Ù…Ø­ Ù„Ù„ÙØ±ÙŠÙ‚ Ø¨Ù†Ù‚Ù„ Ø¬Ø²Ø¡ Ù…Ù† Ù†Ù‚Ø§Ø·Ù‡ Ø¥Ù„Ù‰ ÙØ±ÙŠÙ‚ Ø¢Ø®Ø± (ØµØ¯Ù‚Ø©) Ø¨Ø§Ø®ØªÙŠØ§Ø±Ù‡.'; break;
            }
            
            if(descContainer) {
                descContainer.textContent = description;
                descContainer.classList.remove('hidden');
            }

            // Ø¥Ø¯Ø§Ø±Ø© Ø¸Ù‡ÙˆØ± Ø­Ù‚Ù„ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ø«Ø§Ø¨ØªØ©
            if (pointsType === 'fixed') {
                pointsContainer.classList.remove('hidden');
            } else {
                pointsContainer.classList.add('hidden');
            }

            // Ø¥Ø¯Ø§Ø±Ø© Ø¸Ù‡ÙˆØ± Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù‡Ø¬ÙˆÙ…
            if (pointsType === 'attack') {
                attackSettings.classList.remove('hidden');
            } else {
                attackSettings.classList.add('hidden');
            }

            // Ø¥Ø¯Ø§Ø±Ø© Ø¸Ù‡ÙˆØ± Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø®ØµÙ… Ø§Ù„Ø¹Ø´ÙˆØ§Ø¦ÙŠ
            if (pointsType === 'variable_penalty_self') {
                penaltySettings.classList.remove('hidden');
            } else {
                penaltySettings.classList.add('hidden');
            }

            updatePreviewCard();
            if(typeof updatePointsFeedback === 'function') updatePointsFeedback();
        }

        // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ø­Ø¯Ø« Ù„ØªØºÙŠÙŠØ± Ù†ÙˆØ¹ Ø§Ù„Ù†Ù‚Ø§Ø·
        const pointsTypeSelect = document.getElementById('editPointsType');
        if(pointsTypeSelect) {
            pointsTypeSelect.addEventListener('change', updateFormVisibility);
        }

        // ØªØ­Ø¯ÙŠØ« Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø­ÙŠØ©
        function updatePreviewCard() {
            const icon = document.getElementById('editIcon').value || 'â“';
            const title = document.getElementById('editTitle').value || 'Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø®Ø²Ù†Ø©';
            const content = document.getElementById('editContent').value || 'Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø®Ø²Ù†Ø©...';
            
            document.getElementById('previewIcon').textContent = icon;
            document.getElementById('previewTitle').textContent = title;
            document.getElementById('previewContent').textContent = content;

            // ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØªØ£Ø«ÙŠØ±
            const pointsType = document.getElementById('editPointsType').value;
            const pointsValue = parseInt(document.getElementById('editPointsValue').value || '0');
            const previewEffect = document.getElementById('previewEffect');
            
            let effectText = '';
            let effectClass = '';
            
            if (pointsType === 'fixed') {
                if (pointsValue > 0) {
                    effectText = `+${pointsValue} Ù†Ù‚Ø·Ø© ğŸ‰`;
                    effectClass = 'border-green-400 text-green-300 bg-green-900/30';
                } else if (pointsValue < 0) {
                    effectText = `${pointsValue} Ù†Ù‚Ø·Ø© ğŸ’”`;
                    effectClass = 'border-red-400 text-red-300 bg-red-900/30';
                } else {
                    effectText = 'â¸ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ù‚Ø§Ø· â¸ï¸';
                    effectClass = 'border-gray-400 text-gray-300 bg-gray-900/30';
                }
            } else if (pointsType === 'double') {
                effectText = 'ğŸ‰ Ù…Ø¶Ø§Ø¹ÙØ© Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ø­Ø§Ù„ÙŠØ©! ğŸ‰';
                effectClass = 'border-purple-400 text-purple-300 bg-purple-900/30';
            } else if (pointsType === 'half') {
                effectText = 'ğŸ’” Ø®ØµÙ… Ù†ØµÙ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ø­Ø§Ù„ÙŠØ© ğŸ’”';
                effectClass = 'border-red-400 text-red-300 bg-red-900/30';
            } else if (pointsType === 'charity') {
                effectText = 'ğŸ’ Ù†Ù‚Ù„ Ù†Ù‚Ø§Ø· Ø¨ÙŠÙ† Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª ğŸ’';
                effectClass = 'border-blue-400 text-blue-300 bg-blue-900/30';
            } else if (pointsType === 'attack') {
                effectText = 'âš”ï¸ Ù‡Ø¬ÙˆÙ… Ø¹Ù„Ù‰ ÙØ±ÙŠÙ‚ Ù…Ù†Ø§ÙØ³! âš”ï¸';
                effectClass = 'border-red-500 text-red-300 bg-red-900/30';
            } else if (pointsType === 'input_bonus') {
                effectText = 'âœ¨ Ø£Ø¯Ø®Ù„ Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ù‚Ø§Ø· Ù„Ù„Ø¥Ø¶Ø§ÙØ© âœ¨';
                effectClass = 'border-green-400 text-green-300 bg-green-900/30';
            } else if (pointsType === 'input_penalty') {
                effectText = 'ğŸ’” Ø£Ø¯Ø®Ù„ Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ù‚Ø§Ø· Ù„Ù„Ø®ØµÙ… ğŸ’”';
                effectClass = 'border-red-400 text-red-300 bg-red-900/30';
            } else if (pointsType === 'variable_penalty_self') {
                const min = document.getElementById('penaltyMin').value || 1;
                const max = document.getElementById('penaltyMax').value || 10;
                effectText = `ğŸ’” Ø®ØµÙ… Ù…Ù† ${min} Ø¥Ù„Ù‰ ${max} Ù†Ù‚Ø§Ø· Ø¹Ù„ÙŠÙƒ ğŸ’”`;
                effectClass = 'border-red-400 text-red-300 bg-red-900/30';
            }

            if (effectText) {
                previewEffect.textContent = effectText;
                previewEffect.className = `text-center text-[10px] font-bold p-2 rounded border-2 border-dashed mt-2 ${effectClass}`;
                previewEffect.classList.remove('hidden');
            } else {
                previewEffect.classList.add('hidden');
            }
        }

        // Ø¯Ø§Ù„Ø© Debounce Ù„ØªØ£Ø®ÙŠØ± Ø§Ù„ØªÙ†ÙÙŠØ° (Ù„Ù„Ø£Ø¯Ø§Ø¡)
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Ø¯Ø§Ù„Ø© Ø§Ù„Ø­ÙØ¸ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ (Debounced Save)
        // ØªÙ‚ÙˆÙ… Ø¨Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ/Ø§Ù„Ù…Ø­Ù„ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„ØªÙˆÙ‚Ù Ø¹Ù† Ø§Ù„ÙƒØªØ§Ø¨Ø© Ù„Ù…Ø¯Ø© Ø«Ø§Ù†ÙŠØ© ÙˆÙ†ØµÙ
        const debouncedSave = debounce(() => {
            saveGameState();
            createEditorBoxGrid(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ø¨ÙƒØ© (Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª)
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø¤Ø´Ø± Ø­ÙØ¸ ØµØºÙŠØ± ØºÙŠØ± Ù…Ø²Ø¹Ø¬
            const indicator = document.getElementById('autoSaveIndicator');
            if (indicator) {
                indicator.classList.remove('opacity-0');
                setTimeout(() => indicator.classList.add('opacity-0'), 2000);
            }
        }, 1500);

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø© (Memory) ÙÙˆØ±Ø§Ù‹
        function updateTreasureInMemory() {
            if (!editorState.selectedBox) return;
            
            const boxIndex = editorState.selectedBox - 1;
            const treasure = gameState.treasures[boxIndex];
            
            // Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù‚ÙŠÙ… ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒØ§Ø¦Ù† Ù…Ø¨Ø§Ø´Ø±Ø©
            treasure.icon = document.getElementById('editIcon').value || 'ğŸ´â€â˜ ï¸';
            treasure.title = document.getElementById('editTitle').value || `Ø®Ø²Ù†Ø© Ø±Ù‚Ù… ${editorState.selectedBox}`;
            treasure.content = document.getElementById('editContent').value || 'Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø®Ø²Ù†Ø©';
            
            const selectedType = document.querySelector('input[name="contentType"]:checked')?.value || 'bonus';
            treasure.type = selectedType === 'other' ? 'neutral' : selectedType;
            
            const pointsType = document.getElementById('editPointsType').value;
            const pointsValue = parseInt(document.getElementById('editPointsValue').value || '0');
            
            if (pointsType === 'fixed') {
                treasure.points = pointsValue;
            } else if (pointsType === 'attack') {
                treasure.points = 'attack';
                treasure.attackConfig = {
                    maxDamage: parseInt(document.getElementById('attackMaxDamage').value) || 10,
                    cost: parseInt(document.getElementById('attackCost').value) || 0,
                    type: document.getElementById('attackType').value || 'targeted'
                };
            } else if (pointsType === 'variable_penalty_self') {
                treasure.points = 'variable_penalty_self';
                treasure.penaltyConfig = {
                    min: parseInt(document.getElementById('penaltyMin').value) || 1,
                    max: parseInt(document.getElementById('penaltyMax').value) || 10
                };
            } else {
                treasure.points = pointsType;
            }
            
            // Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ
            treasure.selectTeam = false;
            treasure.inputPoints = false;
            treasure.giveToOther = false;
            
            if (treasure.type === 'gift') {
                treasure.selectTeam = true;
                treasure.giveToOther = true;
            } else if (treasure.type === 'penalty' && typeof treasure.points === 'number' && treasure.points < 0) {
                treasure.selectTeam = true;
            } else if (pointsType.includes('input')) {
                treasure.inputPoints = true;
            } else if (pointsType === 'variable_penalty_self') {
                treasure.inputPoints = true; 
            } else if (pointsType === 'charity') {
                treasure.selectTeam = true;
                treasure.inputPoints = true;
            }
        }

        // Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª (Auto-Save Handler)
        function handleAutoSave() {
            updatePreviewCard();      // 1. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© ÙÙˆØ±Ø§Ù‹ (Ø¨ØµØ±ÙŠ)
            updateTreasureInMemory(); // 2. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø© ÙÙˆØ±Ø§Ù‹ (Ù…Ù†Ø·Ù‚)
            debouncedSave();          // 3. Ø¬Ø¯ÙˆÙ„Ø© Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø¯Ø§Ø¦Ù… (Ø£Ø¯Ø§Ø¡)
        }

        // Ø±Ø¨Ø· Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ù„Ù„Ø­ÙØ¸ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
        ['editIcon', 'editTitle', 'editContent', 'editPointsType', 'editPointsValue', 'attackMaxDamage', 'attackCost', 'attackType', 'penaltyMin', 'penaltyMax'].forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… input Ù„Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙÙˆØ±ÙŠ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ÙƒØªØ§Ø¨Ø©
                el.addEventListener('input', handleAutoSave);
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… change Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¹Ù†Ø¯ ÙÙ‚Ø¯Ø§Ù† Ø§Ù„ØªØ±ÙƒÙŠØ² Ø£Ùˆ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
                el.addEventListener('change', handleAutoSave);
            }
        });

        // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„ØªØºÙŠÙŠØ±Ø§Øª Ù†ÙˆØ¹ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ (Radio Buttons)
        document.querySelectorAll('input[name="contentType"]').forEach(radio => {
            radio.addEventListener('change', handleAutoSave);
        });

        // Ø­ÙØ¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø®Ø²Ù†Ø© (Ù„Ù… ÙŠØ¹Ø¯ Ù…Ø·Ù„ÙˆØ¨Ø§Ù‹ ÙƒØ²Ø±ØŒ Ù„ÙƒÙ† Ù†Ø¨Ù‚ÙŠÙ‡ ÙƒØ¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ø¥Ø°Ø§ Ø§Ø­ØªØ¬Ù†Ø§ Ù„Ø­ÙØ¸ ÙÙˆØ±ÙŠ)
        function saveTreasureEdit() {
            updateTreasureInMemory();
            saveGameState();
            createEditorBoxGrid();
        }

        // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø®Ø²Ù†Ø© Ù„Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©
        function resetToDefault() {
            if (!editorState.selectedBox) return;
            
            Swal.fire({
                title: 'Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø£ØµÙ„ÙŠØŸ',
                text: "Ø³ÙŠØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¹Ù„Ù‰ Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø²Ù†Ø© ÙÙ‚Ø·",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Ù†Ø¹Ù…ØŒ Ø§Ø³ØªØ¹Ø¯Ù‡Ø§',
                cancelButtonText: 'ØªØ±Ø§Ø¬Ø¹',
                background: '#1e293b',
                color: '#fff'
            }).then((result) => {
                if (result.isConfirmed) {
                    const boxIndex = editorState.selectedBox - 1;
                    const originalTreasure = initialTreasureData[boxIndex]; 
                    
                    if (originalTreasure) {
                        gameState.treasures[boxIndex] = JSON.parse(JSON.stringify(originalTreasure));
                        loadTreasureData(editorState.selectedBox);
                        saveGameState(); 
                        createEditorBoxGrid();
                        
                        Swal.fire({
                            icon: 'success',
                            title: 'ØªÙ…Øª Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©',
                            timer: 1000,
                            showConfirmButton: false,
                            background: '#1e293b',
                            color: '#fff'
                        });
                    }
                }
            });
        }

        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        document.addEventListener('DOMContentLoaded', () => {
            // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø°ÙƒÙŠØ© Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† initGame Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø©
            initGameWithCloud();

            // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ø­Ø¯Ø« Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ±Ù‡ ÙŠØ¯ÙˆÙŠØ§Ù‹
            const currentTeamSelect = document.getElementById('currentTeam');
            if (currentTeamSelect) {
                currentTeamSelect.addEventListener('change', (e) => {
                    gameState.currentTeam = parseInt(e.target.value);
                    saveGameState();
                });
            }
        });

        // ---------------------------------------------------------
        // Ø¯ÙˆØ§Ù„ Ø¥Ø¯Ø§Ø±Ø© Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„Ø­ÙØ¸ (Save Slots)
        // ---------------------------------------------------------

        function openSaveSlotsModal() {
            renderSaveSlots();
            document.getElementById('saveSlotsModal').classList.remove('hidden');
        }

        function renderSaveSlots() {
            const container = document.getElementById('slotsContainer');
            container.innerHTML = '';
            
            // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ
            let slots = [];
            try {
                slots = JSON.parse(localStorage.getItem(SAVE_SLOTS_KEY)) || [null, null, null];
            } catch (e) {
                slots = [null, null, null];
            }

            // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ 3 ÙØªØ­Ø§Øª
            if (slots.length < 3) {
                while(slots.length < 3) slots.push(null);
            }

            slots.forEach((slot, index) => {
                const slotEl = document.createElement('div');
                
                if (!slot) {
                    // ÙØªØ­Ø© ÙØ§Ø±ØºØ©
                    slotEl.className = 'bg-slate-800/50 border-2 border-dashed border-slate-600 rounded-2xl p-6 flex flex-col items-center justify-center gap-4 min-h-[250px] group hover:border-indigo-500 hover:bg-slate-800 transition-all cursor-pointer';
                    slotEl.innerHTML = `
                        <div class="w-16 h-16 rounded-full bg-slate-700 flex items-center justify-center group-hover:bg-indigo-500/20 transition-colors">
                            <span class="text-3xl text-slate-400 group-hover:text-indigo-400">+</span>
                        </div>
                        <h3 class="text-slate-400 font-bold text-lg">ÙØªØ­Ø© ÙØ§Ø±ØºØ© ${index + 1}</h3>
                        <button onclick="saveToSlot(${index})" class="mt-2 bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg font-bold transition-colors">
                            Ø­ÙØ¸ Ù‡Ù†Ø§
                        </button>
                    `;
                } else {
                    // ÙØªØ­Ø© Ù…Ø´ØºÙˆÙ„Ø©
                    const date = new Date(slot.timestamp).toLocaleDateString('ar-SA');
                    const time = new Date(slot.timestamp).toLocaleTimeString('ar-SA', {hour: '2-digit', minute:'2-digit'});
                    
                    // Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø³Ø±ÙŠØ¹Ø©
                    const penalties = slot.treasures.filter(t => t.type === 'penalty').length;
                    const gifts = slot.treasures.filter(t => t.type === 'gift').length;
                    
                    slotEl.className = 'bg-gradient-to-br from-slate-800 to-slate-900 border border-amber-500/30 rounded-2xl p-6 flex flex-col min-h-[250px] relative overflow-hidden group hover:border-amber-500 transition-all shadow-lg';
                    slotEl.innerHTML = `
                        <div class="absolute top-0 right-0 bg-amber-500 text-slate-900 text-xs font-bold px-3 py-1 rounded-bl-xl">
                            ${index + 1}
                        </div>
                        
                        <div class="mb-4">
                            <h3 class="text-amber-300 font-bold text-xl mb-1 truncate" title="${slot.name}">${slot.name}</h3>
                            <p class="text-slate-400 text-xs">${date} - ${time}</p>
                        </div>
                        
                        <div class="flex-1">
                            <div class="flex gap-2 text-xs text-slate-300 mb-4 bg-slate-800 p-2 rounded-lg">
                                <span title="Ø¹Ù‚ÙˆØ¨Ø§Øª">ğŸ’” ${penalties}</span>
                                <span title="Ù‡Ø¯Ø§ÙŠØ§">ğŸ ${gifts}</span>
                                <span title="Ø£Ø®Ø±Ù‰">âš¡ ${50 - penalties - gifts}</span>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-3 mt-4">
                            <button onclick="loadFromSlot(${index})" class="bg-emerald-600 hover:bg-emerald-700 text-white py-2 rounded-lg font-bold text-sm transition-colors flex items-center justify-center gap-2">
                                <span>ğŸ“‚</span> ØªØ­Ù…ÙŠÙ„
                            </button>
                            <button onclick="saveToSlot(${index})" class="bg-slate-700 hover:bg-slate-600 text-white py-2 rounded-lg font-bold text-sm transition-colors border border-slate-600">
                                <span>ğŸ’¾</span> Ø§Ø³ØªØ¨Ø¯Ø§Ù„
                            </button>
                        </div>
                    `;
                }
                
                container.appendChild(slotEl);
            });
        }

        function saveToSlot(index) {
            // Ø·Ù„Ø¨ Ø§Ø³Ù… Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
            Swal.fire({
                title: 'Ø­ÙØ¸ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬',
                input: 'text',
                inputLabel: 'Ø§Ø®ØªØ± Ø§Ø³Ù…Ø§Ù‹ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬',
                inputValue: `Ù†Ù…ÙˆØ°Ø¬ ${index + 1} - ${new Date().toLocaleDateString('ar-SA')}`,
                showCancelButton: true,
                confirmButtonText: 'Ø­ÙØ¸',
                cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡',
                background: '#1e293b',
                color: '#fff',
                confirmButtonColor: '#4f46e5',
                cancelButtonColor: '#ef4444',
                inputValidator: (value) => {
                    if (!value) {
                        return 'Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ø§Ø³Ù…!';
                    }
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const name = result.value;
                    
                    // ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                    const saveData = {
                        name: name,
                        timestamp: new Date().toISOString(),
                        treasures: gameState.treasures, // Ù†Ø­ÙØ¸ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø²Ø§Ø¦Ù† Ø§Ù„Ø­Ø§Ù„ÙŠØ©
                        teamImages: TEAM_IMAGE_URLS     // Ù†Ø­ÙØ¸ Ø§Ù„ØµÙˆØ± Ø£ÙŠØ¶Ø§Ù‹
                    };

                    // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„ÙØªØ­Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
                    let slots = JSON.parse(localStorage.getItem(SAVE_SLOTS_KEY)) || [null, null, null];
                    if (slots.length < 3) while(slots.length < 3) slots.push(null);
                    
                    slots[index] = saveData;
                    
                    localStorage.setItem(SAVE_SLOTS_KEY, JSON.stringify(slots));
                    
                    renderSaveSlots();
                    
                    Swal.fire({
                        icon: 'success',
                        title: 'ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­!',
                        timer: 1500,
                        showConfirmButton: false,
                        background: '#1e293b',
                        color: '#fff'
                    });
                }
            });
        }

        function loadFromSlot(index) {
            let slots = JSON.parse(localStorage.getItem(SAVE_SLOTS_KEY)) || [];
            const slot = slots[index];
            
            if (!slot) return;

            Swal.fire({
                title: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ',
                text: "Ø³ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø®Ø²Ø§Ø¦Ù† Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¨Ù…Ø­ØªÙˆÙ‰ Ù‡Ø°Ø§ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#10b981',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Ù†Ø¹Ù…ØŒ Ù‚Ù… Ø¨Ø§Ù„ØªØ­Ù…ÙŠÙ„!',
                cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡',
                background: '#1e293b',
                color: '#fff'
            }).then((result) => {
                if (result.isConfirmed) {
                    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                    if (slot.treasures) {
                        gameState.treasures = JSON.parse(JSON.stringify(slot.treasures));
                        // ØªØ­Ø¯ÙŠØ« Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø­Ø±Ø± Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø£ÙŠØ¶Ø§Ù‹
                        editorState.originalTreasures = JSON.parse(JSON.stringify(slot.treasures));
                    }
                    
                    if (slot.teamImages) {
                        TEAM_IMAGE_URLS = slot.teamImages;
                        // Ù†Ø­ØªØ§Ø¬ Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙˆØ± ÙÙŠ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙØªÙˆØ­Ø© Ø£Ùˆ Ø³ÙŠØªÙ… ÙØªØ­Ù‡Ø§
                    }

                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
                    createTreasureGrid(); // Ø´Ø¨ÙƒØ© Ø§Ù„Ù„Ø¹Ø¨
                    createEditorBoxGrid(); // Ø´Ø¨ÙƒØ© Ø§Ù„Ù…Ø­Ø±Ø±
                    saveGameState(); // Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙÙŠ Ø§Ù„Ù„Ø¹Ø¨Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©

                    document.getElementById('saveSlotsModal').classList.add('hidden');
                    
                    Swal.fire({
                        icon: 'success',
                        title: 'ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬!',
                        text: `ØªÙ… ØªÙØ¹ÙŠÙ„ Ù†Ù…ÙˆØ°Ø¬ "${slot.name}" Ø¨Ù†Ø¬Ø§Ø­`,
                        timer: 2000,
                        showConfirmButton: false,
                        background: '#1e293b',
                        color: '#fff'
                    });
                }
            });
        }

        // ** ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØºØ°ÙŠØ© Ø§Ù„Ø±Ø§Ø¬Ø¹Ø© Ù„Ù„Ù†Ù‚Ø§Ø· (Visual Feedback) **
        function updatePointsFeedback() {
            const input = document.getElementById('editPointsValue');
            const feedback = document.getElementById('pointsFeedback');
            const indicator = document.getElementById('pointsIconIndicator');
            const value = parseInt(input.value);

            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
            input.classList.remove('border-emerald-500', 'border-red-500', 'focus:border-emerald-500', 'focus:border-red-500', 'text-emerald-400', 'text-red-400');
            feedback.className = 'text-[10px] mt-1 font-bold min-h-[1.25rem] transition-colors flex items-center gap-1';
            indicator.textContent = '';

            if (isNaN(value) || value === 0 || input.value === '') {
                feedback.textContent = '';
                return;
            }

            if (value > 0) {
                // Ø­Ø§Ù„Ø© Ù…ÙˆØ¬Ø¨Ø© (Ù…ÙƒØ§ÙØ£Ø©)
                input.classList.add('border-emerald-500', 'text-emerald-400', 'focus:border-emerald-500');
                feedback.innerHTML = `<span class="text-lg leading-none">âœ…</span> <span class="text-emerald-400">Ø³ÙŠØ­ØµÙ„ Ø§Ù„ÙØ±ÙŠÙ‚ Ø¹Ù„Ù‰ ${value} Ù†Ù‚Ø·Ø©</span>`;
                indicator.textContent = 'â•';
                indicator.className = 'absolute left-2 top-1.5 text-xs text-emerald-500 font-bold';
            } else {
                // Ø­Ø§Ù„Ø© Ø³Ø§Ù„Ø¨Ø© (Ø®ØµÙ…)
                input.classList.add('border-red-500', 'text-red-400', 'focus:border-red-500');
                feedback.innerHTML = `<span class="text-lg leading-none">âš ï¸</span> <span class="text-red-400">Ø³ÙŠØªÙ… Ø®ØµÙ… ${Math.abs(value)} Ù†Ù‚Ø·Ø©</span>`;
                indicator.textContent = 'â–';
                indicator.className = 'absolute left-2 top-1.5 text-xs text-red-500 font-bold';
            }
        }

        // ** ØªØ¹ÙŠÙŠÙ† Ù‚ÙŠÙ…Ø© Ø§Ù„Ù†Ù‚Ø§Ø· Ø¨Ø³Ø±Ø¹Ø© **
        function setPointsValue(val) {
            const input = document.getElementById('editPointsValue');
            input.value = val;
            
            // ØªØºÙŠÙŠØ± Ù†ÙˆØ¹ Ø§Ù„Ù†Ù‚Ø§Ø· ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¥Ù„Ù‰ "Ø¹Ø¯Ø¯ Ù†Ù‚Ø§Ø· Ø«Ø§Ø¨Øª" Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† ÙƒØ°Ù„Ùƒ
            const typeSelect = document.getElementById('editPointsType');
            if(typeSelect.value !== 'fixed') {
                typeSelect.value = 'fixed';
            }
            
            updatePointsFeedback();
        }

        // ** Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø§Ù„ØªØ¹Ø¨ÙŠØ±ÙŠØ© **
        const EMOJI_LIST = [
            // Ù‚Ø±Ø§ØµÙ†Ø© ÙˆÙƒÙ†ÙˆØ²
            'ğŸ´â€â˜ ï¸', 'ğŸ’°', 'ğŸ’', 'ğŸ—ºï¸', 'ğŸ¦œ', 'âš“', 'ğŸ’£', 'âš”ï¸', 'ğŸ—ï¸', 'ğŸ“œ', 'ğŸ§­', 'ğŸ›¶', 'ğŸš¢', 'ğŸï¸', 'ğŸŒ‹',
            // Ù…ÙƒØ§ÙØ¢Øª ÙˆØ§Ø­ØªÙØ§Ù„
            'ğŸ‰', 'ğŸ', 'âœ¨', 'â­', 'ğŸ†', 'ğŸ‘‘', 'ğŸ…', 'ğŸ¯', 'ğŸˆ', 'ğŸ†', 'ğŸ¤©', 'ğŸ¤‘', 'ğŸ¤ ', 'ğŸ˜', 'ğŸ¤',
            // Ø¹Ù‚ÙˆØ¨Ø§Øª ÙˆØªØ­Ø¯ÙŠØ§Øª
            'âš¡', 'ğŸ’”', 'ğŸš«', 'ğŸ›‘', 'â˜ ï¸', 'ğŸ‘»', 'ğŸ¤¡', 'ğŸ¤–', 'ğŸ‘½', 'ğŸ‘¾', 'ğŸ§Ÿ', 'ğŸ§›', 'ğŸ§™', 'ğŸ¦¹', 'ğŸ‘®',
            'ğŸ¤', 'ğŸ¥¶', 'ğŸ¥µ', 'ğŸ¤¢', 'ğŸ¤®', 'ğŸ¤§', 'ğŸ¤•', 'ğŸ¤’', 'ğŸ˜·', 'ğŸ¤¬', 'ğŸ‘¿', 'ğŸ˜­', 'ğŸ˜±', 'ğŸ˜¨',
            // Ø£Ø¯ÙˆØ§Øª ÙˆØ£Ø´ÙŠØ§Ø¡
            'ğŸ”¨', 'ğŸª“', 'ğŸ”§', 'ğŸ”«', 'ğŸ›¡ï¸', 'ğŸš¬', 'âš°ï¸', 'ğŸ”®', 'ğŸ§¿', 'ğŸ’ˆ', 'ğŸ›ï¸', 'âŒ›', 'â°', 'ğŸ“¸', 'ğŸ“¹',
            'ğŸ“', 'ğŸ“±', 'ğŸ’»', 'ğŸ’¡', 'ğŸ”¦', 'ğŸ•¯ï¸', 'ğŸ’µ', 'ğŸ’³', 'ğŸ§¾', 'ğŸ“¦', 'ğŸ“«', 'âœï¸', 'âœ’ï¸', 'ğŸ“', 'ğŸ“',
            // Ø­ÙŠÙˆØ§Ù†Ø§Øª ÙˆØ·Ø¨ÙŠØ¹Ø©
            'ğŸ¦', 'ğŸ¯', 'ğŸ»', 'ğŸ¦ˆ', 'ğŸ™', 'ğŸ¦–', 'ğŸ‰', 'ğŸ', 'ğŸ¦‚', 'ğŸ•·ï¸', 'ğŸ•¸ï¸', 'ğŸŒ²', 'ğŸŒµ', 'ğŸŒªï¸', 'ğŸ”¥',
            'ğŸ’§', 'â„ï¸', 'ğŸŒ', 'ğŸ', 'ğŸ”', 'ğŸ•', 'ğŸ—', 'ğŸ–', 'ğŸ¥š', 'ğŸ¥›', 'â˜•', 'ğŸµ', 'ğŸ¶', 'ğŸ·', 'ğŸº'
        ];

        // ** ØªÙ‡ÙŠØ¦Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª **
        function initEmojiPicker() {
            const grid = document.getElementById('emojiGrid');
            if (!grid) return;
            grid.innerHTML = '';
            
            EMOJI_LIST.forEach(emoji => {
                const btn = document.createElement('button');
                btn.textContent = emoji;
                btn.className = 'text-2xl p-2 rounded hover:bg-slate-700 transition-colors focus:outline-none focus:bg-slate-600';
                btn.type = 'button';
                btn.onclick = () => selectEmoji(emoji);
                grid.appendChild(btn);
            });

            // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
            document.addEventListener('click', (e) => {
                const dropdown = document.getElementById('emojiPickerDropdown');
                const btn = document.getElementById('emojiPickerBtn');
                if (dropdown && !dropdown.classList.contains('hidden') && !dropdown.contains(e.target) && !btn.contains(e.target)) {
                    dropdown.classList.add('hidden');
                }
            });
        }

        // ** ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª **
        function toggleEmojiPicker() {
            const dropdown = document.getElementById('emojiPickerDropdown');
            dropdown.classList.toggle('hidden');
            
            // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙÙŠ Ø§Ù„Ù…Ø±Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù†Øª ÙØ§Ø±ØºØ©
            const grid = document.getElementById('emojiGrid');
            if (grid && grid.children.length === 0) {
                initEmojiPicker();
            }
        }

        // ** Ø§Ø®ØªÙŠØ§Ø± Ø£ÙŠÙ‚ÙˆÙ†Ø© **
        function selectEmoji(emoji) {
            document.getElementById('editIcon').value = emoji;
            document.getElementById('selectedEmojiDisplay').textContent = emoji;
            document.getElementById('emojiPickerDropdown').classList.add('hidden');
            updatePreviewCard(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© ÙÙˆØ±Ø§Ù‹
        }

        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
        document.addEventListener('DOMContentLoaded', initEmojiPicker);
    </script>
    <!-- Ù†Ø§ÙØ°Ø© ØºØ±ÙØ© Ø§Ù„ØªØ­ÙƒÙ… (Ø¬Ø¯ÙŠØ¯Ø©) -->
    <div id="controlPanelModal" class="modal-container hidden">
        <div class="modal-card bg-slate-900 border-slate-500">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-bold text-slate-300">ğŸ›ï¸ ØºØ±ÙØ© Ø§Ù„ØªØ­ÙƒÙ…</h2>
                <p class="text-slate-400 text-sm">Ø£Ø¯ÙˆØ§Øª Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© Ø§Ù„ÙŠØ¯ÙˆÙŠØ©</p>
            </div>

            <div class="space-y-4">
                <!-- Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø·Ø§Ù‚Ù… (ØªÙ…Øª Ø¥Ø²Ø§Ù„ØªÙ‡ Ù„Ø£Ù†Ù‡ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ Ù…Ø¨Ø§Ø´Ø±Ø©) -->
                <!-- 
                <div>
                    <label class="block text-slate-300 mb-2 text-sm">Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠ:</label>
                    <select id="currentTeam" class="w-full bg-slate-800 text-white px-4 py-2 rounded-lg border border-slate-600">
                    </select>
                </div>
                -->
                <input type="hidden" id="currentTeam"> <!-- Ù†Ø¨Ù‚ÙŠ Ø¹Ù„ÙŠÙ‡ Ù…Ø®ÙÙŠØ§Ù‹ Ù„ØªØ¬Ù†Ø¨ Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„ÙƒÙˆØ¯ -->

                <!-- Ø¥Ø¶Ø§ÙØ©/Ø®ØµÙ… Ù†Ù‚Ø§Ø· -->
                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-slate-800 p-3 rounded-lg border border-slate-700">
                        <label class="block text-emerald-400 text-xs mb-1">Ø¥Ø¶Ø§ÙØ© Ù†Ù‚Ø§Ø·</label>
                        <div class="flex gap-1">
                            <input type="number" id="addPointsInput" class="w-full bg-slate-900 border border-slate-600 rounded px-2 py-1 text-center" placeholder="0">
                            <button onclick="addPoints()" class="bg-emerald-600 hover:bg-emerald-500 px-2 rounded text-lg">+</button>
                        </div>
                    </div>
                    <div class="bg-slate-800 p-3 rounded-lg border border-slate-700">
                        <label class="block text-red-400 text-xs mb-1">Ø®ØµÙ… Ù†Ù‚Ø§Ø·</label>
                        <div class="flex gap-1">
                            <input type="number" id="subtractPointsInput" class="w-full bg-slate-900 border border-slate-600 rounded px-2 py-1 text-center" placeholder="0">
                            <button onclick="subtractPoints()" class="bg-red-600 hover:bg-red-500 px-2 rounded text-lg">-</button>
                        </div>
                    </div>
                </div>

                <!-- Ø¥Ø¹Ø§Ø¯Ø© ÙØªØ­ Ø®Ø²Ù†Ø© -->
                <div class="bg-slate-800 p-3 rounded-lg border border-slate-700">
                    <label class="block text-amber-400 text-xs mb-1">Ø¥Ø¹Ø§Ø¯Ø© ÙØªØ­ Ø®Ø²Ù†Ø© Ù…ØºÙ„Ù‚Ø©</label>
                    <div class="flex gap-2">
                        <select id="reopenBoxSelect" class="flex-1 bg-slate-900 text-white px-2 py-1 rounded border border-slate-600 text-sm">
                            <option value="">Ø§Ø®ØªØ± Ø®Ø²Ù†Ø©...</option>
                        </select>
                        <button onclick="reopenBox()" class="bg-amber-600 hover:bg-amber-500 px-3 rounded font-bold">ğŸ—ï¸</button>
                    </div>
                </div>
            </div>

            <div class="mt-6 pt-4 border-t border-slate-700 flex justify-center">
                <button onclick="toggleControlPanel(false)" class="bg-slate-600 hover:bg-slate-500 px-6 py-2 rounded-lg text-white font-semibold">
                    Ø¥ØºÙ„Ø§Ù‚
                </button>
            </div>
        </div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙØ±ÙŠÙ‚ (Ø³ÙŠØ§Ù‚ÙŠØ©) -->
    <div id="teamManagementModal" class="modal-container hidden">
        <div class="modal-card bg-slate-900 border-2 border-slate-500 max-w-sm">
            <div class="text-center mb-4 relative">
                <button onclick="closeTeamManagementModal()" class="absolute -top-2 -right-2 text-slate-400 hover:text-white text-xl">&times;</button>
                <h2 class="text-xl font-bold text-amber-300 flex items-center justify-center gap-2">
                    <span id="manageTeamIcon" class="text-2xl"></span>
                    Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙØ±ÙŠÙ‚
                </h2>
            </div>

            <div class="space-y-4">
                <!-- ØµÙˆØ±Ø© Ø§Ù„ÙØ±ÙŠÙ‚ -->
                <div class="flex justify-center mb-4">
                    <div class="relative group w-24 h-24">
                        <img id="manageTeamPreviewImg" src="" class="w-full h-full rounded-full object-contain border-4 border-slate-700 bg-slate-800 group-hover:border-amber-400 transition-colors shadow-xl">
                        <div class="absolute inset-0 bg-black/50 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity cursor-pointer" onclick="document.getElementById('uploadManageImg').click()">
                            <span class="text-white font-bold text-sm text-center leading-tight">ØªØºÙŠÙŠØ±<br>Ø§Ù„ØµÙˆØ±Ø©</span>
                        </div>
                        <input type="file" id="uploadManageImg" class="hidden" accept="image/*" onchange="handleTeamImageUpload(-1, this, 'manage')">
                    </div>
                </div>

                <!-- ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù… -->
                <div>
                    <label class="block text-slate-400 text-xs mb-1">Ø§Ø³Ù… Ø§Ù„ÙØ±ÙŠÙ‚</label>
                    <input type="text" id="manageTeamName" class="w-full bg-slate-800 text-white px-3 py-2 rounded border border-slate-600 focus:border-amber-400 focus:outline-none transition-colors text-center font-bold">
                </div>

                <!-- Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ù†Ù‚Ø§Ø· -->
                <div>
                    <label class="block text-slate-400 text-xs mb-1">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù†Ù‚Ø§Ø· (Ø§Ù„Ø­Ø§Ù„ÙŠØ©: <span id="manageTeamCurrentScore" class="text-amber-400 font-bold">0</span>)</label>
                    
                    <!-- Ø£Ø²Ø±Ø§Ø± Ø³Ø±ÙŠØ¹Ø© -->
                    <div class="grid grid-cols-4 gap-2 mb-2">
                        <button onclick="quickUpdateScore(10)" class="bg-emerald-600/20 hover:bg-emerald-600 text-emerald-400 hover:text-white border border-emerald-600/50 rounded py-1 transition-all">+10</button>
                        <button onclick="quickUpdateScore(50)" class="bg-emerald-600/20 hover:bg-emerald-600 text-emerald-400 hover:text-white border border-emerald-600/50 rounded py-1 transition-all">+50</button>
                        <button onclick="quickUpdateScore(-10)" class="bg-red-600/20 hover:bg-red-600 text-red-400 hover:text-white border border-red-600/50 rounded py-1 transition-all">-10</button>
                        <button onclick="quickUpdateScore(-50)" class="bg-red-600/20 hover:bg-red-600 text-red-400 hover:text-white border border-red-600/50 rounded py-1 transition-all">-50</button>
                    </div>

                    <!-- Ø¥Ø¯Ø®Ø§Ù„ ÙŠØ¯ÙˆÙŠ -->
                    <div class="flex gap-2">
                        <input type="number" id="manageTeamScoreInput" class="flex-1 bg-slate-800 text-white px-3 py-2 rounded border border-slate-600 text-center" placeholder="Ø¥Ø¯Ø®Ø§Ù„ ÙŠØ¯ÙˆÙŠ (+/-)">
                        <button onclick="applyManualScore()" class="bg-blue-600 hover:bg-blue-500 px-4 rounded text-white font-bold">ØªØ·Ø¨ÙŠÙ‚</button>
                    </div>
                </div>

                <div class="border-t border-slate-700 my-4"></div>

                <!-- Ø£Ø²Ø±Ø§Ø± Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø®Ø·ÙŠØ±Ø© -->
                <button onclick="resetTeamScore()" class="w-full bg-slate-800 hover:bg-red-900/30 text-red-400 hover:text-red-200 border border-slate-700 hover:border-red-500/50 py-2 rounded transition-all text-sm flex items-center justify-center gap-2">
                    <span>ğŸ”„</span> Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ù†Ù‚Ø§Ø· Ù‡Ø°Ø§ Ø§Ù„ÙØ±ÙŠÙ‚ ÙÙ‚Ø· (50)
                </button>

                <!-- Ø²Ø± Ø§Ù„Ø­ÙØ¸ -->
                <button onclick="saveTeamManagement()" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white py-3 rounded-lg font-bold shadow-lg shadow-emerald-900/20 transition-all mt-2">
                    ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</body>
</html>
